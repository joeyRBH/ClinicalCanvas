// Client portal document functions
function showClientDocuments() {
    const clientDocs = assignedDocs.filter(doc => 
        doc.clientId === parseInt(localStorage.getItem('userId'))
    );
    
    const container = document.getElementById('clientDocumentsContainer');
    
    if (clientDocs.length === 0) {
        container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 40px;">No documents assigned</p>';
        return;
    }
    
    container.innerHTML = clientDocs.map(doc => `
        <div class="card" style="margin-bottom: 15px;">
            <h3 style="margin-bottom: 10px; color: #1f2937;">${doc.docName}</h3>
            <p style="color: #6b7280; margin-bottom: 15px;">Assigned: ${new Date(doc.assignedDate).toLocaleDateString()}</p>
            <span class="badge badge-${doc.status === 'completed' ? 'success' : 'warning'}" style="margin-bottom: 15px; display: inline-block;">${doc.status}</span>
            ${doc.status === 'pending' ? `
                <button class="btn btn-primary" onclick="openDocumentForm(${doc.id}, ${doc.docId})">Complete Document</button>
            ` : `
                <button class="btn" onclick="viewCompletedDocument(${doc.id})">View Completed</button>
            `}
        </div>
    `).join('');
}

function openDocumentForm(assignedDocId, templateId) {
    const template = documentTemplates.find(t => t.id === templateId);
    const modal = document.getElementById('documentFormModal');
    
    document.getElementById('documentFormTitle').textContent = template.name;
    
    const fieldsHtml = template.fields.map(field => {
        if (field.type === 'text') {
            return `
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">${field.label}</label>
                    <input type="text" id="field_${field.id}" class="input" required>
                </div>
            `;
        } else if (field.type === 'textarea') {
            return `
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">${field.label}</label>
                    <textarea id="field_${field.id}" class="input" rows="4" required></textarea>
                </div>
            `;
        } else if (field.type === 'checkbox') {
            return `
                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="field_${field.id}" required style="margin-right: 8px;">
                        <span style="color: #374151;">${field.label}</span>
                    </label>
                </div>
            `;
        } else if (field.type === 'date') {
            return `
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">${field.label}</label>
                    <input type="date" id="field_${field.id}" class="input" required>
                </div>
            `;
        }
    }).join('');
    
    document.getElementById('documentFormFields').innerHTML = fieldsHtml;
    document.getElementById('documentFormSubmit').onclick = () => submitDocument(assignedDocId, template);
    
    // Clear signature canvas
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    modal.classList.add('active');
}

function closeDocumentForm() {
    document.getElementById('documentFormModal').classList.remove('active');
}

let isDrawing = false;
let lastX = 0;
let lastY = 0;

function initSignatureCanvas() {
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    
    canvas.addEventListener('mousedown', (e) => {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        lastX = e.clientX - rect.left;
        lastY = e.clientY - rect.top;
    });
    
    canvas.addEventListener('mousemove', (e) => {
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        lastX = x;
        lastY = y;
    });
    
    canvas.addEventListener('mouseup', () => {
        isDrawing = false;
    });
    
    canvas.addEventListener('mouseleave', () => {
        isDrawing = false;
    });
    
    // Touch support
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        lastX = touch.clientX - rect.left;
        lastY = touch.clientY - rect.top;
    });
    
    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        lastX = x;
        lastY = y;
    });
    
    canvas.addEventListener('touchend', () => {
        isDrawing = false;
    });
}

function clearSignature() {
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

function submitDocument(assignedDocId, template) {
    // Collect form data
    const formData = {};
    template.fields.forEach(field => {
        const element = document.getElementById(`field_${field.id}`);
        if (field.type === 'checkbox') {
            formData[field.id] = element.checked;
        } else {
            formData[field.id] = element.value;
        }
        
        if (!element.value && field.type !== 'checkbox') {
            alert(`Please complete all fields`);
            return;
        }
    });
    
    // Get signature
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const pixels = imageData.data;
    let hasSignature = false;
    
    for (let i = 0; i < pixels.length; i += 4) {
        if (pixels[i + 3] > 0) {
            hasSignature = true;
            break;
        }
    }
    
    if (!hasSignature) {
        alert('Please provide your signature');
        return;
    }
    
    const signatureData = canvas.toDataURL();
    
    // Update assigned doc
    const docIndex = assignedDocs.findIndex(d => d.id === assignedDocId);
    assignedDocs[docIndex].status = 'completed';
    assignedDocs[docIndex].completedDate = new Date().toISOString();
    assignedDocs[docIndex].formData = formData;
    assignedDocs[docIndex].signature = signatureData;
    
    localStorage.setItem('assignedDocs', JSON.stringify(assignedDocs));
    
    closeDocumentForm();
    showClientDocuments();
    alert('Document submitted successfully!');
}

function viewCompletedDocument(assignedDocId) {
    const doc = assignedDocs.find(d => d.id === assignedDocId);
    const template = documentTemplates.find(t => t.id === doc.docId);
    
    const modal = document.getElementById('viewDocModal');
    document.getElementById('viewDocTitle').textContent = template.name;
    
    const fieldsHtml = template.fields.map(field => {
        const value = doc.formData[field.id];
        return `
            <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e5e7eb;">
                <strong style="display: block; margin-bottom: 5px; color: #374151;">${field.label}</strong>
                <p style="color: #6b7280;">${field.type === 'checkbox' ? (value ? 'Yes' : 'No') : value}</p>
            </div>
        `;
    }).join('');
    
    document.getElementById('viewDocContent').innerHTML = `
        ${fieldsHtml}
        <div style="margin-top: 30px;">
            <strong style="display: block; margin-bottom: 10px; color: #374151;">Signature:</strong>
            <img src="${doc.signature}" style="border: 1px solid #e5e7eb; max-width: 100%;">
        </div>
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
            <p style="color: #6b7280; font-size: 14px;">Completed: ${new Date(doc.completedDate).toLocaleString()}</p>
        </div>
    `;
    
    modal.classList.add('active');
}

function closeViewDocModal() {
    document.getElementById('viewDocModal').classList.remove('active');
}

if (authToken) {
    showApp();
    if (userRole === 'client') {
        initSignatureCanvas();
    }
} else {
    showAuth();
}
