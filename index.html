import React, { useState, useEffect } from 'react';

// Initial state structure
const initialState = {
  currentView: 'provider',
  currentTab: 'clients',
  selectedClientId: null,
  clients: [],
  appointments: [],
  clinicalNotes: [],
  billingRecords: [],
  auditLog: [],
  assignedDocuments: [],
  currentUser: { role: 'provider', email: 'provider@clinic.com' }
};

// CPT codes for billing
const cptCodes = [
  '90791 - Psychiatric Diagnostic Evaluation',
  '90832 - Psychotherapy 30 min',
  '90834 - Psychotherapy 45 min',
  '90837 - Psychotherapy 60 min',
  '90846 - Family Psychotherapy (without patient)',
  '90847 - Family Psychotherapy (with patient)',
  '90853 - Group Psychotherapy'
];

// Common ICD-10 codes for mental health diagnoses
const icd10Codes = [
  // Anxiety Disorders (F40-F48)
  'F41.0 - Panic Disorder',
  'F41.1 - Generalized Anxiety Disorder',
  'F41.9 - Anxiety Disorder, Unspecified',
  'F40.10 - Social Anxiety Disorder (Social Phobia)',
  'F40.00 - Agoraphobia',
  'F42.2 - Mixed Obsessional Thoughts and Acts (OCD)',
  'F43.10 - Post-Traumatic Stress Disorder, Unspecified',
  'F43.11 - Post-Traumatic Stress Disorder, Acute',
  'F43.12 - Post-Traumatic Stress Disorder, Chronic',
  
  // Depressive Disorders (F32-F33)
  'F32.0 - Major Depressive Disorder, Single Episode, Mild',
  'F32.1 - Major Depressive Disorder, Single Episode, Moderate',
  'F32.2 - Major Depressive Disorder, Single Episode, Severe',
  'F32.9 - Major Depressive Disorder, Single Episode, Unspecified',
  'F33.0 - Major Depressive Disorder, Recurrent, Mild',
  'F33.1 - Major Depressive Disorder, Recurrent, Moderate',
  'F33.2 - Major Depressive Disorder, Recurrent, Severe',
  'F33.9 - Major Depressive Disorder, Recurrent, Unspecified',
  'F34.1 - Persistent Depressive Disorder (Dysthymia)',
  
  // Bipolar Disorders (F31)
  'F31.0 - Bipolar Disorder, Current Episode Hypomanic',
  'F31.10 - Bipolar Disorder, Current Episode Manic, Unspecified',
  'F31.30 - Bipolar Disorder, Current Episode Depressed, Mild',
  'F31.4 - Bipolar Disorder, Current Episode Depressed, Moderate',
  'F31.5 - Bipolar Disorder, Current Episode Depressed, Severe',
  'F31.9 - Bipolar Disorder, Unspecified',
  
  // Trauma and Stressor-Related Disorders (F43)
  'F43.0 - Acute Stress Reaction',
  'F43.20 - Adjustment Disorder, Unspecified',
  'F43.21 - Adjustment Disorder with Depressed Mood',
  'F43.22 - Adjustment Disorder with Anxiety',
  'F43.23 - Adjustment Disorder with Mixed Anxiety and Depressed Mood',
  'F43.24 - Adjustment Disorder with Disturbance of Conduct',
  
  // Substance-Related Disorders (F10-F19)
  'F10.10 - Alcohol Use Disorder, Mild',
  'F10.20 - Alcohol Use Disorder, Moderate to Severe',
  'F11.10 - Opioid Use Disorder, Mild',
  'F11.20 - Opioid Use Disorder, Moderate to Severe',
  'F12.10 - Cannabis Use Disorder, Mild',
  'F12.20 - Cannabis Use Disorder, Moderate to Severe',
  'F14.10 - Cocaine Use Disorder, Mild',
  'F14.20 - Cocaine Use Disorder, Moderate to Severe',
  'F15.10 - Stimulant Use Disorder, Mild',
  'F15.20 - Stimulant Use Disorder, Moderate to Severe',
  
  // Personality Disorders (F60)
  'F60.0 - Paranoid Personality Disorder',
  'F60.1 - Schizoid Personality Disorder',
  'F60.2 - Antisocial Personality Disorder',
  'F60.3 - Borderline Personality Disorder',
  'F60.4 - Histrionic Personality Disorder',
  'F60.5 - Obsessive-Compulsive Personality Disorder',
  'F60.6 - Avoidant Personality Disorder',
  'F60.7 - Dependent Personality Disorder',
  
  // Eating Disorders (F50)
  'F50.01 - Anorexia Nervosa, Restricting Type',
  'F50.02 - Anorexia Nervosa, Binge-Eating/Purging Type',
  'F50.2 - Bulimia Nervosa',
  'F50.81 - Binge-Eating Disorder',
  'F50.9 - Eating Disorder, Unspecified',
  
  // Sleep-Wake Disorders (F51, G47)
  'F51.01 - Primary Insomnia',
  'F51.11 - Primary Hypersomnia',
  'G47.33 - Obstructive Sleep Apnea',
  
  // Neurodevelopmental Disorders
  'F90.0 - Attention-Deficit/Hyperactivity Disorder, Predominantly Inattentive Type',
  'F90.1 - Attention-Deficit/Hyperactivity Disorder, Predominantly Hyperactive Type',
  'F90.2 - Attention-Deficit/Hyperactivity Disorder, Combined Type',
  'F84.0 - Autism Spectrum Disorder',
  
  // Other Common Mental Health Conditions
  'F43.25 - Adjustment Disorder with Mixed Disturbance of Emotions and Conduct',
  'F48.1 - Depersonalization-Derealization Disorder',
  'F60.81 - Narcissistic Personality Disorder',
  'F34.0 - Cyclothymic Disorder',
  'F45.1 - Somatic Symptom Disorder',
  'Z63.0 - Relationship Distress with Spouse or Intimate Partner',
  'Z71.9 - Counseling, Unspecified'
];

// Document templates - comprehensive clinical forms
const documentTemplates = [
  {
    id: 'asrs',
    name: 'Adult ADHD Self-Report Scale (ASRS-v1.1)',
    description: 'ADHD symptom checklist for adults',
    fields: [
      { id: 'intro', label: 'Please answer the questions below, rating yourself on each of the criteria listed. As you answer each question, select the option that best describes how you have felt and conducted yourself over the past 6 months.', type: 'info' },
      { id: 'partA', label: 'Part A', type: 'section' },
      { id: 'q1', label: '1. How often do you have trouble wrapping up the final details of a project, once the challenging parts have been done?', type: 'radio', options: ['Never (0)', 'Rarely (0)', 'Sometimes (1)', 'Often (1)', 'Very Often (1)'], required: true },
      { id: 'q2', label: '2. How often do you have difficulty getting things in order when you have to do a task that requires organization?', type: 'radio', options: ['Never (0)', 'Rarely (0)', 'Sometimes (1)', 'Often (1)', 'Very Often (1)'], required: true },
      { id: 'q3', label: '3. How often do you have problems remembering appointments or obligations?', type: 'radio', options: ['Never (0)', 'Rarely (0)', 'Sometimes (1)', 'Often (1)', 'Very Often (1)'], required: true },
      { id: 'q4', label: '4. When you have a task that requires a lot of thought, how often do you avoid or delay getting started?', type: 'radio', options: ['Never (0)', 'Rarely (0)', 'Sometimes (0)', 'Often (1)', 'Very Often (1)'], required: true },
      { id: 'q5', label: '5. How often do you fidget or squirm with your hands or feet when you have to sit down for a long time?', type: 'radio', options: ['Never (0)', 'Rarely (0)', 'Sometimes (0)', 'Often (1)', 'Very Often (1)'], required: true },
      { id: 'q6', label: '6. How often do you feel overly active and compelled to do things, like you were driven by a motor?', type: 'radio', options: ['Never (0)', 'Rarely (0)', 'Sometimes (0)', 'Often (1)', 'Very Often (1)'], required: true },
      { id: 'partAScore', label: 'Part A Total Score', type: 'number', required: true }
    ]
  },
  {
    id: 'individual_intake',
    name: 'Individual Intake Questionnaire',
    description: 'Comprehensive individual therapy intake',
    fields: [
      { id: 'referralSource', label: 'How did you find me as your therapist?', type: 'textarea', required: true },
      { id: 'presentingProblem', label: 'What is the reason you are coming in for counseling?', type: 'textarea', required: true },
      { id: 'goals', label: 'What are your goals for our work together?', type: 'textarea', required: true },
      { id: 'signature', label: 'Signature', type: 'signature', required: true }
    ]
  }
];

export default function ClinicalCanvas() {
  const [state, setState] = useState(() => {
    const saved = localStorage.getItem('clinicalCanvasState');
    return saved ? JSON.parse(saved) : initialState;
  });

  useEffect(() => {
    localStorage.setItem('clinicalCanvasState', JSON.stringify(state));
  }, [state]);

  const addAuditLog = (action, details) => {
    const entry = {
      id: Date.now().toString(),
      timestamp: new Date().toISOString(),
      user: state.currentUser.email,
      action,
      details
    };
    setState(prev => ({
      ...prev,
      auditLog: [entry, ...prev.auditLog]
    }));
  };

  const switchView = (view) => {
    setState(prev => ({ ...prev, currentView: view }));
    addAuditLog('VIEW_SWITCH', `Switched to ${view} view`);
  };

  const setTab = (tab) => {
    setState(prev => ({ ...prev, currentTab: tab }));
  };

  const addClient = () => {
    const name = prompt('Enter client name:');
    if (!name) return;
    
    const email = prompt('Enter client email:');
    if (!email) return;

    const client = {
      id: Date.now().toString(),
      name,
      email,
      phone: '',
      dateOfBirth: '',
      createdAt: new Date().toISOString()
    };

    setState(prev => ({ ...prev, clients: [...prev.clients, client] }));
    addAuditLog('CLIENT_ADDED', `Added client: ${name}`);
  };

  return (
    <div className="min-h-screen bg-gray-100">
      {/* Header */}
      <div className="bg-blue-600 text-white p-4 shadow-lg">
        <div className="max-w-7xl mx-auto flex justify-between items-center">
          <h1 className="text-2xl font-bold">NEW ClinicalCanvas EHR</h1>
          <div className="flex gap-4">
            <button
              onClick={() => switchView(state.currentView === 'provider' ? 'client' : 'provider')}
              className="bg-white text-blue-600 px-4 py-2 rounded hover:bg-gray-100"
            >
              {state.currentView === 'provider' ? 'Switch to Client View' : 'Switch to Provider View'}
            </button>
          </div>
        </div>
      </div>

      {/* Main Content */}
      <div className="max-w-7xl mx-auto p-4">
        {state.currentView === 'provider' ? (
          <div>
            {/* Provider Navigation */}
            <div className="bg-white rounded-lg shadow mb-4 p-4">
              <div className="flex gap-2 flex-wrap">
                {['clients', 'appointments', 'notes', 'documents', 'billing', 'audit'].map(tab => (
                  <button
                    key={tab}
                    onClick={() => setTab(tab)}
                    className={`px-4 py-2 rounded ${
                      state.currentTab === tab
                        ? 'bg-blue-600 text-white'
                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                  >
                    {tab.charAt(0).toUpperCase() + tab.slice(1)}
                  </button>
                ))}
              </div>
            </div>

            {/* Content Area */}
            <div className="bg-white rounded-lg shadow p-6">
              {state.currentTab === 'clients' && (
                <div>
                  <div className="flex justify-between items-center mb-6">
                    <h2 className="text-2xl font-bold">Clients</h2>
                    <button
                      onClick={addClient}
                      className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                    >
                      Add Client
                    </button>
                  </div>
                  
                  {state.clients.length === 0 ? (
                    <p className="text-gray-500">No clients yet. Click "Add Client" to get started.</p>
                  ) : (
                    <div className="space-y-2">
                      {state.clients.map(client => (
                        <div
                          key={client.id}
                          className="p-4 border rounded hover:bg-gray-50 cursor-pointer"
                          onClick={() => setState(prev => ({ ...prev, selectedClientId: client.id }))}
                        >
                          <div className="font-semibold">{client.name}</div>
                          <div className="text-sm text-gray-600">{client.email}</div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}

              {state.currentTab === 'documents' && (
                <div>
                  <h2 className="text-2xl font-bold mb-6">Clinical Documents</h2>
                  <p className="text-gray-600 mb-4">Document templates available:</p>
                  <div className="space-y-3">
                    {documentTemplates.map(template => (
                      <div key={template.id} className="p-4 border rounded">
                        <div className="font-semibold">{template.name}</div>
                        <div className="text-sm text-gray-600">{template.description}</div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {state.currentTab !== 'clients' && state.currentTab !== 'documents' && (
                <div className="text-center py-12">
                  <h3 className="text-xl font-semibold text-gray-700">
                    {state.currentTab.charAt(0).toUpperCase() + state.currentTab.slice(1)} Module
                  </h3>
                  <p className="text-gray-500 mt-2">This module is fully functional in the complete application.</p>
                </div>
              )}
            </div>
          </div>
        ) : (
          <div className="text-center py-12 bg-white rounded-lg shadow">
            <h2 className="text-2xl font-bold mb-4">Client Portal</h2>
            <p className="text-gray-600">Client view is available in the full application.</p>
          </div>
        )}
      </div>
    </div>
  );
}
