function submitDocument(assignedDocId, template) {
    // Collect form data
    const formData = {};
    let isValid = true;
    
    template.fields.forEach(field => {
        // Skip info and section fields
        if (field.type === 'info' || field.type === 'section') {
            return;
        }
        
        // Handle signature fields
        if (field.type === 'signature') {
            const canvas = document.getElementById('signatureCanvas');
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const hasSignature = imageData.data.some(channel => channel !== 0);
            
            if (!hasSignature && field.required) {
                isValid = false;
                alert('Please provide your signature');
                return;
            }
            formData[field.id] = hasSignature ? canvas.toDataURL() : '';
            return;
        }
        
        // Handle radio button groups
        if (field.type === 'radio' && field.options) {
            const selected = document.querySelector(`input[name="field_${field.id}"]:checked`);
            if (!selected && field.required) {
                isValid = false;
            }
            formData[field.id] = selected ? selected.value : '';
            return;
        }
        
        // Handle checkbox groups
        if (field.type === 'checkbox' && field.options) {
            const checkboxes = field.options.map((option, idx) => {
                const cb = document.getElementById(`field_${field.id}_${idx}`);
                return cb && cb.checked ? option : null;
            }).filter(v => v !== null);
            formData[field.id] = checkboxes;
            return;
        }
        
        // Handle single checkbox
        if (field.type === 'checkbox' && !field.options) {
            const element = document.getElementById(`field_${field.id}`);
            formData[field.id] = element.checked;
            if (!element.checked && field.required) isValid = false;
            return;
        }
        
        // Handle all other input types (text, textarea, date, number)
        const element = document.getElementById(`field_${field.id}`);
        if (element) {
            formData[field.id] = element.value.trim();
            if (field.required && !formData[field.id]) {
                isValid = false;
            }
        }
    });
    
    if (!isValid) {
        alert('Please complete all required fields');
        return;
    }
    
    // Find and update the assigned document
    const assignedDoc = state.assignedDocuments.find(d => d.id === assignedDocId);
    if (assignedDoc) {
        assignedDoc.status = 'Completed';
        assignedDoc.completedDate = new Date().toISOString();
        assignedDoc.responses = formData;
        saveState();
        showClientDocuments();
        alert('Document submitted successfully!');
    }
}
