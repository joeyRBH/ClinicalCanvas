<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClinicalCanvas EHR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        @media (max-width: 768px) {
            .header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 10px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .content {
                padding: 20px;
            }
            
            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab-btn {
                white-space: nowrap;
                padding: 10px 16px;
                font-size: 13px;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
                margin: 10px;
            }
            
            .table {
                font-size: 12px;
            }

            .calendar-grid {
                font-size: 11px;
            }

            .calendar-day {
                min-height: 80px;
                padding: 5px;
            }
        }

        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .auth-container h2 {
            margin-bottom: 30px;
            color: #2c3e50;
            text-align: center;
        }

        .app-container {
            display: none;
            min-height: 100vh;
        }

        .header {
            background: white;
            padding: 20px 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .tabs {
            background: white;
            display: flex;
            padding: 0 40px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            overflow-x: auto;
        }

        .tab-btn {
            padding: 15px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            color: #667eea;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .content {
            padding: 40px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .content-header h2 {
            color: white;
            font-size: 28px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            background: white;
            color: #667eea;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .input:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea.input {
            min-height: 100px;
            resize: vertical;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .client-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
        }

        .client-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .client-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .client-card p {
            color: #666;
            font-size: 14px;
            margin: 5px 0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .table {
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e5e5;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .calendar-header h3 {
            margin: 0;
            color: #2c3e50;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #ddd;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-day-header {
            background: #667eea;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }

        .calendar-day {
            background: white;
            min-height: 100px;
            padding: 8px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }

        .calendar-day:hover {
            background: #f8f9fa;
        }

        .calendar-day.other-month {
            background: #f5f5f5;
            color: #999;
        }

        .calendar-day.today {
            background: #fff3cd;
        }

        .calendar-day-number {
            font-weight: 600;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .calendar-appointment {
            background: #667eea;
            color: white;
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 11px;
            margin-bottom: 2px;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .calendar-appointment:hover {
            background: #5568d3;
        }

        .payment-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .payment-form {
            max-width: 500px;
        }

        .payment-amount {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 20px;
        }

        .payment-methods {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .payment-method {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .payment-method.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .payment-method:hover {
            border-color: #667eea;
        }

        .chart-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e5e5;
        }

        .chart-tab-btn {
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .chart-tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .chart-section {
            display: none;
        }

        .chart-section.active {
            display: block;
        }

        .ai-note-section {
            background: #f0f4ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .ai-note-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .client-portal-card {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .client-portal-card h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="auth-container" id="authContainer">
        <h2>ClinicalCanvas Login</h2>
        <input type="text" id="username" placeholder="Username" class="input">
        <input type="password" id="password" placeholder="Password" class="input">
        <button onclick="login()" class="btn btn-primary">Login</button>
        <p style="margin-top: 20px; font-size: 12px; color: #666;">Demo: admin/admin123 or client/client123</p>
    </div>

    <div class="app-container" id="appContainer">
        <div class="header">
            <h1>üè• ClinicalCanvas EHR</h1>
            <div class="user-info">
                <span id="userName"></span>
                <button onclick="logout()" class="btn">Logout</button>
            </div>
        </div>

        <div class="tabs" id="mainTabs">
            <button class="tab-btn active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="tab-btn" onclick="showTab('clients')">Clients</button>
            <button class="tab-btn" onclick="showTab('calendar')">Calendar</button>
            <button class="tab-btn" onclick="showTab('billing')">Billing</button>
            <button class="tab-btn" onclick="showTab('documents')">Documents</button>
            <button class="tab-btn" onclick="showTab('audit')">Audit Log</button>
        </div>

        <div class="content">
            <!-- Dashboard / Client Portal -->
            <div id="dashboardContent" class="tab-content" style="display: block;">
                <div class="content-header">
                    <h2 id="dashboardTitle">Dashboard</h2>
                </div>
                <div id="dashboardContainer"></div>
            </div>

            <!-- Clients -->
            <div id="clientsContent" class="tab-content">
                <div class="content-header">
                    <h2>Client Management</h2>
                    <button onclick="openNewClient()" class="btn btn-primary">+ New Client</button>
                </div>
                <div id="clientsList" class="grid"></div>
            </div>

            <!-- Calendar -->
            <div id="calendarContent" class="tab-content">
                <div class="content-header">
                    <h2>Calendar</h2>
                    <button onclick="openNewAppointment()" class="btn btn-primary">+ New Appointment</button>
                </div>
                
                <div class="calendar-header">
                    <button onclick="previousMonth()" class="btn">‚Üê Previous</button>
                    <h3 id="currentMonthYear"></h3>
                    <button onclick="nextMonth()" class="btn">Next ‚Üí</button>
                </div>
                
                <div class="calendar-grid" id="calendarGrid"></div>
                
                <div style="margin-top: 30px;">
                    <h3 style="color: white; margin-bottom: 20px;">All Appointments</h3>
                    <div id="appointmentsList"></div>
                </div>
            </div>

            <!-- Billing -->
            <div id="billingContent" class="tab-content">
                <div class="content-header">
                    <h2>Billing & Invoices</h2>
                </div>
                <div id="billingList"></div>
            </div>

            <!-- Documents -->
            <div id="documentsContent" class="tab-content">
                <div class="content-header">
                    <h2>Clinical Documents</h2>
                    <button onclick="openAssignDoc()" class="btn btn-primary" id="assignDocBtn">+ Assign Document</button>
                </div>
                <div id="assignedDocsList"></div>
            </div>

            <!-- Audit Log -->
            <div id="auditContent" class="tab-content">
                <div class="content-header">
                    <h2>HIPAA Audit Log</h2>
                </div>
                <div id="auditLogList"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- New Client Modal -->
    <div id="newClientModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeNewClient()">&times;</span>
            <h2>New Client</h2>
            <input type="text" id="clientName" placeholder="Full Name" class="input">
            <input type="email" id="clientEmail" placeholder="Email" class="input">
            <input type="tel" id="clientPhone" placeholder="Phone" class="input">
            <input type="date" id="clientDOB" placeholder="Date of Birth" class="input">
            <textarea id="clientNotes" placeholder="Initial Notes" class="input"></textarea>
            <button onclick="saveNewClient()" class="btn btn-primary">Save Client</button>
        </div>
    </div>

    <!-- Client Chart Modal -->
    <div id="clientChartModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <span class="close" onclick="closeClientChart()">&times;</span>
            <h2 id="chartClientName"></h2>
            
            <div class="chart-tabs">
                <button class="chart-tab-btn active" onclick="showChartTab('info')">Info</button>
                <button class="chart-tab-btn" onclick="showChartTab('appointments')">Appointments</button>
                <button class="chart-tab-btn" onclick="showChartTab('notes')">Clinical Notes</button>
                <button class="chart-tab-btn" onclick="showChartTab('diagnosis')">Diagnosis</button>
            </div>

            <div id="chartInfo" class="chart-section active">
                <div class="card">
                    <h3>Client Information</h3>
                    <p><strong>Email:</strong> <span id="chartEmail"></span></p>
                    <p><strong>Phone:</strong> <span id="chartPhone"></span></p>
                    <p><strong>Date of Birth:</strong> <span id="chartDOB"></span></p>
                    <p><strong>Notes:</strong> <span id="chartNotes"></span></p>
                </div>
            </div>

            <div id="chartAppointments" class="chart-section">
                <button onclick="openNewAppointmentForClient()" class="btn btn-primary" style="margin-bottom: 20px;">+ New Appointment</button>
                <div id="clientAppointmentsList"></div>
            </div>

            <div id="chartNotes" class="chart-section">
                <div id="clientNotesList"></div>
            </div>

            <div id="chartDiagnosis" class="chart-section">
                <button onclick="openAddDiagnosis()" class="btn btn-primary" style="margin-bottom: 20px;">+ Add Diagnosis</button>
                <div id="clientDiagnosisList"></div>
            </div>
        </div>
    </div>

    <!-- New/Edit Appointment Modal -->
    <div id="newAppointmentModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeNewAppointment()">&times;</span>
            <h2 id="appointmentModalTitle">New Appointment</h2>
            
            <input type="hidden" id="editAppointmentId">
            
            <select id="appointmentClient" class="input">
                <option value="">Select Client</option>
            </select>
            <input type="date" id="appointmentDate" class="input">
            <input type="time" id="appointmentTime" class="input">
            <select id="appointmentType" class="input">
                <option value="">Select Type</option>
                <option value="90791">90791 - Psychiatric Diagnostic Evaluation</option>
                <option value="90834">90834 - Psychotherapy 45 min</option>
                <option value="90837">90837 - Psychotherapy 60 min</option>
                <option value="90847">90847 - Family Psychotherapy</option>
                <option value="90853">90853 - Group Psychotherapy</option>
            </select>
            <input type="number" id="appointmentDuration" placeholder="Duration (minutes)" class="input" value="60">
            
            <!-- AI Note Taker Section -->
            <div class="ai-note-section">
                <h3>üéôÔ∏è Session Recording & AI Note Generator</h3>
                <p style="font-size: 14px; color: #666; margin-bottom: 15px;">Record your entire therapy session here. The AI will help generate a professional DAP note.</p>
                
                <textarea id="sessionRecording" placeholder="Paste or type the full session transcript/recording here...

Example: Client arrived on time and appeared anxious. We discussed their work stress and relationship concerns. Client reported improved sleep after trying the relaxation techniques. We practiced cognitive reframing around their negative self-talk..." 
                    class="input" style="min-height: 200px;"></textarea>
                
                <button onclick="generateAINote()" class="btn btn-primary" style="margin-bottom: 15px;">ü§ñ Generate DAP Note with AI</button>
                
                <h4 style="margin-top: 20px; margin-bottom: 10px;">Clinical Note (DAP Format):</h4>
                
                <label style="font-weight: 600; display: block; margin-bottom: 5px;">DATA (Observations):</label>
                <textarea id="noteData" placeholder="What happened in session? Client's presentation, behaviors, topics discussed..." class="input"></textarea>
                
                <label style="font-weight: 600; display: block; margin-bottom: 5px;">ASSESSMENT (Clinical Assessment):</label>
                <textarea id="noteAssessment" placeholder="Clinical interpretation, progress toward goals, risk assessment..." class="input"></textarea>
                
                <label style="font-weight: 600; display: block; margin-bottom: 5px;">PLAN (Treatment Plan):</label>
                <textarea id="notePlan" placeholder="Interventions, homework, next session goals..." class="input"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="saveNewAppointment()" class="btn btn-primary">Save Appointment</button>
                <button onclick="deleteAppointment()" class="btn btn-danger" id="deleteAppointmentBtn" style="display: none;">Delete</button>
            </div>
        </div>
    </div>

    <!-- Add Diagnosis Modal -->
    <div id="addDiagnosisModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddDiagnosis()">&times;</span>
            <h2>Add Diagnosis</h2>
            <select id="diagnosisCode" class="input">
                <option value="">Select ICD-10 Code</option>
            </select>
            <textarea id="diagnosisNotes" placeholder="Clinical notes about this diagnosis" class="input"></textarea>
            <button onclick="saveDiagnosis()" class="btn btn-primary">Add Diagnosis</button>
        </div>
    </div>

    <!-- Assign Document Modal -->
    <div id="assignDocModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAssignDoc()">&times;</span>
            <h2>Assign Document</h2>
            <select id="assignDocClient" class="input">
                <option value="">Select Client</option>
            </select>
            <select id="assignDocTemplate" class="input">
                <option value="">Select Document</option>
            </select>
            <button onclick="saveAssignDoc()" class="btn btn-primary">Assign Document</button>
        </div>
    </div>

    <!-- Fill Document Modal -->
    <div id="fillDocModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="closeFillDocModal()">&times;</span>
            <h2 id="fillDocTitle"></h2>
            <div id="fillDocForm"></div>
            <div style="margin-top: 20px;">
                <h3>Signature</h3>
                <canvas id="signatureCanvas" width="500" height="150" style="border: 2px solid #ddd; border-radius: 4px; cursor: crosshair;"></canvas>
                <div style="margin-top: 10px;">
                    <button onclick="clearSignature()" class="btn">Clear Signature</button>
                    <button onclick="submitDocument()" class="btn btn-primary">Submit Document</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Document Modal -->
    <div id="viewDocModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="closeViewDocModal()">&times;</span>
            <h2 id="viewDocTitle"></h2>
            <div id="viewDocContent"></div>
            
            <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e5e5e5;">
                <h3>Clinician Review Signature</h3>
                <p style="margin-bottom: 15px; color: #666;">By signing below, you acknowledge that you have reviewed this completed document.</p>
                <canvas id="clinicianSignatureCanvas" width="500" height="150" style="border: 2px solid #ddd; border-radius: 4px; cursor: crosshair; display: block; margin-bottom: 15px;"></canvas>
                <div style="display: flex; gap: 10px;">
                    <button onclick="clearClinicianSignature()" class="btn">Clear</button>
                    <button onclick="saveClinicianSignature()" class="btn btn-primary">Save Review Signature</button>
                </div>
                <p id="clinicianSignatureTimestamp" style="margin-top: 10px; font-size: 12px; color: #666;"></p>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePaymentModal()">&times;</span>
            <h2>Process Payment</h2>
            
            <div class="payment-section">
                <div class="payment-amount">Amount Due: $<span id="paymentAmount">0.00</span></div>
                
                <div class="payment-methods">
                    <div class="payment-method selected" onclick="selectPaymentMethod('card')" id="cardMethod">
                        <strong>üí≥ Credit Card</strong>
                        <p style="font-size: 12px; margin-top: 5px;">Visa, MC, Amex</p>
                    </div>
                    <div class="payment-method" onclick="selectPaymentMethod('ach')" id="achMethod">
                        <strong>üè¶ Bank Transfer</strong>
                        <p style="font-size: 12px; margin-top: 5px;">ACH Transfer</p>
                    </div>
                </div>
                
                <div id="cardPaymentForm" class="payment-form">
                    <input type="text" id="cardholderName" placeholder="Cardholder Name" class="input">
                    <input type="text" id="cardNumber" placeholder="Card Number" class="input" maxlength="19">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" id="cardExpiry" placeholder="MM/YY" class="input" maxlength="5">
                        <input type="text" id="cardCVV" placeholder="CVV" class="input" maxlength="4">
                    </div>
                    <input type="text" id="billingZip" placeholder="Billing ZIP Code" class="input" maxlength="10">
                </div>
                
                <div id="achPaymentForm" class="payment-form" style="display: none;">
                    <input type="text" id="accountHolderName" placeholder="Account Holder Name" class="input">
                    <input type="text" id="routingNumber" placeholder="Routing Number" class="input" maxlength="9">
                    <input type="text" id="accountNumber" placeholder="Account Number" class="input">
                    <select id="accountType" class="input">
                        <option value="">Select Account Type</option>
                        <option value="checking">Checking</option>
                        <option value="savings">Savings</option>
                    </select>
                </div>
                
                <button onclick="processPayment()" class="btn btn-primary" style="width: 100%;">üí∞ Process Payment</button>
                <p style="margin-top: 15px; font-size: 12px; color: #666; text-align: center;">
                    üîí Secure payment processing ‚Ä¢ PCI DSS compliant
                </p>
            </div>
        </div>
    </div>

<script>
// Data Storage
let clients = JSON.parse(localStorage.getItem('clients')) || [];
let appointments = JSON.parse(localStorage.getItem('appointments')) || [];
let notes = JSON.parse(localStorage.getItem('notes')) || [];
let diagnoses = JSON.parse(localStorage.getItem('diagnoses')) || [];
let invoices = JSON.parse(localStorage.getItem('invoices')) || [];
let auditLog = JSON.parse(localStorage.getItem('auditLog')) || [];
let assignedDocs = JSON.parse(localStorage.getItem('assignedDocs')) || [];
let authToken = localStorage.getItem('authToken');
let currentClientId = null;
let currentViewingDocId = null;
let currentCalendarDate = new Date();
let currentEditingAppointmentId = null;

// ICD-10 Codes
const icd10Codes = [
    { code: 'F41.0', description: 'Panic disorder without agoraphobia' },
    { code: 'F41.1', description: 'Generalized anxiety disorder' },
    { code: 'F41.3', description: 'Other mixed anxiety disorders' },
    { code: 'F41.8', description: 'Other specified anxiety disorders' },
    { code: 'F41.9', description: 'Anxiety disorder, unspecified' },
    { code: 'F40.00', description: 'Agoraphobia, unspecified' },
    { code: 'F40.01', description: 'Agoraphobia with panic disorder' },
    { code: 'F40.10', description: 'Social phobia, unspecified' },
    { code: 'F40.11', description: 'Social phobia, generalized' },
    { code: 'F32.0', description: 'Major depressive disorder, single episode, mild' },
    { code: 'F32.1', description: 'Major depressive disorder, single episode, moderate' },
    { code: 'F32.2', description: 'Major depressive disorder, single episode, severe without psychotic features' },
    { code: 'F32.3', description: 'Major depressive disorder, single episode, severe with psychotic features' },
    { code: 'F32.9', description: 'Major depressive disorder, single episode, unspecified' },
    { code: 'F33.0', description: 'Major depressive disorder, recurrent, mild' },
    { code: 'F33.1', description: 'Major depressive disorder, recurrent, moderate' },
    { code: 'F33.2', description: 'Major depressive disorder, recurrent severe without psychotic features' },
    { code: 'F33.3', description: 'Major depressive disorder, recurrent, severe with psychotic symptoms' },
    { code: 'F33.41', description: 'Major depressive disorder, recurrent, in partial remission' },
    { code: 'F33.42', description: 'Major depressive disorder, recurrent, in full remission' },
    { code: 'F34.1', description: 'Dysthymic disorder' },
    { code: 'F31.0', description: 'Bipolar disorder, current episode hypomanic' },
    { code: 'F31.10', description: 'Bipolar disorder, current episode manic without psychotic features, unspecified' },
    { code: 'F31.2', description: 'Bipolar disorder, current episode manic severe with psychotic features' },
    { code: 'F31.31', description: 'Bipolar disorder, current episode depressed, mild' },
    { code: 'F31.32', description: 'Bipolar disorder, current episode depressed, moderate' },
    { code: 'F31.4', description: 'Bipolar disorder, current episode depressed, severe' },
    { code: 'F31.81', description: 'Bipolar II disorder' },
    { code: 'F43.10', description: 'Post-traumatic stress disorder, unspecified' },
    { code: 'F43.11', description: 'Post-traumatic stress disorder, acute' },
    { code: 'F43.12', description: 'Post-traumatic stress disorder, chronic' },
    { code: 'F43.21', description: 'Adjustment disorder with depressed mood' },
    { code: 'F43.22', description: 'Adjustment disorder with anxiety' },
    { code: 'F43.23', description: 'Adjustment disorder with mixed anxiety and depressed mood' },
    { code: 'F43.24', description: 'Adjustment disorder with disturbance of conduct' },
    { code: 'F42.2', description: 'Obsessive-compulsive disorder, mixed obsessional thoughts and acts' },
    { code: 'F42.3', description: 'Hoarding disorder' },
    { code: 'F42.4', description: 'Excoriation (skin-picking) disorder' },
    { code: 'F42.8', description: 'Other obsessive-compulsive disorder' },
    { code: 'F42.9', description: 'Obsessive-compulsive disorder, unspecified' },
    { code: 'F60.0', description: 'Paranoid personality disorder' },
    { code: 'F60.1', description: 'Schizoid personality disorder' },
    { code: 'F60.2', description: 'Antisocial personality disorder' },
    { code: 'F60.3', description: 'Borderline personality disorder' },
    { code: 'F60.4', description: 'Histrionic personality disorder' },
    { code: 'F60.5', description: 'Obsessive-compulsive personality disorder' },
    { code: 'F60.6', description: 'Avoidant personality disorder' },
    { code: 'F60.7', description: 'Dependent personality disorder' },
    { code: 'F60.81', description: 'Narcissistic personality disorder' },
    { code: 'F90.0', description: 'Attention-deficit hyperactivity disorder, predominantly inattentive type' },
    { code: 'F90.1', description: 'Attention-deficit hyperactivity disorder, predominantly hyperactive type' },
    { code: 'F90.2', description: 'Attention-deficit hyperactivity disorder, combined type' },
    { code: 'F90.8', description: 'Attention-deficit hyperactivity disorder, other type' },
    { code: 'F90.9', description: 'Attention-deficit hyperactivity disorder, unspecified type' },
    { code: 'F10.10', description: 'Alcohol abuse, uncomplicated' },
    { code: 'F10.20', description: 'Alcohol dependence, uncomplicated' },
    { code: 'F11.10', description: 'Opioid abuse, uncomplicated' },
    { code: 'F11.20', description: 'Opioid dependence, uncomplicated' },
    { code: 'F12.10', description: 'Cannabis abuse, uncomplicated' },
    { code: 'F12.20', description: 'Cannabis dependence, uncomplicated' },
    { code: 'F14.10', description: 'Cocaine abuse, uncomplicated' },
    { code: 'F14.20', description: 'Cocaine dependence, uncomplicated' },
    { code: 'F15.10', description: 'Other stimulant abuse, uncomplicated' },
    { code: 'F15.20', description: 'Other stimulant dependence, uncomplicated' },
    { code: 'F50.00', description: 'Anorexia nervosa, unspecified' },
    { code: 'F50.01', description: 'Anorexia nervosa, restricting type' },
    { code: 'F50.02', description: 'Anorexia nervosa, binge eating/purging type' },
    { code: 'F50.2', description: 'Bulimia nervosa' },
    { code: 'F50.81', description: 'Binge eating disorder' },
    { code: 'F50.89', description: 'Other specified eating disorder' },
    { code: 'F51.01', description: 'Primary insomnia' },
    { code: 'F51.11', description: 'Primary hypersomnia' },
    { code: 'Z63.0', description: 'Problems in relationship with spouse or partner' }
];

// Document Templates
const documentTemplates = [
    {
        id: 'ace',
        name: 'ACE Questionnaire',
        description: 'Adverse Childhood Experience Assessment',
        fields: [
            { id: 'q1', label: 'Did a parent or other adult in the household often swear at you, insult you, or humiliate you?', type: 'radio', options: ['Yes', 'No'] },
            { id: 'q2', label: 'Did a parent or other adult in the household often push, grab, shove, or slap you?', type: 'radio', options: ['Yes', 'No'] },
            { id: 'q3', label: 'Did an adult or person at least 5 years older than you ever touch or fondle you in a sexual way?', type: 'radio', options: ['Yes', 'No'] },
            { id: 'q4', label: 'Did you often feel that no one in your family loved you or thought you were important or special?', type: 'radio', options: ['Yes', 'No'] },
            { id: 'q5', label: 'Were your parents ever separated or divorced?', type: 'radio', options: ['Yes', 'No'] },
            { id: 'additional', label: 'Additional Comments', type: 'textarea' }
        ]
    },
    {
        id: 'consent',
        name: 'Informed Consent',
        description: 'Treatment consent form',
        fields: [
            { id: 'understand', label: 'I understand the nature of therapy and counseling services', type: 'checkbox' },
            { id: 'confidentiality', label: 'I understand the limits of confidentiality', type: 'checkbox' },
            { id: 'fees', label: 'I understand the fee structure and payment policies', type: 'checkbox' },
            { id: 'cancellation', label: 'I understand the cancellation policy', type: 'checkbox' },
            { id: 'consent', label: 'I consent to treatment', type: 'checkbox' }
        ]
    },
    {
        id: 'hipaa',
        name: 'HIPAA Notice',
        description: 'Privacy practices acknowledgment',
        fields: [
            { id: 'received', label: 'I acknowledge that I have received the Notice of Privacy Practices', type: 'checkbox' },
            { id: 'understand', label: 'I understand my rights regarding my protected health information', type: 'checkbox' }
        ]
    },
    {
        id: 'intake',
        name: 'Initial Intake Form',
        description: 'Comprehensive client intake',
        fields: [
            { id: 'presenting', label: 'What brings you to therapy today?', type: 'textarea' },
            { id: 'history', label: 'Brief mental health history', type: 'textarea' },
            { id: 'medications', label: 'Current medications', type: 'text' },
            { id: 'goals', label: 'What are your goals for therapy?', type: 'textarea' }
        ]
    }
];

function login() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    if ((username === 'admin' && password === 'admin123') || 
        (username === 'client' && password === 'client123')) {
        
        const token = 'token_' + Date.now();
        localStorage.setItem('authToken', token);
        localStorage.setItem('userName', username.charAt(0).toUpperCase() + username.slice(1));
        localStorage.setItem('userRole', username);
        localStorage.setItem('userId', username === 'admin' ? 'admin1' : 'client1');
        
        authToken = token;
        logAuditEvent('login', { username: username });
        showApp();
    } else {
        alert('Invalid credentials');
    }
}

function logout() {
    logAuditEvent('logout', { username: localStorage.getItem('userName') });
    localStorage.removeItem('authToken');
    localStorage.removeItem('userName');
    localStorage.removeItem('userRole');
    localStorage.removeItem('userId');
    authToken = null;
    showAuth();
}

function showApp() {
    document.getElementById('authContainer').style.display = 'none';
    document.getElementById('appContainer').style.display = 'block';
    document.getElementById('userName').textContent = localStorage.getItem('userName');
    
    const userRole = localStorage.getItem('userRole');
    if (userRole === 'client') {
        // Hide admin tabs for clients
        document.querySelectorAll('.tab-btn').forEach((btn, idx) => {
            if (idx === 0) {
                btn.textContent = 'My Portal';
            } else if (idx > 0 && idx < 3) {
                btn.style.display = 'none';
            }
        });
        document.getElementById('assignDocBtn').style.display = 'none';
        renderClientPortal();
    } else {
        renderClients();
    }
}

function showAuth() {
    document.getElementById('authContainer').style.display = 'block';
    document.getElementById('appContainer').style.display = 'none';
}

function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    
    document.getElementById(tabName + 'Content').style.display = 'block';
    event.target.classList.add('active');
    
    if (tabName === 'dashboard') {
        const userRole = localStorage.getItem('userRole');
        if (userRole === 'client') {
            renderClientPortal();
        } else {
            renderClients();
        }
    }
    else if (tabName === 'clients') renderClients();
    else if (tabName === 'calendar') {
        renderCalendar();
        renderAppointments();
    }
    else if (tabName === 'billing') renderBilling();
    else if (tabName === 'documents') renderAssignedDocs();
    else if (tabName === 'audit') renderAuditLog();
}

// Client Portal
function renderClientPortal() {
    const userId = localStorage.getItem('userId');
    const container = document.getElementById('dashboardContainer');
    
    const myAppointments = appointments.filter(apt => apt.clientId === userId);
    const myInvoices = invoices.filter(inv => inv.clientId === userId);
    const myDocs = assignedDocs.filter(d => d.clientId === userId);
    const pendingDocs = myDocs.filter(d => d.status === 'pending');
    const pendingInvoices = myInvoices.filter(inv => inv.status === 'pending');
    
    let html = '<div class="client-portal-card">';
    html += '<h3>üìÖ My Upcoming Appointments</h3>';
    
    if (myAppointments.length === 0) {
        html += '<p>No appointments scheduled.</p>';
    } else {
        html += '<table class="table" style="margin-top: 15px;"><thead><tr><th>Date</th><th>Time</th><th>Type</th></tr></thead><tbody>';
        myAppointments.slice(0, 5).forEach(apt => {
            html += `<tr>
                <td>${new Date(apt.date).toLocaleDateString()}</td>
                <td>${apt.time}</td>
                <td><span class="badge badge-info">${apt.type}</span></td>
            </tr>`;
        });
        html += '</tbody></table>';
    }
    html += '</div>';
    
    html += '<div class="client-portal-card">';
    html += '<h3>üí≥ My Billing</h3>';
    
    if (pendingInvoices.length === 0) {
        html += '<p>No pending invoices.</p>';
    } else {
        html += '<table class="table" style="margin-top: 15px;"><thead><tr><th>Invoice #</th><th>Date</th><th>Amount</th><th>Action</th></tr></thead><tbody>';
        pendingInvoices.forEach(inv => {
            html += `<tr>
                <td>${inv.id}</td>
                <td>${new Date(inv.date).toLocaleDateString()}</td>
                <td>$${inv.total.toFixed(2)}</td>
                <td><button onclick="openPaymentModal('${inv.id}')" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;">Pay Now</button></td>
            </tr>`;
        });
        html += '</tbody></table>';
    }
    html += '</div>';
    
    html += '<div class="client-portal-card">';
    html += '<h3>üìÑ My Documents</h3>';
    
    if (pendingDocs.length === 0) {
        html += '<p>No pending documents to complete.</p>';
    } else {
        html += '<div style="margin-top: 15px;">';
        pendingDocs.forEach(doc => {
            const template = documentTemplates.find(t => t.id === doc.templateId);
            html += `<div class="card">
                <h4>${template ? template.name : 'Document'}</h4>
                <p style="color: #666; margin: 10px 0;">${template ? template.description : ''}</p>
                <button onclick="openFillDoc('${doc.id}')" class="btn btn-primary">Complete Now</button>
            </div>`;
        });
        html += '</div>';
    }
    html += '</div>';
    
    container.innerHTML = html;
}

// Calendar Functions
function renderCalendar() {
    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth();
    
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('currentMonthYear').textContent = `${monthNames[month]} ${year}`;
    
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const daysInPrevMonth = new Date(year, month, 0).getDate();
    
    let html = '';
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    
    dayNames.forEach(day => {
        html += `<div class="calendar-day-header">${day}</div>`;
    });
    
    for (let i = firstDay - 1; i >= 0; i--) {
        const day = daysInPrevMonth - i;
        html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
    }
    
    const today = new Date();
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isToday = today.getDate() === day && today.getMonth() === month && today.getFullYear() === year;
        const todayClass = isToday ? 'today' : '';
        
        const dayAppointments = appointments.filter(apt => apt.date === dateStr);
        
        let appointmentsHtml = '';
        dayAppointments.forEach(apt => {
            const client = clients.find(c => c.id === apt.clientId);
            appointmentsHtml += `<div class="calendar-appointment" onclick="event.stopPropagation(); editAppointment('${apt.id}')">${apt.time} - ${client ? client.name : 'Unknown'}</div>`;
        });
        
        html += `<div class="calendar-day ${todayClass}" onclick="quickAddAppointment('${dateStr}')">
                    <div class="calendar-day-number">${day}</div>
                    ${appointmentsHtml}
                 </div>`;
    }
    
    const totalCells = firstDay + daysInMonth;
    const remainingCells = 42 - totalCells;
    for (let day = 1; day <= remainingCells; day++) {
        html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
    }
    
    document.getElementById('calendarGrid').innerHTML = html;
}

function previousMonth() {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
    renderCalendar();
}

function nextMonth() {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
    renderCalendar();
}

function quickAddAppointment(dateStr) {
    document.getElementById('appointmentDate').value = dateStr;
    openNewAppointment();
}

function editAppointment(appointmentId) {
    currentEditingAppointmentId = appointmentId;
    const apt = appointments.find(a => a.id === appointmentId);
    if (!apt) return;
    
    document.getElementById('appointmentModalTitle').textContent = 'Edit Appointment';
    document.getElementById('editAppointmentId').value = appointmentId;
    document.getElementById('appointmentClient').value = apt.clientId;
    document.getElementById('appointmentDate').value = apt.date;
    document.getElementById('appointmentTime').value = apt.time;
    document.getElementById('appointmentType').value = apt.type;
    document.getElementById('appointmentDuration').value = apt.duration;
    
    // Load note if exists
    const note = notes.find(n => n.appointmentId === appointmentId);
    if (note) {
        document.getElementById('sessionRecording').value = note.recording || '';
        document.getElementById('noteData').value = note.data || '';
        document.getElementById('noteAssessment').value = note.assessment || '';
        document.getElementById('notePlan').value = note.plan || '';
    } else {
        document.getElementById('sessionRecording').value = '';
        document.getElementById('noteData').value = '';
        document.getElementById('noteAssessment').value = '';
        document.getElementById('notePlan').value = '';
    }
    
    document.getElementById('deleteAppointmentBtn').style.display = 'inline-block';
    document.getElementById('newAppointmentModal').style.display = 'block';
    
    const select = document.getElementById('appointmentClient');
    select.innerHTML = '<option value="">Select Client</option>' +
        clients.map(c => '<option value="' + c.id + '">' + c.name + '</option>').join('');
    select.value = apt.clientId;
}

// Client Functions
function renderClients() {
    const container = document.getElementById('clientsList');
    
    if (clients.length === 0) {
        container.innerHTML = '<p style="color: white;">No clients found. Click "+ New Client" to add one.</p>';
        return;
    }
    
    container.innerHTML = clients.map(client => `
        <div class="client-card" onclick="openClientChart('${client.id}')">
            <h3>${client.name}</h3>
            <p>üìß ${client.email}</p>
            <p>üìû ${client.phone}</p>
            <p>üéÇ ${new Date(client.dob).toLocaleDateString()}</p>
        </div>
    `).join('');
}

function openNewClient() {
    document.getElementById('newClientModal').style.display = 'block';
    logAuditEvent('open_new_client_form');
}

function closeNewClient() {
    document.getElementById('newClientModal').style.display = 'none';
}

function saveNewClient() {
    const newClient = {
        id: 'client_' + Date.now(),
        name: document.getElementById('clientName').value,
        email: document.getElementById('clientEmail').value,
        phone: document.getElementById('clientPhone').value,
        dob: document.getElementById('clientDOB').value,
        notes: document.getElementById('clientNotes').value,
        createdAt: new Date().toISOString()
    };
    
    clients.push(newClient);
    localStorage.setItem('clients', JSON.stringify(clients));
    logAuditEvent('create_client', { clientId: newClient.id, clientName: newClient.name });
    
    closeNewClient();
    renderClients();
    
    document.getElementById('clientName').value = '';
    document.getElementById('clientEmail').value = '';
    document.getElementById('clientPhone').value = '';
    document.getElementById('clientDOB').value = '';
    document.getElementById('clientNotes').value = '';
}

function openClientChart(clientId) {
    currentClientId = clientId;
    const client = clients.find(c => c.id === clientId);
    
    document.getElementById('chartClientName').textContent = client.name;
    document.getElementById('chartEmail').textContent = client.email;
    document.getElementById('chartPhone').textContent = client.phone;
    document.getElementById('chartDOB').textContent = new Date(client.dob).toLocaleDateString();
    document.getElementById('chartNotes').textContent = client.notes || 'No notes';
    
    document.getElementById('clientChartModal').style.display = 'block';
    showChartTab('info');
    logAuditEvent('view_client_chart', { clientId: clientId });
}

function closeClientChart() {
    document.getElementById('clientChartModal').style.display = 'none';
    currentClientId = null;
}

function showChartTab(tabName) {
    document.querySelectorAll('.chart-section').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.chart-tab-btn').forEach(btn => btn.classList.remove('active'));
    
    document.getElementById('chart' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
    event.target.classList.add('active');
    
    if (tabName === 'appointments') renderClientAppointments();
    else if (tabName === 'notes') renderClientNotes();
    else if (tabName === 'diagnosis') renderClientDiagnoses();
}

// Appointments
function renderAppointments() {
    const container = document.getElementById('appointmentsList');
    
    if (appointments.length === 0) {
        container.innerHTML = '<div class="card"><p>No appointments scheduled.</p></div>';
        return;
    }
    
    container.innerHTML = '<table class="table"><thead><tr><th>Date</th><th>Time</th><th>Client</th><th>Type</th><th>Duration</th><th>Actions</th></tr></thead><tbody>' +
        appointments.map(apt => {
            const client = clients.find(c => c.id === apt.clientId);
            return '<tr>' +
                '<td>' + new Date(apt.date).toLocaleDateString() + '</td>' +
                '<td>' + apt.time + '</td>' +
                '<td>' + (client ? client.name : 'Unknown') + '</td>' +
                '<td><span class="badge badge-info">' + apt.type + '</span></td>' +
                '<td>' + apt.duration + ' min</td>' +
                '<td><button onclick="editAppointment(\'' + apt.id + '\')" class="btn" style="padding: 6px 12px; font-size: 12px;">Edit</button></td>' +
                '</tr>';
        }).join('') +
        '</tbody></table>';
}

function renderClientAppointments() {
    const container = document.getElementById('clientAppointmentsList');
    const clientAppts = appointments.filter(apt => apt.clientId === currentClientId);
    
    if (clientAppts.length === 0) {
        container.innerHTML = '<p>No appointments for this client.</p>';
        return;
    }
    
    container.innerHTML = '<table class="table"><thead><tr><th>Date</th><th>Time</th><th>Type</th><th>Duration</th><th>Actions</th></tr></thead><tbody>' +
        clientAppts.map(apt =>
            '<tr><td>' + new Date(apt.date).toLocaleDateString() + '</td>' +
            '<td>' + apt.time + '</td>' +
            '<td><span class="badge badge-info">' + apt.type + '</span></td>' +
            '<td>' + apt.duration + ' min</td>' +
            '<td><button onclick="editAppointment(\'' + apt.id + '\')" class="btn" style="padding: 6px 12px; font-size: 12px;">Edit</button></td>' +
            '</tr>'
        ).join('') +
        '</tbody></table>';
}

function openNewAppointment() {
    currentEditingAppointmentId = null;
    document.getElementById('appointmentModalTitle').textContent = 'New Appointment';
    document.getElementById('editAppointmentId').value = '';
    document.getElementById('deleteAppointmentBtn').style.display = 'none';
    
    const select = document.getElementById('appointmentClient');
    select.innerHTML = '<option value="">Select Client</option>' +
        clients.map(c => '<option value="' + c.id + '">' + c.name + '</option>').join('');
    
    document.getElementById('appointmentDate').value = '';
    document.getElementById('appointmentTime').value = '';
    document.getElementById('appointmentType').value = '';
    document.getElementById('appointmentDuration').value = '60';
    document.getElementById('sessionRecording').value = '';
    document.getElementById('noteData').value = '';
    document.getElementById('noteAssessment').value = '';
    document.getElementById('notePlan').value = '';
    
    document.getElementById('newAppointmentModal').style.display = 'block';
}

function openNewAppointmentForClient() {
    openNewAppointment();
    document.getElementById('appointmentClient').value = currentClientId;
}

function closeNewAppointment() {
    document.getElementById('newAppointmentModal').style.display = 'none';
    currentEditingAppointmentId = null;
}

function saveNewAppointment() {
    const editId = document.getElementById('editAppointmentId').value;
    const clientId = document.getElementById('appointmentClient').value;
    const date = document.getElementById('appointmentDate').value;
    const time = document.getElementById('appointmentTime').value;
    const type = document.getElementById('appointmentType').value;
    const duration = parseInt(document.getElementById('appointmentDuration').value);
    
    if (!clientId || !date || !time || !type) {
        alert('Please fill in all appointment fields');
        return;
    }
    
    if (editId) {
        // Update existing appointment
        const aptIndex = appointments.findIndex(a => a.id === editId);
        appointments[aptIndex].clientId = clientId;
        appointments[aptIndex].date = date;
        appointments[aptIndex].time = time;
        appointments[aptIndex].type = type;
        appointments[aptIndex].duration = duration;
        
        logAuditEvent('update_appointment', { appointmentId: editId });
    } else {
        // Create new appointment
        const newAppt = {
            id: 'appt_' + Date.now(),
            clientId: clientId,
            date: date,
            time: time,
            type: type,
            duration: duration,
            createdAt: new Date().toISOString()
        };
        
        appointments.push(newAppt);
        logAuditEvent('create_appointment', { appointmentId: newAppt.id });
        
        // Auto-generate invoice
        const cptCode = type;
        const rates = {
            '90791': 200,
            '90834': 150,
            '90837': 180,
            '90847': 200,
            '90853': 75
        };
        
        const invoice = {
            id: 'INV-' + Date.now(),
            clientId: clientId,
            date: new Date().toISOString(),
            services: [{
                code: cptCode,
                description: document.getElementById('appointmentType').selectedOptions[0].text,
                units: 1,
                rate: rates[cptCode] || 150
            }],
            total: rates[cptCode] || 150,
            status: 'pending'
        };
        
        invoices.push(invoice);
        localStorage.setItem('invoices', JSON.stringify(invoices));
    }
    
    // Save clinical note if provided
    const sessionRecording = document.getElementById('sessionRecording').value;
    const noteData = document.getElementById('noteData').value;
    const noteAssessment = document.getElementById('noteAssessment').value;
    const notePlan = document.getElementById('notePlan').value;
    
    if (noteData || noteAssessment || notePlan) {
        const appointmentId = editId || appointments[appointments.length - 1].id;
        
        // Check if note already exists for this appointment
        const existingNoteIndex = notes.findIndex(n => n.appointmentId === appointmentId);
        
        if (existingNoteIndex >= 0) {
            // Update existing note
            notes[existingNoteIndex].recording = sessionRecording;
            notes[existingNoteIndex].data = noteData;
            notes[existingNoteIndex].assessment = noteAssessment;
            notes[existingNoteIndex].plan = notePlan;
            notes[existingNoteIndex].updatedAt = new Date().toISOString();
        } else {
            // Create new note
            const newNote = {
                id: 'note_' + Date.now(),
                clientId: clientId,
                appointmentId: appointmentId,
                date: new Date().toISOString(),
                recording: sessionRecording,
                data: noteData,
                assessment: noteAssessment,
                plan: notePlan
            };
            notes.push(newNote);
        }
        
        localStorage.setItem('notes', JSON.stringify(notes));
        logAuditEvent('save_note', { appointmentId: appointmentId });
    }
    
    localStorage.setItem('appointments', JSON.stringify(appointments));
    
    closeNewAppointment();
    renderCalendar();
    renderAppointments();
    if (currentClientId) {
        renderClientAppointments();
        renderClientNotes();
    }
}

function deleteAppointment() {
    if (!confirm('Are you sure you want to delete this appointment?')) return;
    
    const editId = document.getElementById('editAppointmentId').value;
    appointments = appointments.filter(a => a.id !== editId);
    localStorage.setItem('appointments', JSON.stringify(appointments));
    logAuditEvent('delete_appointment', { appointmentId: editId });
    
    closeNewAppointment();
    renderCalendar();
    renderAppointments();
    if (currentClientId) renderClientAppointments();
}

// AI Note Generator
async function generateAINote() {
    const recording = document.getElementById('sessionRecording').value;
    if (!recording) {
        alert('Please enter session notes or recording transcript');
        return;
    }

    const generateBtn = event.target;
    generateBtn.disabled = true;
    generateBtn.textContent = 'Generating...';

    try {
        const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                model: "claude-sonnet-4-20250514",
                max_tokens: 2000,
                messages: [
                    {
                        role: "user",
                        content: `You are an expert clinical therapist creating a professional DAP (Data, Assessment, Plan) progress note.

Based on the following session information, create a comprehensive DAP note:

${recording}

IMPORTANT INSTRUCTIONS:
1. Use proper clinical language and terminology
2. Be specific and detailed, not vague or generic
3. Include relevant clinical observations
4. Make appropriate clinical assessments
5. Create actionable treatment plan items
6. Maintain professional tone throughout

Format your response EXACTLY as follows:

DATA:
[Write 3-5 detailed sentences about what happened in the session. Include:
- Client's presenting concerns and topics discussed
- Observable behaviors, affect, and mood
- Specific statements or themes from the client
- Interaction patterns and engagement level]

ASSESSMENT:
[Write 3-4 detailed sentences providing clinical assessment. Include:
- Clinical interpretation of the client's presentation
- Progress toward treatment goals
- Risk assessment if applicable
- Diagnostic considerations or symptom patterns
- Therapeutic relationship observations]

PLAN:
[Write 3-5 specific action items. Include:
- Interventions to be used in next session
- Homework or between-session activities
- Goals for upcoming sessions
- Any referrals or consultations needed
- Follow-up on specific issues]

Do not include any other text, explanations, or formatting outside of this structure. Begin directly with "DATA:" and follow the format exactly.`
                    }
                ]
            })
        });

        const data = await response.json();
        const aiNote = data.content[0].text.trim();
        
        const dataMatch = aiNote.match(/DATA:(.*?)(?=ASSESSMENT:|$)/s);
        const assessmentMatch = aiNote.match(/ASSESSMENT:(.*?)(?=PLAN:|$)/s);
        const planMatch = aiNote.match(/PLAN:(.*?)$/s);
        
        if (dataMatch) {
            document.getElementById('noteData').value = dataMatch[1].trim();
        }
        if (assessmentMatch) {
            document.getElementById('noteAssessment').value = assessmentMatch[1].trim();
        }
        if (planMatch) {
            document.getElementById('notePlan').value = planMatch[1].trim();
        }
        
        alert('AI note generated successfully! Please review and edit as needed before saving.');
    } catch (error) {
        console.error('Error generating AI note:', error);
        alert('Error generating AI note. Please try again or write manually.');
    } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = 'ü§ñ Generate DAP Note with AI';
    }
}

// Clinical Notes
function renderClientNotes() {
    const container = document.getElementById('clientNotesList');
    const clientNotes = notes.filter(note => note.clientId === currentClientId);
    
    if (clientNotes.length === 0) {
        container.innerHTML = '<p>No clinical notes for this client. Notes are created within appointments.</p>';
        return;
    }
    
    container.innerHTML = clientNotes.map(note => {
        const apt = appointments.find(a => a.id === note.appointmentId);
        return `
        <div class="card">
            <p><strong>Date:</strong> ${new Date(note.date).toLocaleDateString()}</p>
            ${apt ? '<p><strong>Appointment:</strong> ' + apt.type + ' - ' + new Date(apt.date).toLocaleDateString() + ' at ' + apt.time + '</p>' : ''}
            <p><strong>DATA:</strong> ${note.data}</p>
            <p><strong>ASSESSMENT:</strong> ${note.assessment}</p>
            <p><strong>PLAN:</strong> ${note.plan}</p>
        </div>
    `}).join('');
}

// Diagnosis
function renderClientDiagnoses() {
    const container = document.getElementById('clientDiagnosisList');
    const clientDiagnoses = diagnoses.filter(d => d.clientId === currentClientId);
    
    if (clientDiagnoses.length === 0) {
        container.innerHTML = '<p>No diagnoses for this client.</p>';
        return;
    }
    
    container.innerHTML = '<table class="table"><thead><tr><th>Code</th><th>Description</th><th>Date</th><th>Notes</th></tr></thead><tbody>' +
        clientDiagnoses.map(d => {
            const code = icd10Codes.find(c => c.code === d.code);
            return '<tr>' +
                '<td><strong>' + d.code + '</strong></td>' +
                '<td>' + (code ? code.description : 'Unknown') + '</td>' +
                '<td>' + new Date(d.date).toLocaleDateString() + '</td>' +
                '<td>' + (d.notes || 'N/A') + '</td>' +
                '</tr>';
        }).join('') +
        '</tbody></table>';
}

function openAddDiagnosis() {
    const select = document.getElementById('diagnosisCode');
    select.innerHTML = '<option value="">Select ICD-10 Code</option>' +
        icd10Codes.map(code => `<option value="${code.code}">${code.code} - ${code.description}</option>`).join('');
    
    document.getElementById('addDiagnosisModal').style.display = 'block';
}

function closeAddDiagnosis() {
    document.getElementById('addDiagnosisModal').style.display = 'none';
}

function saveDiagnosis() {
    const newDiagnosis = {
        id: 'diag_' + Date.now(),
        clientId: currentClientId,
        code: document.getElementById('diagnosisCode').value,
        notes: document.getElementById('diagnosisNotes').value,
        date: new Date().toISOString()
    };
    
    diagnoses.push(newDiagnosis);
    localStorage.setItem('diagnoses', JSON.stringify(diagnoses));
    logAuditEvent('add_diagnosis', { diagnosisId: newDiagnosis.id, clientId: currentClientId });
    
    closeAddDiagnosis();
    renderClientDiagnoses();
    
    document.getElementById('diagnosisCode').value = '';
    document.getElementById('diagnosisNotes').value = '';
}

// Billing
function renderBilling() {
    const container = document.getElementById('billingList');
    const userRole = localStorage.getItem('userRole');
    
    let billingData = [];
    if (userRole === 'admin') {
        billingData = invoices;
    } else {
        const userId = localStorage.getItem('userId');
        billingData = invoices.filter(inv => inv.clientId === userId);
    }
    
    if (billingData.length === 0) {
        container.innerHTML = '<div class="card"><p>No billing records found.</p></div>';
        return;
    }
    
    container.innerHTML = '<table class="table"><thead><tr>' +
        '<th>Invoice #</th><th>Client</th><th>Date</th><th>Services</th><th>Amount</th><th>Status</th><th>Actions</th>' +
        '</tr></thead><tbody>' +
        billingData.map(inv => {
            const client = clients.find(c => c.id === inv.clientId);
            const statusClass = inv.status === 'paid' ? 'badge-success' : 
                              inv.status === 'pending' ? 'badge-warning' : 'badge-danger';
            
            let payButton = '';
            if (inv.status === 'pending') {
                payButton = `<button onclick="openPaymentModal('${inv.id}')" class="btn btn-success" style="padding: 6px 12px; font-size: 12px;">üí≥ Pay Now</button>`;
            }
            
            return '<tr>' +
                '<td>' + inv.id + '</td>' +
                '<td>' + (client ? client.name : 'Unknown') + '</td>' +
                '<td>' + new Date(inv.date).toLocaleDateString() + '</td>' +
                '<td>' + inv.services.map(s => s.code + ' (' + s.units + ')').join(', ') + '</td>' +
                '<td><strong>$' + inv.total.toFixed(2) + '</strong></td>' +
                '<td><span class="badge ' + statusClass + '">' + inv.status.toUpperCase() + '</span></td>' +
                '<td>' + payButton + '</td>' +
                '</tr>';
        }).join('') +
        '</tbody></table>';
}

// Payment Functions
let currentPaymentInvoiceId = null;

function openPaymentModal(invoiceId) {
    currentPaymentInvoiceId = invoiceId;
    const invoice = invoices.find(inv => inv.id === invoiceId);
    
    if (!invoice) {
        alert('Invoice not found');
        return;
    }
    
    document.getElementById('paymentAmount').textContent = invoice.total.toFixed(2);
    document.getElementById('paymentModal').style.display = 'block';
    
    document.getElementById('cardholderName').value = '';
    document.getElementById('cardNumber').value = '';
    document.getElementById('cardExpiry').value = '';
    document.getElementById('cardCVV').value = '';
    document.getElementById('billingZip').value = '';
    selectPaymentMethod('card');
}

function closePaymentModal() {
    document.getElementById('paymentModal').style.display = 'none';
    currentPaymentInvoiceId = null;
}

function selectPaymentMethod(method) {
    document.getElementById('cardMethod').classList.remove('selected');
    document.getElementById('achMethod').classList.remove('selected');
    
    if (method === 'card') {
        document.getElementById('cardMethod').classList.add('selected');
        document.getElementById('cardPaymentForm').style.display = 'block';
        document.getElementById('achPaymentForm').style.display = 'none';
    } else {
        document.getElementById('achMethod').classList.add('selected');
        document.getElementById('cardPaymentForm').style.display = 'none';
        document.getElementById('achPaymentForm').style.display = 'block';
    }
}

async function processPayment() {
    const invoice = invoices.find(inv => inv.id === currentPaymentInvoiceId);
    if (!invoice) {
        alert('Invoice not found');
        return;
    }
    
    const selectedMethod = document.getElementById('cardMethod').classList.contains('selected') ? 'card' : 'ach';
    
    let isValid = false;
    if (selectedMethod === 'card') {
        const cardholderName = document.getElementById('cardholderName').value.trim();
        const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
        const cardExpiry = document.getElementById('cardExpiry').value;
        const cardCVV = document.getElementById('cardCVV').value;
        const billingZip = document.getElementById('billingZip').value;
        
        if (!cardholderName || cardNumber.length < 13 || !cardExpiry.match(/^\d{2}\/\d{2}$/) || 
            cardCVV.length < 3 || !billingZip) {
            alert('Please fill in all card details correctly');
            return;
        }
        isValid = true;
    } else {
        const accountHolderName = document.getElementById('accountHolderName').value.trim();
        const routingNumber = document.getElementById('routingNumber').value;
        const accountNumber = document.getElementById('accountNumber').value;
        const accountType = document.getElementById('accountType').value;
        
        if (!accountHolderName || routingNumber.length !== 9 || !accountNumber || !accountType) {
            alert('Please fill in all bank account details correctly');
            return;
        }
        isValid = true;
    }
    
    if (!isValid) return;
    
    const processBtn = event.target;
    processBtn.disabled = true;
    processBtn.textContent = 'Processing...';
    
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    invoice.status = 'paid';
    invoice.paidDate = new Date().toISOString();
    invoice.paymentMethod = selectedMethod;
    
    localStorage.setItem('invoices', JSON.stringify(invoices));
    
    logAuditEvent('payment_processed', {
        invoiceId: invoice.id,
        amount: invoice.total,
        method: selectedMethod
    });
    
    alert('‚úÖ Payment processed successfully! Thank you.');
    
    closePaymentModal();
    renderBilling();
    
    const userRole = localStorage.getItem('userRole');
    if (userRole === 'client') {
        renderClientPortal();
    }
    
    processBtn.disabled = false;
    processBtn.textContent = 'üí∞ Process Payment';
}

// Documents
function renderAssignedDocs() {
    const container = document.getElementById('assignedDocsList');
    const userRole = localStorage.getItem('userRole');
    
    let docsToShow = assignedDocs;
    if (userRole === 'client') {
        const userId = localStorage.getItem('userId');
        docsToShow = assignedDocs.filter(d => d.clientId === userId);
    }
    
    if (docsToShow.length === 0) {
        container.innerHTML = '<div class="card"><p>No documents assigned.</p></div>';
        return;
    }
    
    container.innerHTML = '<table class="table"><thead><tr>' +
        '<th>Document</th><th>Client</th><th>Assigned</th><th>Status</th><th>Actions</th>' +
        '</tr></thead><tbody>' +
        docsToShow.map(doc => {
            const template = documentTemplates.find(t => t.id === doc.templateId);
            const client = clients.find(c => c.id === doc.clientId);
            const statusClass = doc.status === 'completed' ? 'badge-success' : 'badge-warning';
            
            let actionBtn = '';
            if (userRole === 'client' && doc.status === 'pending') {
                actionBtn = `<button onclick="openFillDoc('${doc.id}')" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;">Fill Out</button>`;
            } else if (userRole === 'admin' && doc.status === 'completed') {
                actionBtn = `<button onclick="openViewDoc('${doc.id}')" class="btn" style="padding: 6px 12px; font-size: 12px;">View</button>`;
            }
            
            return '<tr>' +
                '<td>' + (template ? template.name : 'Unknown') + '</td>' +
                '<td>' + (client ? client.name : 'Unknown') + '</td>' +
                '<td>' + new Date(doc.assignedAt).toLocaleDateString() + '</td>' +
                '<td><span class="badge ' + statusClass + '">' + doc.status + '</span></td>' +
                '<td>' + actionBtn + '</td>' +
                '</tr>';
        }).join('') +
        '</tbody></table>';
}

function openAssignDoc() {
    const clientSelect = document.getElementById('assignDocClient');
    clientSelect.innerHTML = '<option value="">Select Client</option>' +
        clients.map(c => '<option value="' + c.id + '">' + c.name + '</option>').join('');
    
    const templateSelect = document.getElementById('assignDocTemplate');
    templateSelect.innerHTML = '<option value="">Select Document</option>' +
        documentTemplates.map(t => '<option value="' + t.id + '">' + t.name + ' - ' + t.description + '</option>').join('');
    
    document.getElementById('assignDocModal').style.display = 'block';
}

function closeAssignDoc() {
    document.getElementById('assignDocModal').style.display = 'none';
}

function saveAssignDoc() {
    const newDoc = {
        id: 'doc_' + Date.now(),
        clientId: document.getElementById('assignDocClient').value,
        templateId: document.getElementById('assignDocTemplate').value,
        assignedAt: new Date().toISOString(),
        status: 'pending',
        responses: {}
    };
    
    assignedDocs.push(newDoc);
    localStorage.setItem('assignedDocs', JSON.stringify(assignedDocs));
    logAuditEvent('assign_document', { documentId: newDoc.id });
    
    closeAssignDoc();
    renderAssignedDocs();
}

function openFillDoc(docId) {
    const doc = assignedDocs.find(d => d.id === docId);
    const template = documentTemplates.find(t => t.id === doc.templateId);
    
    document.getElementById('fillDocTitle').textContent = template.name;
    
    let formHtml = '<p style="margin-bottom: 20px; color: #666;">' + template.description + '</p>';
    
    template.fields.forEach(field => {
        formHtml += '<div style="margin-bottom: 20px;">';
        formHtml += '<label style="display: block; font-weight: 600; margin-bottom: 8px;">' + field.label + '</label>';
        
        if (field.type === 'text') {
            formHtml += '<input type="text" id="field_' + field.id + '" class="input">';
        } else if (field.type === 'textarea') {
            formHtml += '<textarea id="field_' + field.id + '" class="input"></textarea>';
        } else if (field.type === 'checkbox') {
            formHtml += '<input type="checkbox" id="field_' + field.id + '" style="width: auto; margin-right: 10px;">';
        } else if (field.type === 'radio') {
            field.options.forEach(opt => {
                formHtml += '<label style="display: block; margin-bottom: 5px;">' +
                    '<input type="radio" name="field_' + field.id + '" value="' + opt + '" style="margin-right: 8px;">' + opt +
                    '</label>';
            });
        }
        
        formHtml += '</div>';
    });
    
    document.getElementById('fillDocForm').innerHTML = formHtml;
    document.getElementById('fillDocModal').style.display = 'block';
    
    const canvas = document.getElementById('signatureCanvas');
    setupSignaturePad(canvas);
}

function closeFillDocModal() {
    document.getElementById('fillDocModal').style.display = 'none';
}

let isDrawing = false;
let lastX = 0;
let lastY = 0;

function setupSignaturePad(canvas) {
    const ctx = canvas.getContext('2d');
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    
    canvas.addEventListener('mousedown', (e) => {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        lastX = e.clientX - rect.left;
        lastY = e.clientY - rect.top;
    });
    
    canvas.addEventListener('mousemove', (e) => {
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.stroke();
        
        lastX = x;
        lastY = y;
    });
    
    canvas.addEventListener('mouseup', () => {
        isDrawing = false;
    });
    
    canvas.addEventListener('mouseleave', () => {
        isDrawing = false;
    });
    
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        lastX = touch.clientX - rect.left;
        lastY = touch.clientY - rect.top;
    });
    
    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.stroke();
        
        lastX = x;
        lastY = y;
    });
    
    canvas.addEventListener('touchend', () => {
        isDrawing = false;
    });
}

function clearSignature() {
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

function submitDocument() {
    const doc = assignedDocs.find(d => d.status === 'pending');
    const template = documentTemplates.find(t => t.id === doc.templateId);
    
    const formData = {};
    template.fields.forEach(field => {
        if (field.type === 'radio') {
            const selected = document.querySelector(`input[name="field_${field.id}"]:checked`);
            formData[field.id] = selected ? selected.value : '';
        } else if (field.type === 'checkbox') {
            formData[field.id] = document.getElementById(`field_${field.id}`).checked;
        } else {
            formData[field.id] = document.getElementById(`field_${field.id}`).value;
        }
    });
    
    const canvas = document.getElementById('signatureCanvas');
    const signatureData = canvas.toDataURL();
    
    doc.responses = formData;
    doc.signature = signatureData;
    doc.status = 'completed';
    doc.completedAt = new Date().toISOString();
    
    localStorage.setItem('assignedDocs', JSON.stringify(assignedDocs));
    logAuditEvent('submit_document', { documentId: doc.id });
    
    alert('Document submitted successfully!');
    closeFillDocModal();
    renderAssignedDocs();
    
    const userRole = localStorage.getItem('userRole');
    if (userRole === 'client') {
        renderClientPortal();
    }
}

function openViewDoc(docId) {
    currentViewingDocId = docId;
    const doc = assignedDocs.find(d => d.id === docId);
    const template = documentTemplates.find(t => t.id === doc.templateId);
    
    document.getElementById('viewDocTitle').textContent = template.name + ' - Completed';
    
    let contentHtml = '<div class="card">';
    contentHtml += '<p><strong>Completed:</strong> ' + new Date(doc.completedAt).toLocaleString() + '</p>';
    contentHtml += '<h3 style="margin-top: 20px; margin-bottom: 15px;">Responses:</h3>';
    
    template.fields.forEach(field => {
        contentHtml += '<div style="margin-bottom: 15px;">';
        contentHtml += '<p style="font-weight: 600;">' + field.label + '</p>';
        contentHtml += '<p style="color: #666;">' + (doc.responses[field.id] || 'No response') + '</p>';
        contentHtml += '</div>';
    });
    
    if (doc.signature) {
        contentHtml += '<div style="margin-top: 20px;">';
        contentHtml += '<p style="font-weight: 600;">Client Signature:</p>';
        contentHtml += '<img src="' + doc.signature + '" style="border: 1px solid #ddd; margin-top: 10px;">';
        contentHtml += '</div>';
    }
    
    if (doc.clinicianSignature) {
        contentHtml += '<div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e5e5e5;">';
        contentHtml += '<p style="font-weight: 600;">Clinician Review:</p>';
        contentHtml += '<p style="color: #666;">Reviewed by: ' + doc.clinicianName + '</p>';
        contentHtml += '<p style="color: #666;">Date: ' + new Date(doc.clinicianReviewedAt).toLocaleString() + '</p>';
        contentHtml += '<img src="' + doc.clinicianSignature + '" style="border: 1px solid #ddd; margin-top: 10px;">';
        contentHtml += '</div>';
    }
    
    contentHtml += '</div>';
    
    document.getElementById('viewDocContent').innerHTML = contentHtml;
    document.getElementById('viewDocModal').style.display = 'block';
    
    const canvas = document.getElementById('clinicianSignatureCanvas');
    setupClinicianSignaturePad(canvas);
}

function closeViewDocModal() {
    document.getElementById('viewDocModal').style.display = 'none';
}

let isClinicianDrawing = false;
let clinicianLastX = 0;
let clinicianLastY = 0;
let clinicianSignatureTime = null;

function setupClinicianSignaturePad(canvas) {
    const ctx = canvas.getContext('2d');
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    
    canvas.addEventListener('mousedown', (e) => {
        isClinicianDrawing = true;
        clinicianSignatureTime = new Date();
        document.getElementById('clinicianSignatureTimestamp').textContent = 'Signed: ' + clinicianSignatureTime.toLocaleString();
        const rect = canvas.getBoundingClientRect();
        clinicianLastX = e.clientX - rect.left;
        clinicianLastY = e.clientY - rect.top;
    });
    
    canvas.addEventListener('mousemove', (e) => {
        if (!isClinicianDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        ctx.beginPath();
        ctx.moveTo(clinicianLastX, clinicianLastY);
        ctx.lineTo(x, y);
        ctx.stroke();
        
        clinicianLastX = x;
        clinicianLastY = y;
    });
    
    canvas.addEventListener('mouseup', () => {
        isClinicianDrawing = false;
    });
    
    canvas.addEventListener('mouseleave', () => {
        isClinicianDrawing = false;
    });
    
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        isClinicianDrawing = true;
        clinicianSignatureTime = new Date();
        document.getElementById('clinicianSignatureTimestamp').textContent = 'Signed: ' + clinicianSignatureTime.toLocaleString();
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        clinicianLastX = touch.clientX - rect.left;
        clinicianLastY = touch.clientY - rect.top;
    });
    
    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (!isClinicianDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        
        ctx.beginPath();
        ctx.moveTo(clinicianLastX, clinicianLastY);
        ctx.lineTo(x, y);
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        clinicianLastX = x;
        clinicianLastY = y;
    });
    
    canvas.addEventListener('touchend', () => {
        isClinicianDrawing = false;
    });
}

function clearClinicianSignature() {
    const canvas = document.getElementById('clinicianSignatureCanvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    clinicianSignatureTime = null;
    document.getElementById('clinicianSignatureTimestamp').textContent = '';
}

function saveClinicianSignature() {
    const canvas = document.getElementById('clinicianSignatureCanvas');
    const ctx = canvas.getContext('2d');
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const pixels = imageData.data;
    let hasSignature = false;
    
    for (let i = 0; i < pixels.length; i += 4) {
        if (pixels[i + 3] > 0) {
            hasSignature = true;
            break;
        }
    }
    
    if (!hasSignature) {
        alert('Please provide your signature to acknowledge review');
        return;
    }
    
    const signatureData = canvas.toDataURL();
    
    const docIndex = assignedDocs.findIndex(d => d.id === currentViewingDocId);
    assignedDocs[docIndex].clinicianSignature = signatureData;
    assignedDocs[docIndex].clinicianSignatureDate = clinicianSignatureTime ? clinicianSignatureTime.toISOString() : new Date().toISOString();
    assignedDocs[docIndex].clinicianName = localStorage.getItem('userName');
    assignedDocs[docIndex].clinicianReviewedAt = new Date().toISOString();
    
    localStorage.setItem('assignedDocs', JSON.stringify(assignedDocs));
    
    alert('Review signature saved successfully!');
    closeViewDocModal();
    
    if (document.getElementById('documentsContent').style.display === 'block') {
        renderAssignedDocs();
    }
}

// Audit Log
function logAuditEvent(action, details = {}) {
    const event = {
        id: 'audit_' + Date.now(),
        timestamp: new Date().toISOString(),
        user: localStorage.getItem('userName'),
        action: action,
        details: details,
        ip: '192.168.1.1'
    };
    
    auditLog.push(event);
    localStorage.setItem('auditLog', JSON.stringify(auditLog));
}

function renderAuditLog() {
    const container = document.getElementById('auditLogList');
    
    if (auditLog.length === 0) {
        container.innerHTML = '<div class="card"><p>No audit entries.</p></div>';
        return;
    }
    
    const sortedLog = [...auditLog].reverse();
    
    container.innerHTML = '<table class="table"><thead><tr>' +
        '<th>Timestamp</th><th>User</th><th>Action</th><th>Details</th><th>IP</th>' +
        '</tr></thead><tbody>' +
        sortedLog.map(entry =>
            '<tr>' +
            '<td>' + new Date(entry.timestamp).toLocaleString() + '</td>' +
            '<td>' + entry.user + '</td>' +
            '<td><span class="badge badge-info">' + entry.action + '</span></td>' +
            '<td>' + JSON.stringify(entry.details) + '</td>' +
            '<td>' + entry.ip + '</td>' +
            '</tr>'
        ).join('') +
        '</tbody></table>';
}

// Format card number and expiry
window.addEventListener('DOMContentLoaded', function() {
    const cardNumberInput = document.getElementById('cardNumber');
    if (cardNumberInput) {
        cardNumberInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formattedValue;
        });
    }
    
    const expiryInput = document.getElementById('cardExpiry');
    if (expiryInput) {
        expiryInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.slice(0, 2) + '/' + value.slice(2, 4);
            }
            e.target.value = value;
        });
    }
});

// Initialize
if (authToken) {
    showApp();
} else {
    showAuth();
}
</script>

</body>
</html>
