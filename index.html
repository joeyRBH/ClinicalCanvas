<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClinicalCanvas EHR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 10px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .content {
                padding: 20px;
            }
            
            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab-btn {
                white-space: nowrap;
                padding: 10px 16px;
                font-size: 13px;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
                margin: 10px;
            }
            
            .table {
                font-size: 12px;
            }
            
            .table th, .table td {
                padding: 8px 6px;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 13px;
            }
            
            .stat-card .value {
                font-size: 24px;
            }
        }

        @media (max-width: 480px) {
            .login-box {
                padding: 30px 20px;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .content {
                padding: 15px;
            }
            
            .card {
                padding: 16px;
            }
            
            .table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            width: 100%;
            max-width: 400px;
        }

        .login-box h1 {
            color: #667eea;
            margin-bottom: 30px;
            text-align: center;
            font-size: 28px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 500;
        }

        .input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn:not(.btn-primary):not(.btn-danger):not(.btn-success) {
            background: #f3f4f6;
            color: #374151;
        }

        .btn:not(.btn-primary):not(.btn-danger):not(.btn-success):hover {
            background: #e5e7eb;
        }

        .app-container {
            display: none;
            min-height: 100vh;
            background: #f9fafb;
        }

        .header {
            background: white;
            padding: 20px 40px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .content {
            padding: 40px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e5e7eb;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            color: #667eea;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            text-align: left;
            padding: 12px;
            background: #f9fafb;
            color: #374151;
            font-weight: 600;
            border-bottom: 2px solid #e5e7eb;
        }

        .table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            color: #6b7280;
        }

        .table tr:hover {
            background: #f9fafb;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .stat-card .value {
            color: #1f2937;
            font-size: 32px;
            font-weight: 700;
        }

        .recording-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #fee2e2;
            border-radius: 8px;
            color: #991b1b;
            font-weight: 500;
        }

        .recording-dot {
            width: 8px;
            height: 8px;
            background: #dc2626;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .note-card {
            border-left: 4px solid #667eea;
            padding-left: 16px;
        }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h1>üè• ClinicalCanvas EHR</h1>
            <div id="loginForm">
                <div class="input-group">
                    <label>Username</label>
                    <input type="text" id="username" class="input" autocomplete="username">
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="password" class="input" autocomplete="current-password" onkeypress="if(event.key==='Enter') handleLogin()">
                </div>
                <button type="button" class="btn btn-primary" style="width: 100%;" onclick="handleLogin()">Login</button>
            </div>
            <p style="margin-top: 20px; text-align: center; color: #6b7280; font-size: 12px;">
                Demo credentials: <strong>admin</strong> / <strong>admin123</strong>
            </p>
        </div>
    </div>

    <!-- App Container -->
    <div id="appContainer" class="app-container">
        <div class="header">
            <h1>üè• ClinicalCanvas EHR</h1>
            <div class="user-info">
                <span id="userDisplay"></span>
                <button class="btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="content">
            <!-- Provider Tabs -->
            <div id="providerTabs" class="tabs" style="display: none;">
                <button class="tab-btn active" onclick="showTab('dashboard')">Dashboard</button>
                <button class="tab-btn" onclick="showTab('clients')">Clients</button>
                <button class="tab-btn" onclick="showTab('calendar')">Calendar</button>
                <button class="tab-btn" onclick="showTab('ainotes')">Clinical Notes</button>
                <button class="tab-btn" onclick="showTab('billing')">Billing</button>
                <button class="tab-btn" onclick="showTab('documents')">Documents</button>
                <button class="tab-btn" onclick="showTab('audit')">Audit Log</button>
            </div>

            <!-- Client Portal Tabs -->
            <div id="clientTabs" class="tabs" style="display: none;">
                <button class="tab-btn active" onclick="showClientTab('portal')">My Portal</button>
                <button class="tab-btn" onclick="showClientTab('appointments')">Appointments</button>
                <button class="tab-btn" onclick="showClientTab('documents')">Documents</button>
            </div>

            <!-- Dashboard -->
            <div id="dashboardContent" style="display: none;">
                <div class="grid">
                    <div class="stat-card">
                        <h3>Total Clients</h3>
                        <div class="value" id="totalClients">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Appointments Today</h3>
                        <div class="value" id="appointmentsToday">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Pending Documents</h3>
                        <div class="value" id="pendingDocs">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Clinical Notes</h3>
                        <div class="value" id="totalNotes">0</div>
                    </div>
                </div>
            </div>

            <!-- Clients -->
            <div id="clientsContent" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #1f2937;">Client Management</h2>
                    <button class="btn btn-primary" onclick="openAddClient()">Add Client</button>
                </div>
                <div class="card">
                    <div id="clientsList"></div>
                </div>
            </div>

            <!-- Calendar -->
            <div id="calendarContent" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #1f2937;">Calendar</h2>
                    <button class="btn btn-primary" onclick="openAddAppointment()">New Appointment</button>
                </div>
                <div class="card">
                    <div id="appointmentsList"></div>
                </div>
            </div>

            <!-- AI Notes -->
            <div id="ainotesContent" style="display: none;">
                <h2 style="color: #1f2937; margin-bottom: 20px;">Clinical Notes (DAP Format)</h2>
                
                <div class="card">
                    <h3 style="margin-bottom: 20px;">Create New Clinical Note</h3>
                    
                    <div class="input-group">
                        <label>Select Client</label>
                        <select id="noteClientSelect" class="input">
                            <option value="">Choose a client...</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label>Type Notes Manually</label>
                        <textarea id="manualNotes" class="input" rows="6" placeholder="Describe the session..."></textarea>
                    </div>

                    <button class="btn btn-primary" onclick="generateDAPNote()" id="generateBtn">
                        ‚ú® Generate DAP Note
                    </button>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Clinical Notes by Client</h3>
                        <select id="notesFilterClient" class="input" style="width: 250px;" onchange="renderAINotes()">
                            <option value="">All Clients</option>
                        </select>
                    </div>
                    <div id="recentNotesList"></div>
                </div>
            </div>

            <!-- Billing -->
            <div id="billingContent" style="display: none;">
                <h2 style="color: #1f2937; margin-bottom: 20px;">Billing & Invoicing</h2>
                
                <div class="grid" style="margin-bottom: 20px;">
                    <div class="stat-card">
                        <h3>Total Revenue</h3>
                        <div class="value" style="color: #10b981;" id="totalRevenue">$0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Outstanding</h3>
                        <div class="value" style="color: #f59e0b;" id="outstandingBalance">$0</div>
                    </div>
                    <div class="stat-card">
                        <h3>This Month</h3>
                        <div class="value" id="monthRevenue">$0</div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Invoices</h3>
                        <button class="btn btn-primary" onclick="openCreateInvoice()">Create Invoice</button>
                    </div>
                    <div id="invoicesList"></div>
                </div>
            </div>

            <!-- Documents -->
            <div id="documentsContent" style="display: none;">
                <h2 style="color: #1f2937; margin-bottom: 20px;">Clinical Documents</h2>
                
                <div class="card" style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">Document Templates</h3>
                    <div id="documentTemplatesList"></div>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Assigned Documents</h3>
                        <button class="btn btn-primary" onclick="openAssignModal()">Assign Documents</button>
                    </div>
                    <div id="assignedDocsList"></div>
                </div>
            </div>

            <!-- Audit Log -->
            <div id="auditContent" style="display: none;">
                <h2 style="color: #1f2937; margin-bottom: 20px;">HIPAA Audit Log</h2>
                
                <div class="card" style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="auditSearch" class="input" placeholder="Search audit logs..." style="flex: 1;" onkeyup="filterAuditLogs()">
                        <select id="auditActionFilter" class="input" style="width: 200px;" onchange="filterAuditLogs()">
                            <option value="">All Actions</option>
                            <option value="view">View</option>
                            <option value="create">Create</option>
                            <option value="update">Update</option>
                            <option value="delete">Delete</option>
                            <option value="login">Login</option>
                        </select>
                    </div>
                </div>

                <div class="card">
                    <div id="auditLogList"></div>
                </div>
            </div>

            <!-- Client Portal -->
            <div id="clientInfo" style="display: none;">
                <div class="card">
                    <h2 style="margin-bottom: 20px;">Welcome to Your Portal</h2>
                    <p style="color: #6b7280;">View your appointments and complete assigned documents using the tabs above.</p>
                </div>
            </div>

            <div id="clientAppointments" style="display: none;">
                <div class="card">
                    <h2 style="margin-bottom: 20px;">My Appointments</h2>
                    <div id="clientAppointmentsList"></div>
                </div>
            </div>

            <div id="clientPortalContent" style="display: none;">
                <div id="clientDocumentsContainer"></div>
            </div>
        </div>
    </div>

    <!-- Add Client Modal -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <h2 id="clientModalTitle" style="margin-bottom: 20px;">Add Client</h2>
            <form id="clientForm" onsubmit="saveClient(event)">
                <div class="input-group">
                    <label>Name</label>
                    <input type="text" id="clientName" class="input" required>
                </div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="clientEmail" class="input" required>
                </div>
                <div class="input-group">
                    <label>Phone</label>
                    <input type="tel" id="clientPhone" class="input" required>
                </div>
                <div class="input-group">
                    <label>Date of Birth</label>
                    <input type="date" id="clientDob" class="input" required>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeClientModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Appointment Modal -->
    <div id="appointmentModal" class="modal">
        <div class="modal-content">
            <h2 id="appointmentModalTitle" style="margin-bottom: 20px;">New Appointment</h2>
            <form id="appointmentForm" onsubmit="saveAppointment(event)">
                <div class="input-group">
                    <label>Client</label>
                    <select id="appointmentClient" class="input" required>
                        <option value="">Select a client...</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Date</label>
                    <input type="date" id="appointmentDate" class="input" required>
                </div>
                <div class="input-group">
                    <label>Time</label>
                    <input type="time" id="appointmentTime" class="input" required>
                </div>
                <div class="input-group">
                    <label>Duration (minutes)</label>
                    <input type="number" id="appointmentDuration" class="input" value="60" required>
                </div>
                <div class="input-group">
                    <label>Type</label>
                    <select id="appointmentType" class="input" required>
                        <option value="Initial Consultation">Initial Consultation</option>
                        <option value="Follow-up">Follow-up</option>
                        <option value="Therapy Session">Therapy Session</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Notes</label>
                    <textarea id="appointmentNotes" class="input" rows="3"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeAppointmentModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Note Modal -->
    <div id="viewNoteModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <h2 style="margin-bottom: 20px;">Clinical Note (DAP Format)</h2>
            <div id="viewNoteContent"></div>
            <div style="display: flex; justify-content: flex-end; margin-top: 20px; gap: 10px;">
                <button class="btn btn-danger" onclick="deleteNote()">Delete Note</button>
                <button class="btn" onclick="closeViewNoteModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Create Invoice Modal -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <h2 style="margin-bottom: 20px;">Create Invoice</h2>
            <form id="invoiceForm" onsubmit="saveInvoice(event)">
                <div class="input-group">
                    <label>Client</label>
                    <select id="invoiceClient" class="input" required>
                        <option value="">Select a client...</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Invoice Date</label>
                    <input type="date" id="invoiceDate" class="input" required>
                </div>
                <div class="input-group">
                    <label>Due Date</label>
                    <input type="date" id="invoiceDueDate" class="input" required>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 500;">Line Items</label>
                    <div id="invoiceLineItems">
                        <div class="invoice-line-item" style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" class="input item-description" placeholder="Description" style="flex: 2;" required>
                            <input type="number" class="input item-quantity" placeholder="Qty" style="width: 80px;" value="1" min="1" required>
                            <input type="number" class="input item-rate" placeholder="Rate" style="width: 120px;" step="0.01" min="0" required>
                        </div>
                    </div>
                    <button type="button" class="btn" onclick="addInvoiceLineItem()">+ Add Line Item</button>
                </div>
                <div class="input-group">
                    <label>Notes</label>
                    <textarea id="invoiceNotes" class="input" rows="3"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeInvoiceModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Invoice</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Invoice Modal -->
    <div id="viewInvoiceModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <h2 style="margin-bottom: 20px;">Invoice Details</h2>
            <div id="viewInvoiceContent"></div>
            <div style="display: flex; justify-content: flex-end; margin-top: 20px; gap: 10px;">
                <button class="btn btn-danger" onclick="deleteInvoice()">Delete Invoice</button>
                <button class="btn btn-success" onclick="markInvoicePaid()" id="markPaidBtn">Mark as Paid</button>
                <button class="btn" onclick="closeViewInvoiceModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Assign Documents Modal -->
    <div id="assignModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <h2 style="margin-bottom: 20px;">Assign Documents</h2>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Select Client</label>
                <select id="assignClientSelect" class="input">
                    <option value="">Choose a client...</option>
                </select>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 500;">Select Documents</label>
                <div id="documentCheckboxList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px;">
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn" onclick="closeAssignModal()">Cancel</button>
                <button class="btn btn-primary" onclick="assignDocuments()">Assign Selected</button>
            </div>
        </div>
    </div>

    <!-- Document Form Modal (Client) -->
    <div id="documentFormModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <h2 id="documentFormTitle" style="margin-bottom: 20px;"></h2>
            
            <div id="documentFormFields" style="margin-bottom: 30px;"></div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 500; color: #374151;">Your Signature</label>
                <canvas id="signatureCanvas" width="600" height="200" style="border: 2px solid #e5e7eb; border-radius: 8px; cursor: crosshair; display: block; max-width: 100%;"></canvas>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <button class="btn" onclick="clearSignature()">Clear Signature</button>
                    <span id="signatureTimestamp" style="color: #6b7280; font-size: 12px;"></span>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn" onclick="closeDocumentForm()">Cancel</button>
                <button id="documentFormSubmit" class="btn btn-primary">Submit Document</button>
            </div>
        </div>
    </div>

    <!-- View Completed Document Modal -->
    <div id="viewDocModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <h2 id="viewDocTitle" style="margin-bottom: 20px;"></h2>
            <div id="viewDocContent"></div>
            
            <!-- Clinician Signature Section -->
            <div id="clinicianSignatureSection" style="display: none; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                <h3 style="color: #374151; margin-bottom: 15px;">Clinician Review & Signature</h3>
                <p style="color: #6b7280; margin-bottom: 15px; font-size: 14px;">Please sign below to acknowledge review of this completed document:</p>
                <canvas id="clinicianSignatureCanvas" width="600" height="150" style="border: 2px solid #e5e7eb; border-radius: 8px; cursor: crosshair; display: block; max-width: 100%; margin-bottom: 10px;"></canvas>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <button class="btn" onclick="clearClinicianSignature()">Clear Signature</button>
                    <span id="clinicianSignatureTimestamp" style="color: #6b7280; font-size: 12px;"></span>
                </div>
                <button class="btn btn-primary" onclick="saveClinicianSignature()">Save Review Signature</button>
            </div>
            
            <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                <button class="btn" onclick="closeViewDocModal()">Close</button>
            </div>
        </div>
    </div>

<script>
console.log('ClinicalCanvas EHR - Full version loaded');

// Mock Database - RESTORED FROM ORIGINAL
let users = [
    { id: 1, username: 'admin', password: 'admin123', role: 'provider', name: 'Dr. Smith' },
    { id: 2, username: 'john.doe@email.com', password: 'password123', role: 'client', name: 'John Doe' }
];

let allClients = [
    { id: 2, name: 'John Doe', email: 'john.doe@email.com', phone: '555-0101', dob: '1990-05-15' },
    { id: 3, name: 'Jane Smith', email: 'jane.smith@email.com', phone: '555-0102', dob: '1985-08-22' }
];

let appointments = [
    { id: 1, clientId: 2, clientName: 'John Doe', date: '2025-10-10', time: '10:00', duration: 60, type: 'Initial Consultation', notes: 'First session', location: 'Office A', status: 'scheduled' },
    { id: 2, clientId: 3, clientName: 'Jane Smith', date: '2025-10-10', time: '14:00', duration: 60, type: 'Follow-up', notes: '', location: 'Office B', status: 'scheduled' }
];

// UPDATED: Document Templates with ONLY working intake forms
let documentTemplates = [
    {
        id: 2,
        name: 'ACE Questionnaire (Complete)',
        description: 'Adverse Childhood Experiences - Full 10 Question Assessment',
        fields: [
            { id: 'ace_intro', label: 'Prior to your 18th birthday:', type: 'info' },
            { id: 'ace_1', label: '1. Did a parent or other adult in the household often swear at you, insult you, put you down, or humiliate you? OR Act in a way that made you afraid that you might be physically hurt?', type: 'radio', options: ['Yes', 'No'] },
            { id: 'ace_2', label: '2. Did a parent or other adult in the household often push, grab, slap, or throw something at you? OR Ever hit you so hard that you had marks or were injured?', type: 'radio', options: ['Yes', 'No'] },
            { id: 'ace_3', label: '3. Did an adult or person at least 5 years older than you ever touch or fondle you or have you touch their body in a sexual way? OR Attempt or actually have oral, anal, or vaginal intercourse with you?', type: 'radio', options: ['Yes', 'No'] },
            { id: 'ace_4', label: '4. Did you often or very often feel that no one in your family loved you or thought you were important or special? OR Your family didn\'t look out for each other, feel close to each other, or support each other?', type: 'radio', options: ['Yes', 'No'] },
            { id: 'ace_5', label: '5. Did you often or very often feel that you didn\'t have enough to eat, had to wear dirty clothes, and had no one to protect you? OR Your parents were too drunk or high to take care of you or take you to the doctor if you needed it?', type: 'radio', options: ['Yes', 'No'] },
            { id: 'ace_6', label: '6. Were your parents ever separated or divorced?', type: 'radio', options: ['Yes', 'No'] },
            { id: 'ace_7', label: '7. Was your mother or stepmother often or very often pushed, grabbed, slapped, or had something thrown at her? OR Sometimes, often, or very often kicked, bitten, hit with a fist, or hit with something hard? OR Ever repeatedly hit over at least a few minutes or threatened with a gun or knife?', type: 'radio', options: ['Yes', 'No'] },
            { id: 'ace_8', label: '8. Did you live with anyone who was a problem drinker or alcoholic, or who used street drugs?', type: 'radio', options: ['Yes', 'No'] },
            { id: 'ace_9', label: '9. Was a household member depressed or mentally ill, or did a household member attempt suicide?', type: 'radio', options: ['Yes', 'No'] },
            { id: 'ace_10', label: '10. Did a household member go to prison?', type: 'radio', options: ['Yes', 'No'] }
        ]
    },
    {
        id: 3,
        name: 'DAST-10 (Complete)',
        description: 'Drug Abuse Screening Test - Full 10 Questions',
        fields: [
            { id: 'dast_intro', label: 'The following questions concern information about your potential involvement with drugs not including alcoholic beverages during the past 12 months. Please answer every question.', type: 'info' },
            { id: 'dast_1', label: '1. Have you used drugs other than those required for medical reasons?', type: 'radio', options: ['Yes', 'No'] },
            { id: 'dast_2', label: '2. Do you abuse more than one drug at a time?', type: 'radio', options: ['Yes', 'No'] },
            { id: 'dast_3', label: '3. Are you unable to stop using drugs when you want to?', type: 'radio', options: ['Yes', 'No'] },
            { id: 'dast_4', label: '4. Have you ever had blackouts or flashbacks as a result of drug use?', type: 'radio', options: ['Yes', 'No'] },
            { id: 'dast_5', label: '5. Do you ever feel bad or guilty about your drug use?', type: 'radio', options: ['Yes', 'No'] },
            { id: 'dast_6', label: '6. Does your spouse (or parents) ever complain about your involvement with drugs?', type: 'radio', options: ['Yes', 'No'] },
            { id: 'dast_7', label: '7. Have you neglected your family because of your use of drugs?', type: 'radio', options: ['Yes', 'No'] },
            { id: 'dast_8', label: '8. Have you engaged in illegal activities in order to obtain drugs?', type: 'radio', options: ['Yes', 'No'] },
            { id: 'dast_9', label: '9. Have you ever experienced withdrawal symptoms (felt sick) when you stopped taking drugs?', type: 'radio', options: ['Yes', 'No'] },
            { id: 'dast_10', label: '10. Have you had medical problems as a result of your drug use (e.g., memory loss, hepatitis, convulsions, bleeding, etc.)?', type: 'radio', options: ['Yes', 'No'] }
        ]
    },
    {
        id: 4,
        name: 'AUDIT Screening',
        description: 'Alcohol Use Disorders Identification Test',
        fields: [
            { id: 'audit_intro', label: 'Please answer the following questions about your alcohol use:', type: 'info' },
            { id: 'audit_1', label: '1. How often do you have a drink containing alcohol?', type: 'radio', options: ['Never', 'Monthly or less', '2-4 times a month', '2-3 times a week', '4 or more times a week'] },
            { id: 'audit_2', label: '2. How many drinks containing alcohol do you have on a typical day when you are drinking?', type: 'radio', options: ['1 or 2', '3 or 4', '5 or 6', '7 to 9', '10 or more'] },
            { id: 'audit_3', label: '3. How often do you have six or more drinks on one occasion?', type: 'radio', options: ['Never', 'Less than monthly', 'Monthly', 'Weekly', 'Daily or almost daily'] },
            { id: 'audit_4', label: '4. How often during the last year have you found that you were not able to stop drinking once you had started?', type: 'radio', options: ['Never', 'Less than monthly', 'Monthly', 'Weekly', 'Daily or almost daily'] },
            { id: 'audit_5', label: '5. How often during the last year have you failed to do what was normally expected of you because of drinking?', type: 'radio', options: ['Never', 'Less than monthly', 'Monthly', 'Weekly', 'Daily or almost daily'] }
        ]
    }
];

let assignedDocs = JSON.parse(localStorage.getItem('assignedDocs') || '[]');
let clinicalNotes = JSON.parse(localStorage.getItem('clinicalNotes') || '[]');
let auditLog = JSON.parse(localStorage.getItem('auditLog') || '[]');
let invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
let payments = JSON.parse(localStorage.getItem('payments') || '[]');

let selectedDocs = new Set();
let authToken = localStorage.getItem('authToken');
let userRole = localStorage.getItem('userRole');
let currentUser = null;
let editingClientId = null;
let editingAppointmentId = null;
let currentNoteId = null;
let currentInvoiceId = null;
let currentViewingDocId = null;

// Signature variables
let isDrawing = false;
let lastX = 0;
let lastY = 0;
let signatureTime = null;
let clinicianSignatureTime = null;
let isClinicianDrawing = false;
let clinicianLastX = 0;
let clinicianLastY = 0;

// Audit logging function
function logAudit(action, resource, details = '') {
    const entry = {
        id: Date.now(),
        timestamp: new Date().toISOString(),
        user: localStorage.getItem('userName'),
        userId: localStorage.getItem('userId'),
        action,
        resource,
        details
    };
    auditLog.unshift(entry);
    localStorage.setItem('auditLog', JSON.stringify(auditLog));
}

// Auth Functions
function handleLogin() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    
    const user = users.find(u => u.username === username && u.password === password);
    
    if (user) {
        authToken = 'token_' + Date.now();
        userRole = user.role;
        currentUser = user;
        localStorage.setItem('authToken', authToken);
        localStorage.setItem('userRole', userRole);
        localStorage.setItem('userId', user.id);
        localStorage.setItem('userName', user.name);
        
        logAudit('login', 'System', 'User logged in');
        
        showApp();
    } else {
        alert('Invalid credentials');
    }
}

function logout() {
    logAudit('logout', 'System', `User logged out`);
    
    localStorage.removeItem('authToken');
    localStorage.removeItem('userRole');
    localStorage.removeItem('userId');
    localStorage.removeItem('userName');
    authToken = null;
    userRole = null;
    currentUser = null;
    showAuth();
}

function showAuth() {
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('appContainer').style.display = 'none';
}

function showApp() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appContainer').style.display = 'block';
    document.getElementById('userDisplay').textContent = localStorage.getItem('userName');
    
    if (userRole === 'provider') {
        document.getElementById('providerTabs').style.display = 'flex';
        document.getElementById('clientTabs').style.display = 'none';
        showTab('dashboard');
    } else {
        document.getElementById('providerTabs').style.display = 'none';
        document.getElementById('clientTabs').style.display = 'flex';
        showClientTab('portal');
    }
}

// Tab Functions
function showTab(tab) {
    document.querySelectorAll('#providerTabs .tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    document.getElementById('dashboardContent').style.display = 'none';
    document.getElementById('clientsContent').style.display = 'none';
    document.getElementById('calendarContent').style.display = 'none';
    document.getElementById('ainotesContent').style.display = 'none';
    document.getElementById('billingContent').style.display = 'none';
    document.getElementById('documentsContent').style.display = 'none';
    document.getElementById('auditContent').style.display = 'none';
    document.getElementById('clientInfo').style.display = 'none';
    document.getElementById('clientAppointments').style.display = 'none';
    document.getElementById('clientPortalContent').style.display = 'none';
    
    if (tab === 'dashboard') {
        document.getElementById('dashboardContent').style.display = 'block';
        updateDashboard();
    } else if (tab === 'clients') {
        document.getElementById('clientsContent').style.display = 'block';
        renderClients();
    } else if (tab === 'calendar') {
        document.getElementById('calendarContent').style.display = 'block';
        renderAppointments();
    } else if (tab === 'ainotes') {
        document.getElementById('ainotesContent').style.display = 'block';
        renderAINotes();
    } else if (tab === 'billing') {
        document.getElementById('billingContent').style.display = 'block';
        renderBilling();
    } else if (tab === 'documents') {
        document.getElementById('documentsContent').style.display = 'block';
        renderDocumentTemplates();
        renderAssignedDocs();
    } else if (tab === 'audit') {
        document.getElementById('auditContent').style.display = 'block';
        renderAuditLog();
    }
}

function showClientTab(tab) {
    document.querySelectorAll('#clientTabs .tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    document.getElementById('clientInfo').style.display = 'none';
    document.getElementById('clientAppointments').style.display = 'none';
    document.getElementById('clientPortalContent').style.display = 'none';
    document.getElementById('dashboardContent').style.display = 'none';
    document.getElementById('clientsContent').style.display = 'none';
    document.getElementById('calendarContent').style.display = 'none';
    document.getElementById('ainotesContent').style.display = 'none';
    document.getElementById('billingContent').style.display = 'none';
    document.getElementById('documentsContent').style.display = 'none';
    document.getElementById('auditContent').style.display = 'none';
    
    if (tab === 'portal') {
        document.getElementById('clientInfo').style.display = 'block';
    } else if (tab === 'appointments') {
        document.getElementById('clientAppointments').style.display = 'block';
        loadClientAppointments();
    } else if (tab === 'documents') {
        document.getElementById('clientPortalContent').style.display = 'block';
        showClientDocuments();
    }
}

// Dashboard Functions
function updateDashboard() {
    document.getElementById('totalClients').textContent = allClients.length;
    
    const today = new Date().toISOString().split('T')[0];
    const todayAppts = appointments.filter(a => a.date === today).length;
    document.getElementById('appointmentsToday').textContent = todayAppts;
    
    const pending = assignedDocs.filter(d => d.status === 'pending').length;
    document.getElementById('pendingDocs').textContent = pending;
    
    document.getElementById('totalNotes').textContent = clinicalNotes.length;
}

// Client Management Functions
function renderClients() {
    const container = document.getElementById('clientsList');
    
    if (allClients.length === 0) {
        container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No clients yet</p>';
        return;
    }
    
    container.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>DOB</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                ${allClients.map(client => `
                    <tr>
                        <td>${client.name}</td>
                        <td>${client.email}</td>
                        <td>${client.phone}</td>
                        <td>${new Date(client.dob).toLocaleDateString()}</td>
                        <td>
                            <button class="btn" style="padding: 6px 12px; font-size: 12px; margin-right: 5px;" onclick="editClient(${client.id})">Edit</button>
                            <button class="btn" style="padding: 6px 12px; font-size: 12px;" onclick="deleteClient(${client.id})">Delete</button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    
    logAudit('view', 'Client List', `Viewed client list`);
}

function openAddClient() {
    editingClientId = null;
    document.getElementById('clientModalTitle').textContent = 'Add Client';
    document.getElementById('clientForm').reset();
    document.getElementById('clientModal').classList.add('active');
}

function editClient(id) {
    editingClientId = id;
    const client = allClients.find(c => c.id === id);
    
    logAudit('view', 'Client Record', `Viewed client: ${client.name}`);
    
    document.getElementById('clientModalTitle').textContent = 'Edit Client';
    document.getElementById('clientName').value = client.name;
    document.getElementById('clientEmail').value = client.email;
    document.getElementById('clientPhone').value = client.phone;
    document.getElementById('clientDob').value = client.dob;
    
    document.getElementById('clientModal').classList.add('active');
}

function closeClientModal() {
    document.getElementById('clientModal').classList.remove('active');
    editingClientId = null;
}

function saveClient(e) {
    e.preventDefault();
    
    const clientData = {
        name: document.getElementById('clientName').value,
        email: document.getElementById('clientEmail').value,
        phone: document.getElementById('clientPhone').value,
        dob: document.getElementById('clientDob').value
    };
    
    if (editingClientId) {
        const index = allClients.findIndex(c => c.id === editingClientId);
        allClients[index] = { ...allClients[index], ...clientData };
        logAudit('update', 'Client Record', `Updated client: ${clientData.name}`);
    } else {
        clientData.id = Date.now();
        allClients.push(clientData);
        
        users.push({
            id: Date.now() + 1,
            username: clientData.email,
            password: 'password123',
            role: 'client',
            name: clientData.name
        });
        
        logAudit('create', 'Client Record', `Created new client: ${clientData.name}`);
    }
    
    closeClientModal();
    renderClients();
    updateDashboard();
}

function deleteClient(id) {
    if (confirm('Are you sure you want to delete this client?')) {
        const client = allClients.find(c => c.id === id);
        allClients = allClients.filter(c => c.id !== id);
        
        logAudit('delete', 'Client Record', `Deleted client: ${client.name}`);
        
        renderClients();
        updateDashboard();
    }
}

// Calendar Functions
function renderAppointments() {
    const container = document.getElementById('appointmentsList');
    
    if (appointments.length === 0) {
        container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No appointments scheduled</p>';
        return;
    }
    
    container.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>Client</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Type</th>
                    <th>Duration</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                ${appointments.map(apt => `
                    <tr>
                        <td>${apt.clientName}</td>
                        <td>${new Date(apt.date).toLocaleDateString()}</td>
                        <td>${apt.time}</td>
                        <td><span class="badge badge-info">${apt.type}</span></td>
                        <td>${apt.duration} min</td>
                        <td>
                            <button class="btn" style="padding: 6px 12px; font-size: 12px; margin-right: 5px;" onclick="editAppointment(${apt.id})">Edit</button>
                            <button class="btn" style="padding: 6px 12px; font-size: 12px;" onclick="deleteAppointment(${apt.id})">Delete</button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    
    logAudit('view', 'Appointment List', `Viewed appointment calendar`);
}

function openAddAppointment() {
    editingAppointmentId = null;
    document.getElementById('appointmentModalTitle').textContent = 'New Appointment';
    document.getElementById('appointmentForm').reset();
    
    const clientSelect = document.getElementById('appointmentClient');
    clientSelect.innerHTML = '<option value="">Select a client...</option>' + 
        allClients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    
    document.getElementById('appointmentModal').classList.add('active');
}

function editAppointment(id) {
    editingAppointmentId = id;
    const apt = appointments.find(a => a.id === id);
    
    logAudit('view', 'Appointment', `Viewed appointment for ${apt.clientName}`);
    
    document.getElementById('appointmentModalTitle').textContent = 'Edit Appointment';
    
    const clientSelect = document.getElementById('appointmentClient');
    clientSelect.innerHTML = '<option value="">Select a client...</option>' + 
        allClients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    
    document.getElementById('appointmentClient').value = apt.clientId;
    document.getElementById('appointmentDate').value = apt.date;
    document.getElementById('appointmentTime').value = apt.time;
    document.getElementById('appointmentDuration').value = apt.duration;
    document.getElementById('appointmentType').value = apt.type;
    document.getElementById('appointmentNotes').value = apt.notes || '';
    
    document.getElementById('appointmentModal').classList.add('active');
}

function closeAppointmentModal() {
    document.getElementById('appointmentModal').classList.remove('active');
    editingAppointmentId = null;
}

function saveAppointment(e) {
    e.preventDefault();
    
    const clientId = parseInt(document.getElementById('appointmentClient').value);
    const client = allClients.find(c => c.id === clientId);
    
    const aptData = {
        clientId,
        clientName: client.name,
        date: document.getElementById('appointmentDate').value,
        time: document.getElementById('appointmentTime').value,
        duration: parseInt(document.getElementById('appointmentDuration').value),
        type: document.getElementById('appointmentType').value,
        notes: document.getElementById('appointmentNotes').value,
        location: 'Office A',
        status: 'scheduled'
    };
    
    if (editingAppointmentId) {
        const index = appointments.findIndex(a => a.id === editingAppointmentId);
        appointments[index] = { ...appointments[index], ...aptData };
        logAudit('update', 'Appointment', `Updated appointment for ${client.name}`);
    } else {
        aptData.id = Date.now();
        appointments.push(aptData);
        logAudit('create', 'Appointment', `Created appointment for ${client.name}`);
    }
    
    closeAppointmentModal();
    renderAppointments();
    updateDashboard();
}

function deleteAppointment(id) {
    if (confirm('Are you sure you want to delete this appointment?')) {
        const apt = appointments.find(a => a.id === id);
        appointments = appointments.filter(a => a.id !== id);
        
        logAudit('delete', 'Appointment', `Deleted appointment for ${apt.clientName}`);
        
        renderAppointments();
        updateDashboard();
    }
}

function loadClientAppointments() {
    const userId = parseInt(localStorage.getItem('userId'));
    const userAppts = appointments.filter(a => a.clientId === userId);
    
    const container = document.getElementById('clientAppointmentsList');
    
    if (userAppts.length === 0) {
        container.innerHTML = '<p style="color: #6b7280;">No appointments scheduled</p>';
        return;
    }
    
    container.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Type</th>
                    <th>Duration</th>
                </tr>
            </thead>
            <tbody>
                ${userAppts.map(apt => `
                    <tr>
                        <td>${new Date(apt.date).toLocaleDateString()}</td>
                        <td>${apt.time}</td>
                        <td><span class="badge badge-info">${apt.type}</span></td>
                        <td>${apt.duration} min</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

// AI Notes Functions
function renderAINotes() {
    const clientSelect = document.getElementById('noteClientSelect');
    clientSelect.innerHTML = '<option value="">Choose a client...</option>' + 
        allClients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    
    const filterSelect = document.getElementById('notesFilterClient');
    filterSelect.innerHTML = '<option value="">All Clients</option>' + 
        allClients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    
    const filterClientId = filterSelect.value;
    let filteredNotes = clinicalNotes;
    if (filterClientId) {
        filteredNotes = clinicalNotes.filter(n => n.clientId === parseInt(filterClientId));
    }
    
    const container = document.getElementById('recentNotesList');
    
    if (filteredNotes.length === 0) {
        container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No clinical notes yet</p>';
        return;
    }
    
    container.innerHTML = filteredNotes.map(note => `
        <div class="card note-card" style="margin-bottom: 15px; cursor: pointer;" onclick="viewNote(${note.id})">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                <div>
                    <h4 style="color: #1f2937; margin-bottom: 5px;">${note.clientName}</h4>
                    <p style="color: #6b7280; font-size: 12px;">${new Date(note.createdAt).toLocaleString()}</p>
                </div>
                <span class="badge badge-info">${note.type || 'Session Note'}</span>
            </div>
            <p style="color: #6b7280; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                ${note.dap.data.substring(0, 100)}...
            </p>
        </div>
    `).join('');
}

async function generateDAPNote() {
    const clientId = parseInt(document.getElementById('noteClientSelect').value);
    const manualNotes = document.getElementById('manualNotes').value.trim();
    
    if (!clientId) {
        alert('Please select a client');
        return;
    }
    
    if (!manualNotes) {
        alert('Please type manual notes');
        return;
    }
    
    const generateBtn = document.getElementById('generateBtn');
    generateBtn.disabled = true;
    generateBtn.textContent = '‚è≥ Processing...';
    
    try {
        const dapNote = await generateDAPFromNotes(manualNotes);
        
        const client = allClients.find(c => c.id === clientId);
        const note = {
            id: Date.now(),
            clientId,
            clientName: client.name,
            createdAt: new Date().toISOString(),
            rawNotes: manualNotes,
            dap: dapNote,
            type: 'Session Note'
        };
        
        clinicalNotes.unshift(note);
        localStorage.setItem('clinicalNotes', JSON.stringify(clinicalNotes));
        
        logAudit('create', 'Clinical Note', `Created DAP note for ${client.name}`);
        
        document.getElementById('noteClientSelect').value = '';
        document.getElementById('manualNotes').value = '';
        
        renderAINotes();
        updateDashboard();
        
        viewNote(note.id);
        
        alert('DAP note generated successfully!');
        
    } catch (error) {
        console.error('Error generating note:', error);
        alert('Error generating DAP note. Please try again.');
    } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = '‚ú® Generate DAP Note';
    }
}

async function generateDAPFromNotes(notes) {
    try {
        const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                model: "claude-sonnet-4-20250514",
                max_tokens: 2000,
                messages: [
                    { 
                        role: "user", 
                        content: `You are a clinical documentation assistant. Convert the following session notes into a structured DAP (Data, Assessment, Plan) format for a clinical record.

Session Notes:
${notes}

Respond ONLY with valid JSON in this exact format:
{
  "data": "Observable behaviors, client statements, and factual information from the session",
  "assessment": "Clinical impressions, diagnostic considerations, progress evaluation",
  "plan": "Treatment goals, planned interventions, and next steps"
}

Remember: Output ONLY the JSON object, nothing else.`
                    }
                ]
            })
        });
        
        const data = await response.json();
        let responseText = data.content[0].text;
        
        responseText = responseText.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
        
        const dapNote = JSON.parse(responseText);
        return dapNote;
        
    } catch (error) {
        console.error('Error calling Claude API:', error);
        return {
            data: notes,
            assessment: "Client appeared engaged and cooperative during session.",
            plan: "Schedule follow-up session. Continue current interventions."
        };
    }
}

function viewNote(noteId) {
    currentNoteId = noteId;
    const note = clinicalNotes.find(n => n.id === noteId);
    
    logAudit('view', 'Clinical Note', `Viewed DAP note for ${note.clientName}`);
    
    const modal = document.getElementById('viewNoteModal');
    document.getElementById('viewNoteContent').innerHTML = `
        <div style="margin-bottom: 20px;">
            <strong style="color: #374151;">Client:</strong>
            <p style="color: #6b7280; margin-top: 5px;">${note.clientName}</p>
        </div>
        
        <div style="margin-bottom: 20px;">
            <strong style="color: #374151;">Date:</strong>
            <p style="color: #6b7280; margin-top: 5px;">${new Date(note.createdAt).toLocaleString()}</p>
        </div>
        
        <div style="margin-bottom: 20px; padding: 15px; background: #f9fafb; border-radius: 8px;">
            <strong style="color: #374151; display: block; margin-bottom: 10px;">D - Data</strong>
            <p style="color: #6b7280; line-height: 1.6; white-space: pre-wrap;">${note.dap.data}</p>
        </div>
        
        <div style="margin-bottom: 20px; padding: 15px; background: #f9fafb; border-radius: 8px;">
            <strong style="color: #374151; display: block; margin-bottom: 10px;">A - Assessment</strong>
            <p style="color: #6b7280; line-height: 1.6; white-space: pre-wrap;">${note.dap.assessment}</p>
        </div>
        
        <div style="padding: 15px; background: #f9fafb; border-radius: 8px;">
            <strong style="color: #374151; display: block; margin-bottom: 10px;">P - Plan</strong>
            <p style="color: #6b7280; line-height: 1.6; white-space: pre-wrap;">${note.dap.plan}</p>
        </div>
    `;
    
    modal.classList.add('active');
}

function closeViewNoteModal() {
    document.getElementById('viewNoteModal').classList.remove('active');
    currentNoteId = null;
}

function deleteNote() {
    if (confirm('Are you sure you want to delete this clinical note?')) {
        const note = clinicalNotes.find(n => n.id === currentNoteId);
        clinicalNotes = clinicalNotes.filter(n => n.id !== currentNoteId);
        localStorage.setItem('clinicalNotes', JSON.stringify(clinicalNotes));
        
        logAudit('delete', 'Clinical Note', `Deleted note for ${note.clientName}`);
        
        closeViewNoteModal();
        renderAINotes();
        updateDashboard();
    }
}

// Billing Functions
function renderBilling() {
    const totalRevenue = invoices.reduce((sum, inv) => sum + (inv.status === 'paid' ? inv.total : 0), 0);
    const outstanding = invoices.reduce((sum, inv) => sum + (inv.status === 'unpaid' ? inv.total : 0), 0);
    
    const now = new Date();
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    const monthRevenue = invoices.reduce((sum, inv) => {
        const invDate = new Date(inv.date);
        return sum + (inv.status === 'paid' && invDate >= monthStart ? inv.total : 0);
    }, 0);
    
    document.getElementById('totalRevenue').textContent = `$${totalRevenue.toFixed(2)}`;
    document.getElementById('outstandingBalance').textContent = `$${outstanding.toFixed(2)}`;
    document.getElementById('monthRevenue').textContent = `$${monthRevenue.toFixed(2)}`;
    
    renderInvoicesList();
}

function renderInvoicesList() {
    const container = document.getElementById('invoicesList');
    
    if (invoices.length === 0) {
        container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No invoices yet</p>';
        return;
    }
    
    container.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>Invoice #</th>
                    <th>Client</th>
                    <th>Date</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                ${invoices.map(inv => `
                    <tr>
                        <td>#${inv.id}</td>
                        <td>${inv.clientName}</td>
                        <td>${new Date(inv.date).toLocaleDateString()}</td>
                        <td>$${inv.total.toFixed(2)}</td>
                        <td><span class="badge badge-${inv.status === 'paid' ? 'success' : 'warning'}">${inv.status}</span></td>
                        <td>
                            <button class="btn" style="padding: 6px 12px; font-size: 12px;" onclick="viewInvoice(${inv.id})">View</button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

function openCreateInvoice() {
    const clientSelect = document.getElementById('invoiceClient');
    clientSelect.innerHTML = '<option value="">Select a client...</option>' + 
        allClients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    
    const today = new Date().toISOString().split('T')[0];
    const dueDate = new Date();
    dueDate.setDate(dueDate.getDate() + 30);
    
    document.getElementById('invoiceDate').value = today;
    document.getElementById('invoiceDueDate').value = dueDate.toISOString().split('T')[0];
    
    document.getElementById('invoiceLineItems').innerHTML = `
        <div class="invoice-line-item" style="display: flex; gap: 10px; margin-bottom: 10px;">
            <input type="text" class="input item-description" placeholder="Description" style="flex: 2;" required>
            <input type="number" class="input item-quantity" placeholder="Qty" style="width: 80px;" value="1" min="1" required>
            <input type="number" class="input item-rate" placeholder="Rate" style="width: 120px;" step="0.01" min="0" required>
        </div>
    `;
    
    document.getElementById('invoiceNotes').value = '';
    document.getElementById('invoiceModal').classList.add('active');
}

function addInvoiceLineItem() {
    const container = document.getElementById('invoiceLineItems');
    const newItem = document.createElement('div');
    newItem.className = 'invoice-line-item';
    newItem.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px;';
    newItem.innerHTML = `
        <input type="text" class="input item-description" placeholder="Description" style="flex: 2;" required>
        <input type="number" class="input item-quantity" placeholder="Qty" style="width: 80px;" value="1" min="1" required>
        <input type="number" class="input item-rate" placeholder="Rate" style="width: 120px;" step="0.01" min="0" required>
        <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()" style="padding: 6px 12px;">‚úï</button>
    `;
    container.appendChild(newItem);
}

function closeInvoiceModal() {
    document.getElementById('invoiceModal').classList.remove('active');
}

function saveInvoice(e) {
    e.preventDefault();
    
    const clientId = parseInt(document.getElementById('invoiceClient').value);
    const client = allClients.find(c => c.id === clientId);
    
    const lineItems = Array.from(document.querySelectorAll('.invoice-line-item')).map(item => {
        const description = item.querySelector('.item-description').value;
        const quantity = parseInt(item.querySelector('.item-quantity').value);
        const rate = parseFloat(item.querySelector('.item-rate').value);
        return {
            description,
            quantity,
            rate,
            amount: quantity * rate
        };
    });
    
    const total = lineItems.reduce((sum, item) => sum + item.amount, 0);
    
    const invoice = {
        id: Date.now(),
        clientId,
        clientName: client.name,
        date: document.getElementById('invoiceDate').value,
        dueDate: document.getElementById('invoiceDueDate').value,
        lineItems,
        total,
        status: 'unpaid',
        notes: document.getElementById('invoiceNotes').value
    };
    
    invoices.unshift(invoice);
    localStorage.setItem('invoices', JSON.stringify(invoices));
    
    logAudit('create', 'Invoice', `Created invoice for ${client.name} - $${total.toFixed(2)}`);
    
    closeInvoiceModal();
    renderBilling();
    alert('Invoice created successfully!');
}

function viewInvoice(invoiceId) {
    currentInvoiceId = invoiceId;
    const invoice = invoices.find(inv => inv.id === invoiceId);
    
    logAudit('view', 'Invoice', `Viewed invoice #${invoice.id} for ${invoice.clientName}`);
    
    const modal = document.getElementById('viewInvoiceModal');
    
    const markPaidBtn = document.getElementById('markPaidBtn');
    if (invoice.status === 'paid') {
        markPaidBtn.style.display = 'none';
    } else {
        markPaidBtn.style.display = 'inline-block';
    }
    
    document.getElementById('viewInvoiceContent').innerHTML = `
        <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
            <div>
                <h3 style="color: #1f2937; margin-bottom: 10px;">Invoice #${invoice.id}</h3>
                <p style="color: #6b7280;">Client: ${invoice.clientName}</p>
            </div>
            <div style="text-align: right;">
                <span class="badge badge-${invoice.status === 'paid' ? 'success' : 'warning'}" style="font-size: 14px; padding: 8px 16px;">${invoice.status.toUpperCase()}</span>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
            <div>
                <strong style="color: #374151; display: block; margin-bottom: 5px;">Invoice Date</strong>
                <p style="color: #6b7280;">${new Date(invoice.date).toLocaleDateString()}</p>
            </div>
            <div>
                <strong style="color: #374151; display: block; margin-bottom: 5px;">Due Date</strong>
                <p style="color: #6b7280;">${new Date(invoice.dueDate).toLocaleDateString()}</p>
            </div>
        </div>
        
        <table class="table" style="margin-bottom: 20px;">
            <thead>
                <tr>
                    <th>Description</th>
                    <th>Qty</th>
                    <th>Rate</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody>
                ${invoice.lineItems.map(item => `
                    <tr>
                        <td>${item.description}</td>
                        <td>${item.quantity}</td>
                        <td>$${item.rate.toFixed(2)}</td>
                        <td>$${item.amount.toFixed(2)}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        
        <div style="text-align: right; padding: 20px; background: #f9fafb; border-radius: 8px;">
            <h3 style="color: #1f2937;">Total: $${invoice.total.toFixed(2)}</h3>
        </div>
    `;
    
    modal.classList.add('active');
}

function closeViewInvoiceModal() {
    document.getElementById('viewInvoiceModal').classList.remove('active');
    currentInvoiceId = null;
}

function markInvoicePaid() {
    if (confirm('Mark this invoice as paid?')) {
        const invoice = invoices.find(inv => inv.id === currentInvoiceId);
        const index = invoices.findIndex(inv => inv.id === currentInvoiceId);
        
        invoices[index].status = 'paid';
        invoices[index].paidDate = new Date().toISOString();
        
        const payment = {
            id: Date.now(),
            invoiceId: invoice.id,
            clientId: invoice.clientId,
            clientName: invoice.clientName,
            amount: invoice.total,
            date: new Date().toISOString(),
            method: 'Payment'
        };
        
        payments.unshift(payment);
        
        localStorage.setItem('invoices', JSON.stringify(invoices));
        localStorage.setItem('payments', JSON.stringify(payments));
        
        logAudit('update', 'Invoice', `Marked invoice #${invoice.id} as paid - ${invoice.total.toFixed(2)}`);
        
        closeViewInvoiceModal();
        renderBilling();
        alert('Invoice marked as paid!');
    }
}

function deleteInvoice() {
    if (confirm('Are you sure you want to delete this invoice?')) {
        const invoice = invoices.find(inv => inv.id === currentInvoiceId);
        invoices = invoices.filter(inv => inv.id !== currentInvoiceId);
        localStorage.setItem('invoices', JSON.stringify(invoices));
        
        logAudit('delete', 'Invoice', `Deleted invoice #${invoice.id} for ${invoice.clientName}`);
        
        closeViewInvoiceModal();
        renderBilling();
    }
}

// Audit Log Functions
function renderAuditLog() {
    filterAuditLogs();
}

function filterAuditLogs() {
    const searchTerm = document.getElementById('auditSearch').value.toLowerCase();
    const actionFilter = document.getElementById('auditActionFilter').value;
    
    let filtered = auditLog;
    
    if (searchTerm) {
        filtered = filtered.filter(entry => 
            entry.user.toLowerCase().includes(searchTerm) ||
            entry.resource.toLowerCase().includes(searchTerm) ||
            entry.details.toLowerCase().includes(searchTerm)
        );
    }
    
    if (actionFilter) {
        filtered = filtered.filter(entry => entry.action === actionFilter);
    }
    
    const container = document.getElementById('auditLogList');
    
    if (filtered.length === 0) {
        container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No audit entries found</p>';
        return;
    }
    
    container.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>User</th>
                    <th>Action</th>
                    <th>Resource</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                ${filtered.map(entry => `
                    <tr>
                        <td style="font-size: 12px;">${new Date(entry.timestamp).toLocaleString()}</td>
                        <td>${entry.user}</td>
                        <td><span class="badge badge-${getActionBadgeColor(entry.action)}">${entry.action}</span></td>
                        <td>${entry.resource}</td>
                        <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${entry.details}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

function getActionBadgeColor(action) {
    const colors = {
        'create': 'success',
        'view': 'info',
        'update': 'warning',
        'delete': 'danger',
        'login': 'info',
        'logout': 'info'
    };
    return colors[action] || 'info';
}

// Document Functions
function renderDocumentTemplates() {
    const container = document.getElementById('documentTemplatesList');
    
    container.innerHTML = `
        <div class="grid">
            ${documentTemplates.map(template => `
                <div class="card" style="margin: 0;">
                    <h4 style="margin-bottom: 10px; color: #1f2937;">${template.name}</h4>
                    <p style="color: #6b7280; font-size: 14px;">${template.description}</p>
                </div>
            `).join('')}
        </div>
    `;
}

function openAssignModal() {
    const clientSelect = document.getElementById('assignClientSelect');
    clientSelect.innerHTML = '<option value="">Choose a client...</option>' + 
        allClients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    
    selectedDocs.clear();
    const list = document.getElementById('documentCheckboxList');
    list.innerHTML = '';
    
    documentTemplates.forEach(template => {
        const card = document.createElement('div');
        card.style.cssText = 'padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer;';
        card.innerHTML = `
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" value="${template.id}" style="margin-right: 10px;" onchange="toggleDocSelection(${template.id})">
                <div>
                    <div style="font-weight: 500; color: #1f2937;">${template.name}</div>
                    <div style="font-size: 12px; color: #6b7280;">${template.description}</div>
                </div>
            </label>
        `;
        card.onclick = (e) => {
            if (e.target.tagName !== 'INPUT') {
                const checkbox = card.querySelector('input');
                checkbox.checked = !checkbox.checked;
                toggleDocSelection(template.id);
            }
        };
        
        list.appendChild(card);
    });
    
    document.getElementById('assignModal').classList.add('active');
}

function toggleDocSelection(docId) {
    if (selectedDocs.has(docId)) {
        selectedDocs.delete(docId);
    } else {
        selectedDocs.add(docId);
    }
}

function closeAssignModal() {
    document.getElementById('assignModal').classList.remove('active');
    selectedDocs.clear();
}

function assignDocuments() {
    const clientId = parseInt(document.getElementById('assignClientSelect').value);
    
    if (!clientId) {
        alert('Please select a client');
        return;
    }
    
    if (selectedDocs.size === 0) {
        alert('Please select at least one document');
        return;
    }
    
    const client = allClients.find(c => c.id === clientId);
    selectedDocs.forEach(docId => {
        assignedDocs.push({
            id: Date.now() + Math.random(),
            clientId,
            clientName: client.name,
            docId,
            docName: documentTemplates.find(d => d.id === docId).name,
            assignedDate: new Date().toISOString(),
            status: 'pending'
        });
    });
    
    localStorage.setItem('assignedDocs', JSON.stringify(assignedDocs));
    
    logAudit('create', 'Document Assignment', `Assigned ${selectedDocs.size} document(s) to ${client.name}`);
    
    renderAssignedDocs();
    closeAssignModal();
    updateDashboard();
    alert(`${selectedDocs.size} document(s) assigned to ${client.name}`);
}

function renderAssignedDocs() {
    const container = document.getElementById('assignedDocsList');
    
    if (assignedDocs.length === 0) {
        container.innerHTML = '<p style="color: #6b7280;">No documents assigned yet</p>';
        return;
    }
    
    container.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>Client</th>
                    <th>Document</th>
                    <th>Status</th>
                    <th>Reviewed</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                ${assignedDocs.map(doc => `
                    <tr>
                        <td>${doc.clientName}</td>
                        <td>${doc.docName}</td>
                        <td><span class="badge badge-${doc.status === 'completed' ? 'success' : 'warning'}">${doc.status}</span></td>
                        <td>${doc.clinicianSignature ? '<span class="badge badge-success">Yes</span>' : '<span class="badge badge-warning">No</span>'}</td>
                        <td>
                            ${doc.status === 'completed' ? `<button class="btn" style="padding: 6px 12px; font-size: 12px;" onclick="viewCompletedDocument(${doc.id})">${doc.clinicianSignature ? 'View' : 'Review & Sign'}</button>` : '-'}
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

// Client Portal
function showClientDocuments() {
    const clientDocs = assignedDocs.filter(doc => 
        doc.clientId === parseInt(localStorage.getItem('userId'))
    );
    
    const container = document.getElementById('clientDocumentsContainer');
    
    if (clientDocs.length === 0) {
        container.innerHTML = '<div class="card"><p style="color: #6b7280;">No documents assigned</p></div>';
        return;
    }
    
    container.innerHTML = clientDocs.map(doc => `
        <div class="card" style="margin-bottom: 15px;">
            <h3 style="margin-bottom: 10px; color: #1f2937;">${doc.docName}</h3>
            <p style="color: #6b7280; margin-bottom: 15px;">Assigned: ${new Date(doc.assignedDate).toLocaleDateString()}</p>
            <span class="badge badge-${doc.status === 'completed' ? 'success' : 'warning'}" style="margin-bottom: 15px; display: inline-block;">${doc.status}</span>
            ${doc.status === 'pending' ? `
                <br><button class="btn btn-primary" onclick="openDocumentForm(${doc.id}, ${doc.docId})">Complete Document</button>
            ` : `
                <br><button class="btn" onclick="viewCompletedDocument(${doc.id})">View Completed</button>
            `}
        </div>
    `).join('');
}

function openDocumentForm(assignedDocId, templateId) {
    const template = documentTemplates.find(t => t.id === templateId);
    const modal = document.getElementById('documentFormModal');
    
    document.getElementById('documentFormTitle').textContent = template.name;
    
    const fieldsHtml = template.fields.map(field => {
        if (field.type === 'info') {
            return `
                <div style="margin-bottom: 20px; padding: 15px; background: #EFF6FF; border-left: 4px solid #667eea; border-radius: 8px;">
                    <p style="color: #374151; line-height: 1.6;">${field.label}</p>
                </div>
            `;
        }
        
        if (field.type === 'text') {
            return `
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">${field.label}</label>
                    <input type="text" id="field_${field.id}" class="input" required>
                </div>
            `;
        }
        
        if (field.type === 'textarea') {
            return `
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">${field.label}</label>
                    <textarea id="field_${field.id}" class="input" rows="4" required></textarea>
                </div>
            `;
        }
        
        if (field.type === 'checkbox') {
            return `
                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="field_${field.id}" required style="margin-right: 8px;">
                        <span style="color: #374151;">${field.label}</span>
                    </label>
                </div>
            `;
        }
        
        if (field.type === 'radio') {
            return `
                <div style="margin-bottom: 20px; padding: 15px; background: #f9fafb; border-radius: 8px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 500; color: #374151;">${field.label}</label>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        ${field.options.map(option => `
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="field_${field.id}" value="${option}" required style="margin-right: 8px;">
                                <span style="color: #374151;">${option}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        if (field.type === 'date') {
            return `
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">${field.label}</label>
                    <input type="date" id="field_${field.id}" class="input" required>
                </div>
            `;
        }
    }).join('');
    
    document.getElementById('documentFormFields').innerHTML = fieldsHtml;
    document.getElementById('documentFormSubmit').onclick = () => submitDocument(assignedDocId, template);
    
    modal.classList.add('active');
    
    setTimeout(() => {
        signatureTime = null;
        initSignatureCanvas();
        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        document.getElementById('signatureTimestamp').textContent = '';
    }, 100);
}

function closeDocumentForm() {
    document.getElementById('documentFormModal').classList.remove('active');
}

function initSignatureCanvas() {
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    
    canvas.addEventListener('mousedown', (e) => {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        lastX = e.clientX - rect.left;
        lastY = e.clientY - rect.top;
        
        if (!signatureTime) {
            signatureTime = new Date();
            document.getElementById('signatureTimestamp').textContent = 
                'Signed: ' + signatureTime.toLocaleString();
        }
    });
    
    canvas.addEventListener('mousemove', (e) => {
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        lastX = x;
        lastY = y;
    });
    
    canvas.addEventListener('mouseup', () => {
        isDrawing = false;
    });
    
    canvas.addEventListener('mouseleave', () => {
        isDrawing = false;
    });
    
    // Touch support
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        lastX = touch.clientX - rect.left;
        lastY = touch.clientY - rect.top;
        
        if (!signatureTime) {
            signatureTime = new Date();
            document.getElementById('signatureTimestamp').textContent = 
                'Signed: ' + signatureTime.toLocaleString();
        }
    });
    
    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        lastX = x;
        lastY = y;
    });
    
    canvas.addEventListener('touchend', () => {
        isDrawing = false;
    });
}

function clearSignature() {
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    signatureTime = null;
    document.getElementById('signatureTimestamp').textContent = '';
}

function submitDocument(assignedDocId, template) {
    const formData = {};
    let isValid = true;
    let missingFields = [];
    
    template.fields.forEach(field => {
        if (field.type === 'info') return;
        
        if (field.type === 'radio') {
            const selected = document.querySelector(`input[name="field_${field.id}"]:checked`);
            if (selected) {
                formData[field.id] = selected.value;
            } else {
                isValid = false;
                missingFields.push(field.label);
            }
        } else if (field.type === 'checkbox') {
            const element = document.getElementById(`field_${field.id}`);
            formData[field.id] = element.checked;
            if (!element.checked) {
                isValid = false;
                missingFields.push(field.label);
            }
        } else if (field.type === 'date') {
            const element = document.getElementById(`field_${field.id}`);
            formData[field.id] = element.value;
            if (!element.value) {
                isValid = false;
                missingFields.push(field.label);
            }
        } else if (field.type === 'text') {
            const element = document.getElementById(`field_${field.id}`);
            formData[field.id] = element.value;
            if (!element.value || element.value.trim() === '') {
                isValid = false;
                missingFields.push(field.label);
            }
        } else if (field.type === 'textarea') {
            const element = document.getElementById(`field_${field.id}`);
            formData[field.id] = element.value;
            if (!element.value || element.value.trim() === '') {
                isValid = false;
                missingFields.push(field.label);
            }
        }
    });
    
    if (!isValid) {
        alert('Please complete all required fields:\n\n' + missingFields.slice(0, 5).join('\n') + (missingFields.length > 5 ? '\n... and more' : ''));
        return;
    }
    
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const pixels = imageData.data;
    let hasSignature = false;
    
    for (let i = 0; i < pixels.length; i += 4) {
        if (pixels[i + 3] > 0) {
            hasSignature = true;
            break;
        }
    }
    
    if (!hasSignature) {
        alert('Please provide your signature');
        return;
    }
    
    const signatureData = canvas.toDataURL();
    
    const docIndex = assignedDocs.findIndex(d => d.id === assignedDocId);
    assignedDocs[docIndex].status = 'completed';
    assignedDocs[docIndex].completedDate = new Date().toISOString();
    assignedDocs[docIndex].signatureDate = signatureTime ? signatureTime.toISOString() : new Date().toISOString();
    assignedDocs[docIndex].formData = formData;
    assignedDocs[docIndex].signature = signatureData;
    
    localStorage.setItem('assignedDocs', JSON.stringify(assignedDocs));
    
    closeDocumentForm();
    showClientDocuments();
    alert('Document submitted successfully!');
}

function viewCompletedDocument(assignedDocId) {
    currentViewingDocId = assignedDocId;
    const doc = assignedDocs.find(d => d.id === assignedDocId);
    const template = documentTemplates.find(t => t.id === doc.docId);
    
    const modal = document.getElementById('viewDocModal');
    document.getElementById('viewDocTitle').textContent = template.name;
    
    const fieldsHtml = template.fields.map(field => {
        if (field.type === 'info') return '';
        
        const value = doc.formData[field.id];
        return `
            <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e5e7eb;">
                <strong style="display: block; margin-bottom: 5px; color: #374151;">${field.label}</strong>
                <p style="color: #6b7280;">${field.type === 'checkbox' ? (value ? 'Yes' : 'No') : value}</p>
            </div>
        `;
    }).join('');
    
    let clinicianSigHtml = '';
    if (doc.clinicianSignature) {
        clinicianSigHtml = `
            <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                <strong style="display: block; margin-bottom: 10px; color: #374151;">Clinician Review Signature:</strong>
                <img src="${doc.clinicianSignature}" style="border: 1px solid #e5e7eb; max-width: 100%;">
                <p style="color: #6b7280; font-size: 12px; margin-top: 5px;">Reviewed by: ${doc.clinicianName || 'Clinician'}</p>
                ${doc.clinicianSignatureDate ? `<p style="color: #6b7280; font-size: 12px;">Signed: ${new Date(doc.clinicianSignatureDate).toLocaleString()}</p>` : ''}
            </div>
        `;
    }
    
    document.getElementById('viewDocContent').innerHTML = `
        ${fieldsHtml}
        <div style="margin-top: 30px;">
            <strong style="display: block; margin-bottom: 10px; color: #374151;">Client Signature:</strong>
            <img src="${doc.signature}" style="border: 1px solid #e5e7eb; max-width: 100%;">
            ${doc.signatureDate ? `<p style="color: #6b7280; font-size: 12px; margin-top: 5px;">Signed: ${new Date(doc.signatureDate).toLocaleString()}</p>` : ''}
        </div>
        ${clinicianSigHtml}
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
            <p style="color: #6b7280; font-size: 14px;">Completed: ${new Date(doc.completedDate).toLocaleString()}</p>
        </div>
    `;
    
    // Show clinician signature section if provider and not yet signed
    const clinicianSection = document.getElementById('clinicianSignatureSection');
    if (userRole === 'provider' && !doc.clinicianSignature) {
        clinicianSection.style.display = 'block';
        setTimeout(() => {
            clinicianSignatureTime = null;
            initClinicianSignatureCanvas();
            const canvas = document.getElementById('clinicianSignatureCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('clinicianSignatureTimestamp').textContent = '';
        }, 100);
    } else {
        clinicianSection.style.display = 'none';
    }
    
    modal.classList.add('active');
}

function closeViewDocModal() {
    document.getElementById('viewDocModal').classList.remove('active');
    currentViewingDocId = null;
}

function initClinicianSignatureCanvas() {
    const canvas = document.getElementById('clinicianSignatureCanvas');
    const ctx = canvas.getContext('2d');
    
    canvas.addEventListener('mousedown', (e) => {
        isClinicianDrawing = true;
        const rect = canvas.getBoundingClientRect();
        clinicianLastX = e.clientX - rect.left;
        clinicianLastY = e.clientY - rect.top;
        
        if (!clinicianSignatureTime) {
            clinicianSignatureTime = new Date();
            document.getElementById('clinicianSignatureTimestamp').textContent = 
                'Signed: ' + clinicianSignatureTime.toLocaleString();
        }
    });
    
    canvas.addEventListener('mousemove', (e) => {
        if (!isClinicianDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        ctx.beginPath();
        ctx.moveTo(clinicianLastX, clinicianLastY);
        ctx.lineTo(x, y);
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        clinicianLastX = x;
        clinicianLastY = y;
    });
    
    canvas.addEventListener('mouseup', () => {
        isClinicianDrawing = false;
    });
    
    canvas.addEventListener('mouseleave', () => {
        isClinicianDrawing = false;
    });
    
    // Touch support
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        isClinicianDrawing = true;
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        clinicianLastX = touch.clientX - rect.left;
        clinicianLastY = touch.clientY - rect.top;
        
        if (!clinicianSignatureTime) {
            clinicianSignatureTime = new Date();
            document.getElementById('clinicianSignatureTimestamp').textContent = 
                'Signed: ' + clinicianSignatureTime.toLocaleString();
        }
    });
    
    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (!isClinicianDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        
        ctx.beginPath();
        ctx.moveTo(clinicianLastX, clinicianLastY);
        ctx.lineTo(x, y);
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        clinicianLastX = x;
        clinicianLastY = y;
    });
    
    canvas.addEventListener('touchend', () => {
        isClinicianDrawing = false;
    });
}

function clearClinicianSignature() {
    const canvas = document.getElementById('clinicianSignatureCanvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    clinicianSignatureTime = null;
    document.getElementById('clinicianSignatureTimestamp').textContent = '';
}

function saveClinicianSignature() {
    const canvas = document.getElementById('clinicianSignatureCanvas');
    const ctx = canvas.getContext('2d');
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const pixels = imageData.data;
    let hasSignature = false;
    
    for (let i = 0; i < pixels.length; i += 4) {
        if (pixels[i + 3] > 0) {
            hasSignature = true;
            break;
        }
    }
    
    if (!hasSignature) {
        alert('Please provide your signature to acknowledge review');
        return;
    }
    
    const signatureData = canvas.toDataURL();
    
    const docIndex = assignedDocs.findIndex(d => d.id === currentViewingDocId);
    assignedDocs[docIndex].clinicianSignature = signatureData;
    assignedDocs[docIndex].clinicianSignatureDate = clinicianSignatureTime ? clinicianSignatureTime.toISOString() : new Date().toISOString();
    assignedDocs[docIndex].clinicianName = localStorage.getItem('userName');
    assignedDocs[docIndex].clinicianReviewedAt = new Date().toISOString();
    
    localStorage.setItem('assignedDocs', JSON.stringify(assignedDocs));
    
    alert('Review signature saved successfully!');
    closeViewDocModal();
    
    if (document.getElementById('documentsContent').style.display === 'block') {
        renderAssignedDocs();
    }
}

// Initialize
if (authToken) {
    showApp();
} else {
    showAuth();
}
</script>

</body>
</html>
