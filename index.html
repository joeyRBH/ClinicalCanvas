<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClinicalCanvas EHR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            width: 100%;
            max-width: 400px;
        }

        .login-box h1 {
            color: #667eea;
            margin-bottom: 30px;
            text-align: center;
            font-size: 28px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 500;
        }

        .input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn:not(.btn-primary):not(.btn-danger):not(.btn-success) {
            background: #f3f4f6;
            color: #374151;
        }

        .btn:not(.btn-primary):not(.btn-danger):not(.btn-success):hover {
            background: #e5e7eb;
        }

        .app-container {
            display: none;
            min-height: 100vh;
            background: #f9fafb;
        }

        .header {
            background: white;
            padding: 20px 40px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .content {
            padding: 40px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e5e7eb;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            color: #667eea;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            text-align: left;
            padding: 12px;
            background: #f9fafb;
            color: #374151;
            font-weight: 600;
            border-bottom: 2px solid #e5e7eb;
        }

        .table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            color: #6b7280;
        }

        .table tr:hover {
            background: #f9fafb;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .stat-card .value {
            color: #1f2937;
            font-size: 32px;
            font-weight: 700;
        }

        .recording-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #fee2e2;
            border-radius: 8px;
            color: #991b1b;
            font-weight: 500;
        }

        .recording-dot {
            width: 8px;
            height: 8px;
            background: #dc2626;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .note-card {
            border-left: 4px solid #667eea;
            padding-left: 16px;
        }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h1>üè• ClinicalCanvas EHR</h1>
            <form id="loginForm" onsubmit="login(event)">
                <div class="input-group">
                    <label>Username</label>
                    <input type="text" id="username" class="input" required>
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="password" class="input" required>
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>
            <p style="margin-top: 20px; text-align: center; color: #6b7280; font-size: 12px;">
                Demo: admin/admin123 or john.doe@email.com/password123
            </p>
        </div>
    </div>

    <!-- App Container -->
    <div id="appContainer" class="app-container">
        <div class="header">
            <h1>üè• ClinicalCanvas EHR</h1>
            <div class="user-info">
                <span id="userDisplay"></span>
                <button class="btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="content">
            <!-- Provider Tabs -->
            <div id="providerTabs" class="tabs" style="display: none;">
                <button class="tab-btn active" onclick="showTab('dashboard')">Dashboard</button>
                <button class="tab-btn" onclick="showTab('clients')">Clients</button>
                <button class="tab-btn" onclick="showTab('calendar')">Calendar</button>
                <button class="tab-btn" onclick="showTab('ainotes')">Clinical Notes</button>
                <button class="tab-btn" onclick="showTab('billing')">Billing</button>
                <button class="tab-btn" onclick="showTab('documents')">Documents</button>
                <button class="tab-btn" onclick="showTab('audit')">Audit Log</button>
            </div>

            <!-- Client Portal Tabs -->
            <div id="clientTabs" class="tabs" style="display: none;">
                <button class="tab-btn active" onclick="showClientTab('portal')">My Portal</button>
                <button class="tab-btn" onclick="showClientTab('appointments')">Appointments</button>
                <button class="tab-btn" onclick="showClientTab('documents')">Documents</button>
            </div>

            <!-- Dashboard -->
            <div id="dashboardContent" style="display: none;">
                <div class="grid">
                    <div class="stat-card">
                        <h3>Total Clients</h3>
                        <div class="value" id="totalClients">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Appointments Today</h3>
                        <div class="value" id="appointmentsToday">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Pending Documents</h3>
                        <div class="value" id="pendingDocs">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Clinical Notes</h3>
                        <div class="value" id="totalNotes">0</div>
                    </div>
                </div>
            </div>

            <!-- Clients -->
            <div id="clientsContent" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #1f2937;">Client Management</h2>
                    <button class="btn btn-primary" onclick="openAddClient()">Add Client</button>
                </div>
                <div class="card">
                    <div id="clientsList"></div>
                </div>
            </div>

            <!-- Client Chart Detail View -->
            <div id="clientChartContent" style="display: none;">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                    <button class="btn" onclick="backToClientsList()">‚Üê Back to Clients</button>
                    <h2 style="color: #1f2937; flex: 1;" id="clientChartName"></h2>
                    <button class="btn" onclick="editClientFromChart()">Edit Client</button>
                    <button class="btn btn-danger" onclick="deleteClientFromChart()">Delete Client</button>
                </div>

                <!-- Personal Information -->
                <div class="card" style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: #374151;">Personal Information</h3>
                    <div id="clientChartInfo" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;"></div>
                </div>

                <!-- Quick Stats -->
                <div class="grid" style="margin-bottom: 20px;">
                    <div class="stat-card">
                        <h3>Total Sessions</h3>
                        <div class="value" id="clientTotalSessions">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Clinical Notes</h3>
                        <div class="value" id="clientTotalNotes">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Billed</h3>
                        <div class="value" style="color: #10b981;" id="clientTotalBilled">$0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Outstanding</h3>
                        <div class="value" style="color: #f59e0b;" id="clientOutstanding">$0</div>
                    </div>
                </div>

                <!-- Appointments -->
                <div class="card" style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">Appointments</h3>
                    <div id="clientChartAppointments"></div>
                </div>

                <!-- Clinical Notes -->
                <div class="card" style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">Clinical Notes</h3>
                    <div id="clientChartNotes"></div>
                </div>

                <!-- Invoices -->
                <div class="card" style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">Invoices</h3>
                    <div id="clientChartInvoices"></div>
                </div>

                <!-- Documents -->
                <div class="card">
                    <h3 style="margin-bottom: 15px;">Assigned Documents</h3>
                    <div id="clientChartDocuments"></div>
                </div>
            </div>

            <!-- Calendar -->
            <div id="calendarContent" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #1f2937;">Calendar</h2>
                    <button class="btn btn-primary" onclick="openAddAppointment()">New Appointment</button>
                </div>
                <div class="card">
                    <div id="appointmentsList"></div>
                </div>
            </div>

            <!-- AI Notes -->
            <div id="ainotesContent" style="display: none;">
                <h2 style="color: #1f2937; margin-bottom: 20px;">Clinical Notes (DAP Format)</h2>
                
                <div class="card">
                    <h3 style="margin-bottom: 20px;">Create New Clinical Note</h3>
                    
                    <div class="input-group">
                        <label>Select Client</label>
                        <select id="noteClientSelect" class="input">
                            <option value="">Choose a client...</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Record Session Audio</label>
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                            <button id="recordBtn" class="btn btn-danger" onclick="toggleRecording()">
                                <span id="recordBtnText">üé§ Start Recording</span>
                            </button>
                            <div id="recordingStatus" style="display: none;" class="recording-indicator">
                                <div class="recording-dot"></div>
                                <span id="recordingTime">00:00</span>
                            </div>
                        </div>
                        <p style="color: #6b7280; font-size: 12px;">Record your session notes verbally, then AI will convert to DAP format</p>
                    </div>

                    <div class="input-group">
                        <label>Or Type Notes Manually</label>
                        <textarea id="manualNotes" class="input" rows="6" placeholder="Describe the session..."></textarea>
                    </div>

                    <button class="btn btn-primary" onclick="generateDAPNote()" id="generateBtn">
                        ‚ú® Generate DAP Note
                    </button>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Clinical Notes by Client</h3>
                        <select id="notesFilterClient" class="input" style="width: 250px;" onchange="renderAINotes()">
                            <option value="">All Clients</option>
                        </select>
                    </div>
                    <div id="recentNotesList"></div>
                </div>
            </div>

            <!-- Billing -->
            <div id="billingContent" style="display: none;">
                <h2 style="color: #1f2937; margin-bottom: 20px;">Billing & Invoicing</h2>
                
                <div class="grid" style="margin-bottom: 20px;">
                    <div class="stat-card">
                        <h3>Total Revenue</h3>
                        <div class="value" style="color: #10b981;" id="totalRevenue">$0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Outstanding</h3>
                        <div class="value" style="color: #f59e0b;" id="outstandingBalance">$0</div>
                    </div>
                    <div class="stat-card">
                        <h3>This Month</h3>
                        <div class="value" id="monthRevenue">$0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Auto-Generated</h3>
                        <div class="value" id="autoInvoiceCount">0</div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Payment Processor Integration</h3>
                        <button class="btn" onclick="openPaymentProcessorSettings()">‚öôÔ∏è Settings</button>
                    </div>
                    <div id="paymentProcessorStatus"></div>
                </div>

                <div class="card" style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Session Rates</h3>
                        <button class="btn" onclick="openSessionRatesSettings()">Edit Rates</button>
                    </div>
                    <div id="sessionRatesDisplay"></div>
                </div>

                <div class="card" style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Invoices</h3>
                        <button class="btn btn-primary" onclick="openCreateInvoice()">Create Invoice</button>
                    </div>
                    <div id="invoicesList"></div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 20px;">Payment History</h3>
                    <div id="paymentsList"></div>
                </div>
            </div>

            <!-- Documents -->
            <div id="documentsContent" style="display: none;">
                <h2 style="color: #1f2937; margin-bottom: 20px;">Clinical Documents</h2>
                
                <div class="card" style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">Document Templates</h3>
                    <div id="documentTemplatesList"></div>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Assigned Documents</h3>
                        <button class="btn btn-primary" onclick="openAssignModal()">Assign Documents</button>
                    </div>
                    <div id="assignedDocsList"></div>
                </div>
            </div>

            <!-- Audit Log -->
            <div id="auditContent" style="display: none;">
                <h2 style="color: #1f2937; margin-bottom: 20px;">HIPAA Audit Log</h2>
                
                <div class="card" style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="auditSearch" class="input" placeholder="Search audit logs..." style="flex: 1;" onkeyup="filterAuditLogs()">
                        <select id="auditActionFilter" class="input" style="width: 200px;" onchange="filterAuditLogs()">
                            <option value="">All Actions</option>
                            <option value="view">View</option>
                            <option value="create">Create</option>
                            <option value="update">Update</option>
                            <option value="delete">Delete</option>
                            <option value="login">Login</option>
                        </select>
                    </div>
                </div>

                <div class="card">
                    <div id="auditLogList"></div>
                </div>
            </div>

            <!-- Client Portal -->
            <div id="clientInfo" style="display: none;">
                <div class="card">
                    <h2 style="margin-bottom: 20px;">Welcome to Your Portal</h2>
                    <p style="color: #6b7280;">View your appointments and complete assigned documents using the tabs above.</p>
                </div>
            </div>

            <div id="clientAppointments" style="display: none;">
                <div class="card">
                    <h2 style="margin-bottom: 20px;">My Appointments</h2>
                    <div id="clientAppointmentsList"></div>
                </div>
            </div>

            <div id="clientPortalContent" style="display: none;">
                <div id="clientDocumentsContainer"></div>
            </div>
        </div>
    </div>

    <!-- Add Client Modal -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <h2 id="clientModalTitle" style="margin-bottom: 20px;">Add Client</h2>
            <form id="clientForm" onsubmit="saveClient(event)">
                <div class="input-group">
                    <label>Name</label>
                    <input type="text" id="clientName" class="input" required>
                </div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="clientEmail" class="input" required>
                </div>
                <div class="input-group">
                    <label>Phone</label>
                    <input type="tel" id="clientPhone" class="input" required>
                </div>
                <div class="input-group">
                    <label>Date of Birth</label>
                    <input type="date" id="clientDob" class="input" required>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeClientModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Appointment Modal -->
    <div id="appointmentModal" class="modal">
        <div class="modal-content">
            <h2 id="appointmentModalTitle" style="margin-bottom: 20px;">New Appointment</h2>
            <form id="appointmentForm" onsubmit="saveAppointment(event)">
                <div class="input-group">
                    <label>Client</label>
                    <select id="appointmentClient" class="input" required>
                        <option value="">Select a client...</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Date</label>
                    <input type="date" id="appointmentDate" class="input" required>
                </div>
                <div class="input-group">
                    <label>Time</label>
                    <input type="time" id="appointmentTime" class="input" required>
                </div>
                <div class="input-group">
                    <label>Duration (minutes)</label>
                    <input type="number" id="appointmentDuration" class="input" value="60" required>
                </div>
                <div class="input-group">
                    <label>Type</label>
                    <select id="appointmentType" class="input" required>
                        <option value="Initial Consultation">Initial Consultation</option>
                        <option value="Follow-up">Follow-up</option>
                        <option value="Therapy Session">Therapy Session</option>
                        <option value="Medication Management">Medication Management</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Notes</label>
                    <textarea id="appointmentNotes" class="input" rows="3"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeAppointmentModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View SOAP Note Modal -->
    <div id="viewNoteModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <h2 style="margin-bottom: 20px;">Clinical Note (DAP Format)</h2>
            <div id="viewNoteContent"></div>
            <div style="display: flex; justify-content: flex-end; margin-top: 20px; gap: 10px;">
                <button class="btn btn-danger" onclick="deleteNote()">Delete Note</button>
                <button class="btn" onclick="closeViewNoteModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Create Invoice Modal -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <h2 style="margin-bottom: 20px;">Create Invoice</h2>
            <form id="invoiceForm" onsubmit="saveInvoice(event)">
                <div class="input-group">
                    <label>Client</label>
                    <select id="invoiceClient" class="input" required>
                        <option value="">Select a client...</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Invoice Date</label>
                    <input type="date" id="invoiceDate" class="input" required>
                </div>
                <div class="input-group">
                    <label>Due Date</label>
                    <input type="date" id="invoiceDueDate" class="input" required>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 500;">Line Items</label>
                    <div id="invoiceLineItems">
                        <div class="invoice-line-item" style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" class="input item-description" placeholder="Description" style="flex: 2;" required>
                            <input type="number" class="input item-quantity" placeholder="Qty" style="width: 80px;" value="1" min="1" required>
                            <input type="number" class="input item-rate" placeholder="Rate" style="width: 120px;" step="0.01" min="0" required>
                        </div>
                    </div>
                    <button type="button" class="btn" onclick="addInvoiceLineItem()">+ Add Line Item</button>
                </div>
                <div class="input-group">
                    <label>Notes</label>
                    <textarea id="invoiceNotes" class="input" rows="3"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeInvoiceModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Invoice</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Invoice Modal -->
    <div id="viewInvoiceModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <h2 style="margin-bottom: 20px;">Invoice Details</h2>
            <div id="viewInvoiceContent"></div>
            <div style="display: flex; justify-content: flex-end; margin-top: 20px; gap: 10px;">
                <button class="btn btn-danger" onclick="deleteInvoice()">Delete Invoice</button>
                <button class="btn btn-success" onclick="markInvoicePaid()" id="markPaidBtn">Mark as Paid</button>
                <button class="btn" onclick="closeViewInvoiceModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Assign Documents Modal -->
    <div id="assignModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <h2 style="margin-bottom: 20px;">Assign Documents</h2>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Select Client</label>
                <select id="assignClientSelect" class="input">
                    <option value="">Choose a client...</option>
                </select>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 500;">Select Documents</label>
                <div id="documentCheckboxList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px;">
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn" onclick="closeAssignModal()">Cancel</button>
                <button class="btn btn-primary" onclick="assignDocuments()">Assign Selected</button>
            </div>
        </div>
    </div>

    <!-- Document Form Modal (Client) -->
    <div id="documentFormModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <h2 id="documentFormTitle" style="margin-bottom: 20px;"></h2>
            
            <div id="documentFormFields" style="margin-bottom: 30px;"></div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 500; color: #374151;">Your Signature</label>
                <canvas id="signatureCanvas" width="600" height="200" style="border: 2px solid #e5e7eb; border-radius: 8px; cursor: crosshair; display: block; max-width: 100%;"></canvas>
                <button class="btn" onclick="clearSignature()" style="margin-top: 10px;">Clear Signature</button>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn" onclick="closeDocumentForm()">Cancel</button>
                <button id="documentFormSubmit" class="btn btn-primary">Submit Document</button>
            </div>
        </div>
    </div>

    <!-- View Completed Document Modal -->
    <div id="viewDocModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <h2 id="viewDocTitle" style="margin-bottom: 20px;"></h2>
            <div id="viewDocContent"></div>
            <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                <button class="btn" onclick="closeViewDocModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Clinical Note Prompt Modal -->
    <div id="clinicalNotePromptModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">üìù Session Completed</h2>
            <p style="color: #6b7280; margin-bottom: 20px;">The session with <strong id="promptClientName"></strong> has ended. Would you like to create a clinical note?</p>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn" onclick="closeClinicalNotePrompt()">Later</button>
                <button class="btn btn-primary" onclick="goToCreateNote()">Create Note Now</button>
            </div>
        </div>
    </div>

    <!-- Payment Processor Settings Modal -->
    <div id="paymentProcessorModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 style="margin-bottom: 20px;">Payment Processor Integration</h2>
            <form id="paymentProcessorForm" onsubmit="savePaymentProcessorSettings(event)">
                <div class="input-group">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="processorEnabled" style="margin-right: 8px;">
                        <span>Enable Payment Processor Integration</span>
                    </label>
                </div>
                <div class="input-group">
                    <label>API Key / Merchant ID</label>
                    <input type="text" id="processorApiKey" class="input" placeholder="Enter your API key or merchant ID">
                    <p style="color: #6b7280; font-size: 12px; margin-top: 5px;">Your payment processor credentials will be stored securely</p>
                </div>
                <div class="input-group">
                    <label>Webhook URL (Optional)</label>
                    <input type="text" id="processorWebhook" class="input" placeholder="https://your-payment-processor.com/webhook">
                    <p style="color: #6b7280; font-size: 12px; margin-top: 5px;">For receiving payment notifications</p>
                </div>
                <div class="input-group">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="processorTestMode" style="margin-right: 8px;">
                        <span>Test Mode</span>
                    </label>
                    <p style="color: #6b7280; font-size: 12px; margin-top: 5px;">Enable to use sandbox/test credentials</p>
                </div>
                <div style="padding: 15px; background: #fef3c7; border-radius: 8px; margin-bottom: 20px;">
                    <p style="color: #92400e; font-size: 14px;">üí° <strong>Integration Instructions:</strong></p>
                    <p style="color: #92400e; font-size: 12px; margin-top: 5px;">Once enabled, this system will be ready to send payment requests to your processor. You'll need to provide your processor's specific integration details.</p>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="closePaymentProcessorModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Settings</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Session Rates Modal -->
    <div id="sessionRatesModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">Session Rates</h2>
            <form id="sessionRatesForm" onsubmit="saveSessionRates(event)">
                <div class="input-group">
                    <label>Initial Consultation</label>
                    <input type="number" id="rateInitial" class="input" step="0.01" min="0" required>
                </div>
                <div class="input-group">
                    <label>Follow-up Session</label>
                    <input type="number" id="rateFollowup" class="input" step="0.01" min="0" required>
                </div>
                <div class="input-group">
                    <label>Therapy Session</label>
                    <input type="number" id="rateTherapy" class="input" step="0.01" min="0" required>
                </div>
                <div class="input-group">
                    <label>Medication Management</label>
                    <input type="number" id="rateMedication" class="input" step="0.01" min="0" required>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeSessionRatesModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Rates</button>
                </div>
            </form>
        </div>
    </div>

<script>
// Mock Database
let users = [
    { id: 1, username: 'admin', password: 'admin123', role: 'provider', name: 'Dr. Smith' },
    { id: 2, username: 'john.doe@email.com', password: 'password123', role: 'client', name: 'John Doe' }
];

let allClients = [
    { id: 1, name: 'John Doe', email: 'john.doe@email.com', phone: '555-0101', dob: '1990-05-15' },
    { id: 2, name: 'Jane Smith', email: 'jane.smith@email.com', phone: '555-0102', dob: '1985-08-22' }
];

let appointments = [
    { id: 1, clientId: 1, clientName: 'John Doe', date: '2025-10-10', time: '10:00', duration: 60, type: 'Initial Consultation', notes: 'First session', location: 'Office A', status: 'scheduled' },
    { id: 2, clientId: 2, clientName: 'Jane Smith', date: '2025-10-10', time: '14:00', duration: 60, type: 'Follow-up', notes: '', location: 'Office B', status: 'scheduled' }
];

let documentTemplates = [
    { 
        id: 1, 
        name: 'Client Intake Form',
        description: 'Initial client information and medical history',
        fields: [
            { id: 'fullName', label: 'Full Name', type: 'text' },
            { id: 'address', label: 'Address', type: 'textarea' },
            { id: 'emergencyContact', label: 'Emergency Contact', type: 'text' },
            { id: 'emergencyPhone', label: 'Emergency Contact Phone', type: 'text' },
            { id: 'medicalHistory', label: 'Medical History', type: 'textarea' },
            { id: 'currentMedications', label: 'Current Medications', type: 'textarea' }
        ]
    },
    { 
        id: 2, 
        name: 'Consent for Treatment',
        description: 'Authorization for treatment services',
        fields: [
            { id: 'clientName', label: 'Client Name', type: 'text' },
            { id: 'treatmentDate', label: 'Date', type: 'date' },
            { id: 'consentStatement', label: 'I consent to treatment', type: 'checkbox' },
            { id: 'privacyAcknowledgement', label: 'I acknowledge the privacy policy', type: 'checkbox' }
        ]
    },
    { 
        id: 3, 
        name: 'Release of Information',
        description: 'Authorization to share information',
        fields: [
            { id: 'clientName', label: 'Client Name', type: 'text' },
            { id: 'releaseToName', label: 'Release Information To', type: 'text' },
            { id: 'releaseToOrg', label: 'Organization', type: 'text' },
            { id: 'purposeOfRelease', label: 'Purpose of Release', type: 'textarea' },
            { id: 'expirationDate', label: 'Expiration Date', type: 'date' }
        ]
    },
    { 
        id: 4, 
        name: 'Treatment Plan',
        description: 'Collaborative treatment goals and objectives',
        fields: [
            { id: 'clientName', label: 'Client Name', type: 'text' },
            { id: 'diagnosisCode', label: 'Diagnosis Code', type: 'text' },
            { id: 'treatmentGoals', label: 'Treatment Goals', type: 'textarea' },
            { id: 'interventions', label: 'Planned Interventions', type: 'textarea' },
            { id: 'reviewDate', label: 'Next Review Date', type: 'date' }
        ]
    }
];

let assignedDocs = JSON.parse(localStorage.getItem('assignedDocs') || '[]');
let clinicalNotes = JSON.parse(localStorage.getItem('clinicalNotes') || '[]');
let auditLog = JSON.parse(localStorage.getItem('auditLog') || '[]');
let invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
let payments = JSON.parse(localStorage.getItem('payments') || '[]');
let paymentProcessorSettings = JSON.parse(localStorage.getItem('paymentProcessorSettings') || '{"enabled":false,"apiKey":"","webhookUrl":"","testMode":true}');
let sessionRates = JSON.parse(localStorage.getItem('sessionRates') || '{"Initial Consultation":150,"Follow-up":120,"Therapy Session":120,"Medication Management":100}');

let selectedDocs = new Set();
let authToken = localStorage.getItem('authToken');
let userRole = localStorage.getItem('userRole');
let currentUser = null;
let editingClientId = null;
let editingAppointmentId = null;
let currentNoteId = null;
let currentInvoiceId = null;
let currentClientChartId = null;
let pendingNoteForClient = null;

// Session completion checker - runs every minute
setInterval(checkCompletedSessions, 60000);

// Check on page load too
setTimeout(checkCompletedSessions, 5000);

// Audio recording variables
let mediaRecorder = null;
let audioChunks = [];
let recordingStartTime = null;
let recordingInterval = null;
let recordedAudioBlob = null;

// Audit logging function
function logAudit(action, resource, details = '') {
    const entry = {
        id: Date.now(),
        timestamp: new Date().toISOString(),
        user: localStorage.getItem('userName'),
        userId: localStorage.getItem('userId'),
        action,
        resource,
        details
    };
    auditLog.unshift(entry);
    localStorage.setItem('auditLog', JSON.stringify(auditLog));
}

// Auth Functions
function login(e) {
    e.preventDefault();
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    const user = users.find(u => u.username === username && u.password === password);
    
    if (user) {
        authToken = 'token_' + Date.now();
        userRole = user.role;
        currentUser = user;
        localStorage.setItem('authToken', authToken);
        localStorage.setItem('userRole', userRole);
        localStorage.setItem('userId', user.id);
        localStorage.setItem('userName', user.name);
        
        logAudit('login', 'System', `User logged in`);
        
        showApp();
    } else {
        alert('Invalid credentials');
    }
}

function logout() {
    logAudit('logout', 'System', `User logged out`);
    
    localStorage.removeItem('authToken');
    localStorage.removeItem('userRole');
    localStorage.removeItem('userId');
    localStorage.removeItem('userName');
    authToken = null;
    userRole = null;
    currentUser = null;
    showAuth();
}

function showAuth() {
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('appContainer').style.display = 'none';
}

function showApp() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appContainer').style.display = 'block';
    document.getElementById('userDisplay').textContent = localStorage.getItem('userName');
    
    if (userRole === 'provider') {
        document.getElementById('providerTabs').style.display = 'flex';
        document.getElementById('clientTabs').style.display = 'none';
        showTab('dashboard');
    } else {
        document.getElementById('providerTabs').style.display = 'none';
        document.getElementById('clientTabs').style.display = 'flex';
        showClientTab('portal');
    }
}

// Tab Functions
function showTab(tab) {
    document.querySelectorAll('#providerTabs .tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    document.getElementById('dashboardContent').style.display = 'none';
    document.getElementById('clientsContent').style.display = 'none';
    document.getElementById('clientChartContent').style.display = 'none';
    document.getElementById('calendarContent').style.display = 'none';
    document.getElementById('ainotesContent').style.display = 'none';
    document.getElementById('billingContent').style.display = 'none';
    document.getElementById('documentsContent').style.display = 'none';
    document.getElementById('auditContent').style.display = 'none';
    
    if (tab === 'dashboard') {
        document.getElementById('dashboardContent').style.display = 'block';
        updateDashboard();
    } else if (tab === 'clients') {
        document.getElementById('clientsContent').style.display = 'block';
        renderClients();
    } else if (tab === 'calendar') {
        document.getElementById('calendarContent').style.display = 'block';
        renderAppointments();
    } else if (tab === 'ainotes') {
        document.getElementById('ainotesContent').style.display = 'block';
        renderAINotes();
    } else if (tab === 'billing') {
        document.getElementById('billingContent').style.display = 'block';
        renderBilling();
    } else if (tab === 'documents') {
        document.getElementById('documentsContent').style.display = 'block';
        renderDocumentTemplates();
        renderAssignedDocs();
    } else if (tab === 'audit') {
        document.getElementById('auditContent').style.display = 'block';
        renderAuditLog();
    }
}

function showClientTab(tab) {
    document.querySelectorAll('#clientTabs .tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    document.getElementById('clientInfo').style.display = 'none';
    document.getElementById('clientAppointments').style.display = 'none';
    document.getElementById('clientPortalContent').style.display = 'none';
    
    if (tab === 'portal') {
        document.getElementById('clientInfo').style.display = 'block';
    } else if (tab === 'appointments') {
        document.getElementById('clientAppointments').style.display = 'block';
        loadClientAppointments();
    } else if (tab === 'documents') {
        document.getElementById('clientPortalContent').style.display = 'block';
        showClientDocuments();
    }
}

// Dashboard Functions
function updateDashboard() {
    document.getElementById('totalClients').textContent = allClients.length;
    
    const today = new Date().toISOString().split('T')[0];
    const todayAppts = appointments.filter(a => a.date === today).length;
    document.getElementById('appointmentsToday').textContent = todayAppts;
    
    const pending = assignedDocs.filter(d => d.status === 'pending').length;
    document.getElementById('pendingDocs').textContent = pending;
    
    document.getElementById('totalNotes').textContent = clinicalNotes.length;
}

// Client Management Functions
function renderClients() {
    const container = document.getElementById('clientsList');
    
    if (allClients.length === 0) {
        container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No clients yet</p>';
        return;
    }
    
    container.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>DOB</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                ${allClients.map(client => `
                    <tr>
                        <td><a href="#" onclick="viewClientChart(${client.id}); return false;" style="color: #667eea; text-decoration: none; font-weight: 500;">${client.name}</a></td>
                        <td>${client.email}</td>
                        <td>${client.phone}</td>
                        <td>${new Date(client.dob).toLocaleDateString()}</td>
                        <td>
                            <button class="btn" style="padding: 6px 12px; font-size: 12px; margin-right: 5px;" onclick="editClient(${client.id})">Edit</button>
                            <button class="btn" style="padding: 6px 12px; font-size: 12px;" onclick="deleteClient(${client.id})">Delete</button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    
    logAudit('view', 'Client List', `Viewed client list`);
}

function openAddClient() {
    editingClientId = null;
    document.getElementById('clientModalTitle').textContent = 'Add Client';
    document.getElementById('clientForm').reset();
    document.getElementById('clientModal').classList.add('active');
}

function editClient(id) {
    editingClientId = id;
    const client = allClients.find(c => c.id === id);
    
    logAudit('view', 'Client Record', `Viewed client: ${client.name}`);
    
    document.getElementById('clientModalTitle').textContent = 'Edit Client';
    document.getElementById('clientName').value = client.name;
    document.getElementById('clientEmail').value = client.email;
    document.getElementById('clientPhone').value = client.phone;
    document.getElementById('clientDob').value = client.dob;
    
    document.getElementById('clientModal').classList.add('active');
}

function closeClientModal() {
    document.getElementById('clientModal').classList.remove('active');
    editingClientId = null;
}

function saveClient(e) {
    e.preventDefault();
    
    const clientData = {
        name: document.getElementById('clientName').value,
        email: document.getElementById('clientEmail').value,
        phone: document.getElementById('clientPhone').value,
        dob: document.getElementById('clientDob').value
    };
    
    if (editingClientId) {
        const index = allClients.findIndex(c => c.id === editingClientId);
        allClients[index] = { ...allClients[index], ...clientData };
        logAudit('update', 'Client Record', `Updated client: ${clientData.name}`);
        
        // If we're viewing this client's chart, refresh it
        if (currentClientChartId === editingClientId) {
            closeClientModal();
            viewClientChart(editingClientId);
            return;
        }
    } else {
        clientData.id = Date.now();
        allClients.push(clientData);
        
        users.push({
            id: Date.now() + 1,
            username: clientData.email,
            password: 'password123',
            role: 'client',
            name: clientData.name
        });
        
        logAudit('create', 'Client Record', `Created new client: ${clientData.name}`);
    }
    
    closeClientModal();
    renderClients();
    updateDashboard();
}

function deleteClient(id) {
    if (confirm('Are you sure you want to delete this client?')) {
        const client = allClients.find(c => c.id === id);
        allClients = allClients.filter(c => c.id !== id);
        
        logAudit('delete', 'Client Record', `Deleted client: ${client.name}`);
        
        renderClients();
        updateDashboard();
    }
}

// Client Chart Functions
function viewClientChart(clientId) {
    currentClientChartId = clientId;
    const client = allClients.find(c => c.id === clientId);
    
    logAudit('view', 'Client Chart', `Viewed complete chart for ${client.name}`);
    
    // Hide clients list, show chart
    document.getElementById('clientsContent').style.display = 'none';
    document.getElementById('clientChartContent').style.display = 'block';
    
    // Set client name
    document.getElementById('clientChartName').textContent = client.name;
    
    // Render personal information
    document.getElementById('clientChartInfo').innerHTML = `
        <div>
            <strong style="color: #374151; display: block; margin-bottom: 5px;">Email</strong>
            <p style="color: #6b7280;">${client.email}</p>
        </div>
        <div>
            <strong style="color: #374151; display: block; margin-bottom: 5px;">Phone</strong>
            <p style="color: #6b7280;">${client.phone}</p>
        </div>
        <div>
            <strong style="color: #374151; display: block; margin-bottom: 5px;">Date of Birth</strong>
            <p style="color: #6b7280;">${new Date(client.dob).toLocaleDateString()}</p>
        </div>
        <div>
            <strong style="color: #374151; display: block; margin-bottom: 5px;">Age</strong>
            <p style="color: #6b7280;">${calculateAge(client.dob)} years</p>
        </div>
    `;
    
    // Calculate stats
    const clientAppointments = appointments.filter(a => a.clientId === clientId);
    const clientNotes = clinicalNotes.filter(n => n.clientId === clientId);
    const clientInvoices = invoices.filter(inv => inv.clientId === clientId);
    const totalBilled = clientInvoices.reduce((sum, inv) => sum + inv.total, 0);
    const outstanding = clientInvoices.reduce((sum, inv) => sum + (inv.status === 'unpaid' ? inv.total : 0), 0);
    
    document.getElementById('clientTotalSessions').textContent = clientAppointments.length;
    document.getElementById('clientTotalNotes').textContent = clientNotes.length;
    document.getElementById('clientTotalBilled').textContent = `${totalBilled.toFixed(2)}`;
    document.getElementById('clientOutstanding').textContent = `${outstanding.toFixed(2)}`;
    
    // Render appointments
    const appointmentsContainer = document.getElementById('clientChartAppointments');
    if (clientAppointments.length === 0) {
        appointmentsContainer.innerHTML = '<p style="color: #6b7280;">No appointments scheduled</p>';
    } else {
        appointmentsContainer.innerHTML = `
            <table class="table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Type</th>
                        <th>Duration</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    ${clientAppointments.map(apt => `
                        <tr>
                            <td>${new Date(apt.date).toLocaleDateString()}</td>
                            <td>${apt.time}</td>
                            <td><span class="badge badge-info">${apt.type}</span></td>
                            <td>${apt.duration} min</td>
                            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${apt.notes || '-'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }
    
    // Render clinical notes
    const notesContainer = document.getElementById('clientChartNotes');
    if (clientNotes.length === 0) {
        notesContainer.innerHTML = '<p style="color: #6b7280;">No clinical notes</p>';
    } else {
        notesContainer.innerHTML = clientNotes.map(note => `
            <div class="card note-card" style="margin-bottom: 15px; cursor: pointer;" onclick="viewNote(${note.id})">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                    <div>
                        <p style="color: #6b7280; font-size: 12px;">${new Date(note.createdAt).toLocaleString()}</p>
                    </div>
                    <span class="badge badge-info">${note.type || 'Session Note'}</span>
                </div>
                <p style="color: #6b7280; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    ${note.dap.data.substring(0, 100)}...
                </p>
            </div>
        `).join('');
    }
    
    // Render invoices
    const invoicesContainer = document.getElementById('clientChartInvoices');
    if (clientInvoices.length === 0) {
        invoicesContainer.innerHTML = '<p style="color: #6b7280;">No invoices</p>';
    } else {
        invoicesContainer.innerHTML = `
            <table class="table">
                <thead>
                    <tr>
                        <th>Invoice #</th>
                        <th>Date</th>
                        <th>Due Date</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${clientInvoices.map(inv => `
                        <tr>
                            <td>#${inv.id}</td>
                            <td>${new Date(inv.date).toLocaleDateString()}</td>
                            <td>${new Date(inv.dueDate).toLocaleDateString()}</td>
                            <td>${inv.total.toFixed(2)}</td>
                            <td><span class="badge badge-${inv.status === 'paid' ? 'success' : 'warning'}">${inv.status}</span></td>
                            <td>
                                <button class="btn" style="padding: 6px 12px; font-size: 12px;" onclick="viewInvoice(${inv.id})">View</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }
    
    // Render documents
    const clientDocs = assignedDocs.filter(doc => doc.clientId === clientId);
    const documentsContainer = document.getElementById('clientChartDocuments');
    if (clientDocs.length === 0) {
        documentsContainer.innerHTML = '<p style="color: #6b7280;">No documents assigned</p>';
    } else {
        documentsContainer.innerHTML = `
            <table class="table">
                <thead>
                    <tr>
                        <th>Document</th>
                        <th>Assigned Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${clientDocs.map(doc => `
                        <tr>
                            <td>${doc.docName}</td>
                            <td>${new Date(doc.assignedDate).toLocaleDateString()}</td>
                            <td><span class="badge badge-${doc.status === 'completed' ? 'success' : 'warning'}">${doc.status}</span></td>
                            <td>
                                ${doc.status === 'completed' ? `<button class="btn" style="padding: 6px 12px; font-size: 12px;" onclick="viewCompletedDocument(${doc.id})">View</button>` : '-'}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }
}

function calculateAge(dob) {
    const today = new Date();
    const birthDate = new Date(dob);
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    return age;
}

function backToClientsList() {
    document.getElementById('clientChartContent').style.display = 'none';
    document.getElementById('clientsContent').style.display = 'block';
    currentClientChartId = null;
}

function editClientFromChart() {
    editClient(currentClientChartId);
}

function deleteClientFromChart() {
    if (confirm('Are you sure you want to delete this client? All associated data will remain but will not be accessible through this client record.')) {
        const client = allClients.find(c => c.id === currentClientChartId);
        allClients = allClients.filter(c => c.id !== currentClientChartId);
        
        logAudit('delete', 'Client Record', `Deleted client: ${client.name}`);
        
        backToClientsList();
        renderClients();
        updateDashboard();
    }
}

// Calendar Functions
function renderAppointments() {
    const container = document.getElementById('appointmentsList');
    
    if (appointments.length === 0) {
        container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No appointments scheduled</p>';
        return;
    }
    
    container.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>Client</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Type</th>
                    <th>Duration</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                ${appointments.map(apt => `
                    <tr>
                        <td>${apt.clientName}</td>
                        <td>${new Date(apt.date).toLocaleDateString()}</td>
                        <td>${apt.time}</td>
                        <td><span class="badge badge-info">${apt.type}</span></td>
                        <td>${apt.duration} min</td>
                        <td>
                            <button class="btn" style="padding: 6px 12px; font-size: 12px; margin-right: 5px;" onclick="editAppointment(${apt.id})">Edit</button>
                            <button class="btn" style="padding: 6px 12px; font-size: 12px;" onclick="deleteAppointment(${apt.id})">Delete</button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    
    logAudit('view', 'Appointment List', `Viewed appointment calendar`);
}

function openAddAppointment() {
    editingAppointmentId = null;
    document.getElementById('appointmentModalTitle').textContent = 'New Appointment';
    document.getElementById('appointmentForm').reset();
    
    const clientSelect = document.getElementById('appointmentClient');
    clientSelect.innerHTML = '<option value="">Select a client...</option>' + 
        allClients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    
    document.getElementById('appointmentModal').classList.add('active');
}

function editAppointment(id) {
    editingAppointmentId = id;
    const apt = appointments.find(a => a.id === id);
    
    logAudit('view', 'Appointment', `Viewed appointment for ${apt.clientName}`);
    
    document.getElementById('appointmentModalTitle').textContent = 'Edit Appointment';
    
    const clientSelect = document.getElementById('appointmentClient');
    clientSelect.innerHTML = '<option value="">Select a client...</option>' + 
        allClients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    
    document.getElementById('appointmentClient').value = apt.clientId;
    document.getElementById('appointmentDate').value = apt.date;
    document.getElementById('appointmentTime').value = apt.time;
    document.getElementById('appointmentDuration').value = apt.duration;
    document.getElementById('appointmentType').value = apt.type;
    document.getElementById('appointmentNotes').value = apt.notes || '';
    
    document.getElementById('appointmentModal').classList.add('active');
}

function closeAppointmentModal() {
    document.getElementById('appointmentModal').classList.remove('active');
    editingAppointmentId = null;
}

function saveAppointment(e) {
    e.preventDefault();
    
    const clientId = parseInt(document.getElementById('appointmentClient').value);
    const client = allClients.find(c => c.id === clientId);
    
    const aptData = {
        clientId,
        clientName: client.name,
        date: document.getElementById('appointmentDate').value,
        time: document.getElementById('appointmentTime').value,
        duration: parseInt(document.getElementById('appointmentDuration').value),
        type: document.getElementById('appointmentType').value,
        notes: document.getElementById('appointmentNotes').value,
        location: 'Office A',
        status: 'scheduled'
    };
    
    if (editingAppointmentId) {
        const index = appointments.findIndex(a => a.id === editingAppointmentId);
        appointments[index] = { ...appointments[index], ...aptData };
        logAudit('update', 'Appointment', `Updated appointment for ${client.name}`);
    } else {
        aptData.id = Date.now();
        appointments.push(aptData);
        logAudit('create', 'Appointment', `Created appointment for ${client.name}`);
    }
    
    closeAppointmentModal();
    renderAppointments();
    updateDashboard();
}

function deleteAppointment(id) {
    if (confirm('Are you sure you want to delete this appointment?')) {
        const apt = appointments.find(a => a.id === id);
        appointments = appointments.filter(a => a.id !== id);
        
        logAudit('delete', 'Appointment', `Deleted appointment for ${apt.clientName}`);
        
        renderAppointments();
        updateDashboard();
    }
}

function loadClientAppointments() {
    const userId = parseInt(localStorage.getItem('userId'));
    const userAppts = appointments.filter(a => a.clientId === userId);
    
    const container = document.getElementById('clientAppointmentsList');
    
    if (userAppts.length === 0) {
        container.innerHTML = '<p style="color: #6b7280;">No appointments scheduled</p>';
        return;
    }
    
    container.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Type</th>
                    <th>Duration</th>
                </tr>
            </thead>
            <tbody>
                ${userAppts.map(apt => `
                    <tr>
                        <td>${new Date(apt.date).toLocaleDateString()}</td>
                        <td>${apt.time}</td>
                        <td><span class="badge badge-info">${apt.type}</span></td>
                        <td>${apt.duration} min</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

// AI Notes Functions
function renderAINotes() {
    // Populate client select
    const clientSelect = document.getElementById('noteClientSelect');
    clientSelect.innerHTML = '<option value="">Choose a client...</option>' + 
        allClients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    
    // Populate filter select
    const filterSelect = document.getElementById('notesFilterClient');
    filterSelect.innerHTML = '<option value="">All Clients</option>' + 
        allClients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    
    // Filter notes
    const filterClientId = filterSelect.value;
    let filteredNotes = clinicalNotes;
    if (filterClientId) {
        filteredNotes = clinicalNotes.filter(n => n.clientId === parseInt(filterClientId));
    }
    
    // Render recent notes
    const container = document.getElementById('recentNotesList');
    
    if (filteredNotes.length === 0) {
        container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No clinical notes yet</p>';
        return;
    }
    
    container.innerHTML = filteredNotes.map(note => `
        <div class="card note-card" style="margin-bottom: 15px; cursor: pointer;" onclick="viewNote(${note.id})">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                <div>
                    <h4 style="color: #1f2937; margin-bottom: 5px;">${note.clientName}</h4>
                    <p style="color: #6b7280; font-size: 12px;">${new Date(note.createdAt).toLocaleString()}</p>
                </div>
                <span class="badge badge-info">${note.type || 'Session Note'}</span>
            </div>
            <p style="color: #6b7280; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                ${note.dap.data.substring(0, 100)}...
            </p>
        </div>
    `).join('');
}

async function toggleRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        // Stop recording
        mediaRecorder.stop();
    } else {
        // Start recording
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };
            
            mediaRecorder.onstop = () => {
                recordedAudioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                stream.getTracks().forEach(track => track.stop());
                updateRecordingUI(false);
            };
            
            mediaRecorder.start();
            recordingStartTime = Date.now();
            updateRecordingUI(true);
            startRecordingTimer();
            
        } catch (error) {
            alert('Could not access microphone. Please check permissions.');
            console.error('Recording error:', error);
        }
    }
}

function updateRecordingUI(isRecording) {
    const recordBtn = document.getElementById('recordBtn');
    const recordStatus = document.getElementById('recordingStatus');
    const recordBtnText = document.getElementById('recordBtnText');
    
    if (isRecording) {
        recordBtn.classList.remove('btn-danger');
        recordBtn.classList.add('btn-success');
        recordBtnText.textContent = '‚èπÔ∏è Stop Recording';
        recordStatus.style.display = 'flex';
    } else {
        recordBtn.classList.remove('btn-success');
        recordBtn.classList.add('btn-danger');
        recordBtnText.textContent = 'üé§ Start Recording';
        recordStatus.style.display = 'none';
        if (recordingInterval) {
            clearInterval(recordingInterval);
        }
    }
}

function startRecordingTimer() {
    recordingInterval = setInterval(() => {
        const elapsed = Date.now() - recordingStartTime;
        const minutes = Math.floor(elapsed / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        document.getElementById('recordingTime').textContent = 
            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }, 1000);
}

async function generateDAPNote() {
    const clientId = parseInt(document.getElementById('noteClientSelect').value);
    const manualNotes = document.getElementById('manualNotes').value.trim();
    
    if (!clientId) {
        alert('Please select a client');
        return;
    }
    
    if (!recordedAudioBlob && !manualNotes) {
        alert('Please record audio or type manual notes');
        return;
    }
    
    const generateBtn = document.getElementById('generateBtn');
    generateBtn.disabled = true;
    generateBtn.textContent = '‚è≥ Processing...';
    
    try {
        let sessionNotes = manualNotes;
        
        // If we have audio, transcribe it first
        if (recordedAudioBlob && !manualNotes) {
            sessionNotes = await transcribeAudio(recordedAudioBlob);
        }
        
        // Generate DAP note using Claude API
        const dapNote = await generateDAPFromNotes(sessionNotes);
        
        // Save the note
        const client = allClients.find(c => c.id === clientId);
        const note = {
            id: Date.now(),
            clientId,
            clientName: client.name,
            createdAt: new Date().toISOString(),
            rawNotes: sessionNotes,
            dap: dapNote,
            type: 'Session Note'
        };
        
        clinicalNotes.unshift(note);
        localStorage.setItem('clinicalNotes', JSON.stringify(clinicalNotes));
        
        logAudit('create', 'Clinical Note', `Created DAP note for ${client.name}`);
        
        // Clear form
        document.getElementById('noteClientSelect').value = '';
        document.getElementById('manualNotes').value = '';
        recordedAudioBlob = null;
        
        // Refresh notes list
        renderAINotes();
        updateDashboard();
        
        // Show the note
        viewNote(note.id);
        
        alert('DAP note generated successfully!');
        
    } catch (error) {
        console.error('Error generating note:', error);
        alert('Error generating DAP note. Please try again.');
    } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = '‚ú® Generate DAP Note';
    }
}

async function transcribeAudio(audioBlob) {
    // Simulated transcription - in production, you'd use a speech-to-text API
    return "Patient presented for follow-up session. Discussed recent stressors at work and family relationships. Patient reports improved sleep but continuing anxiety symptoms. We reviewed coping strategies and practiced breathing exercises. Patient engaged well in session.";
}

async function generateDAPFromNotes(notes) {
    try {
        const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                model: "claude-sonnet-4-20250514",
                max_tokens: 2000,
                messages: [
                    { 
                        role: "user", 
                        content: `You are a clinical documentation assistant. Convert the following session notes into a structured DAP (Data, Assessment, Plan) format for a clinical record.

Session Notes:
${notes}

DAP Format:
- Data: Observable facts, client statements, and relevant session information
- Assessment: Clinical impressions, interpretations, and professional judgment
- Plan: Treatment goals, interventions, and next steps

CRITICAL: Respond ONLY with valid JSON in this exact format. DO NOT include any markdown, backticks, or explanatory text:

{
  "data": "Observable behaviors, client statements, and factual information from the session",
  "assessment": "Clinical impressions, diagnostic considerations, progress evaluation, and professional interpretation",
  "plan": "Treatment goals, planned interventions, homework, follow-up schedule, and next steps"
}

Remember: Output ONLY the JSON object, nothing else.`
                    }
                ]
            })
        });
        
        const data = await response.json();
        let responseText = data.content[0].text;
        
        // Strip any markdown formatting
        responseText = responseText.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
        
        const dapNote = JSON.parse(responseText);
        return dapNote;
        
    } catch (error) {
        console.error('Error calling Claude API:', error);
        // Fallback DAP note
        return {
            data: notes,
            assessment: "Client appeared engaged and cooperative during session. Continue monitoring progress.",
            plan: "Schedule follow-up session in one week. Continue current interventions and track progress on treatment goals."
        };
    }
}

function viewNote(noteId) {
    currentNoteId = noteId;
    const note = clinicalNotes.find(n => n.id === noteId);
    
    logAudit('view', 'Clinical Note', `Viewed DAP note for ${note.clientName}`);
    
    const modal = document.getElementById('viewNoteModal');
    document.getElementById('viewNoteContent').innerHTML = `
        <div style="margin-bottom: 20px;">
            <strong style="color: #374151;">Client:</strong>
            <p style="color: #6b7280; margin-top: 5px;">${note.clientName}</p>
        </div>
        
        <div style="margin-bottom: 20px;">
            <strong style="color: #374151;">Date:</strong>
            <p style="color: #6b7280; margin-top: 5px;">${new Date(note.createdAt).toLocaleString()}</p>
        </div>
        
        <div style="margin-bottom: 20px; padding: 15px; background: #f9fafb; border-radius: 8px;">
            <strong style="color: #374151; display: block; margin-bottom: 10px;">D - Data</strong>
            <p style="color: #6b7280; line-height: 1.6; white-space: pre-wrap;">${note.dap.data}</p>
        </div>
        
        <div style="margin-bottom: 20px; padding: 15px; background: #f9fafb; border-radius: 8px;">
            <strong style="color: #374151; display: block; margin-bottom: 10px;">A - Assessment</strong>
            <p style="color: #6b7280; line-height: 1.6; white-space: pre-wrap;">${note.dap.assessment}</p>
        </div>
        
        <div style="padding: 15px; background: #f9fafb; border-radius: 8px;">
            <strong style="color: #374151; display: block; margin-bottom: 10px;">P - Plan</strong>
            <p style="color: #6b7280; line-height: 1.6; white-space: pre-wrap;">${note.dap.plan}</p>
        </div>
    `;
    
    modal.classList.add('active');
}

function closeViewNoteModal() {
    document.getElementById('viewNoteModal').classList.remove('active');
    currentNoteId = null;
}

function deleteNote() {
    if (confirm('Are you sure you want to delete this clinical note?')) {
        const note = clinicalNotes.find(n => n.id === currentNoteId);
        clinicalNotes = clinicalNotes.filter(n => n.id !== currentNoteId);
        localStorage.setItem('clinicalNotes', JSON.stringify(clinicalNotes));
        
        logAudit('delete', 'Clinical Note', `Deleted note for ${note.clientName}`);
        
        closeViewNoteModal();
        renderAINotes();
        updateDashboard();
    }
}

// Billing Functions
function renderBilling() {
    // Calculate totals
    const totalRevenue = invoices.reduce((sum, inv) => sum + (inv.status === 'paid' ? inv.total : 0), 0);
    const outstanding = invoices.reduce((sum, inv) => sum + (inv.status === 'unpaid' ? inv.total : 0), 0);
    
    const now = new Date();
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    const monthRevenue = invoices.reduce((sum, inv) => {
        const invDate = new Date(inv.date);
        return sum + (inv.status === 'paid' && invDate >= monthStart ? inv.total : 0);
    }, 0);
    
    document.getElementById('totalRevenue').textContent = `${totalRevenue.toFixed(2)}`;
    document.getElementById('outstandingBalance').textContent = `${outstanding.toFixed(2)}`;
    document.getElementById('monthRevenue').textContent = `${monthRevenue.toFixed(2)}`;
    
    // Render invoices
    renderInvoicesList();
    renderPaymentsList();
}

function renderInvoicesList() {
    const container = document.getElementById('invoicesList');
    
    if (invoices.length === 0) {
        container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No invoices yet</p>';
        return;
    }
    
    container.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>Invoice #</th>
                    <th>Client</th>
                    <th>Date</th>
                    <th>Due Date</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                ${invoices.map(inv => `
                    <tr>
                        <td>#${inv.id}</td>
                        <td>${inv.clientName}</td>
                        <td>${new Date(inv.date).toLocaleDateString()}</td>
                        <td>${new Date(inv.dueDate).toLocaleDateString()}</td>
                        <td>${inv.total.toFixed(2)}</td>
                        <td><span class="badge badge-${inv.status === 'paid' ? 'success' : 'warning'}">${inv.status}</span></td>
                        <td>
                            <button class="btn" style="padding: 6px 12px; font-size: 12px;" onclick="viewInvoice(${inv.id})">View</button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

function renderPaymentsList() {
    const container = document.getElementById('paymentsList');
    
    if (payments.length === 0) {
        container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No payments yet</p>';
        return;
    }
    
    container.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Client</th>
                    <th>Invoice #</th>
                    <th>Amount</th>
                    <th>Method</th>
                </tr>
            </thead>
            <tbody>
                ${payments.map(payment => `
                    <tr>
                        <td>${new Date(payment.date).toLocaleDateString()}</td>
                        <td>${payment.clientName}</td>
                        <td>#${payment.invoiceId}</td>
                        <td>${payment.amount.toFixed(2)}</td>
                        <td><span class="badge badge-info">${payment.method || 'Payment'}</span></td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

function openCreateInvoice() {
    const clientSelect = document.getElementById('invoiceClient');
    clientSelect.innerHTML = '<option value="">Select a client...</option>' + 
        allClients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    
    // Set default dates
    const today = new Date().toISOString().split('T')[0];
    const dueDate = new Date();
    dueDate.setDate(dueDate.getDate() + 30);
    
    document.getElementById('invoiceDate').value = today;
    document.getElementById('invoiceDueDate').value = dueDate.toISOString().split('T')[0];
    
    // Reset line items
    document.getElementById('invoiceLineItems').innerHTML = `
        <div class="invoice-line-item" style="display: flex; gap: 10px; margin-bottom: 10px;">
            <input type="text" class="input item-description" placeholder="Description" style="flex: 2;" required>
            <input type="number" class="input item-quantity" placeholder="Qty" style="width: 80px;" value="1" min="1" required>
            <input type="number" class="input item-rate" placeholder="Rate" style="width: 120px;" step="0.01" min="0" required>
        </div>
    `;
    
    document.getElementById('invoiceNotes').value = '';
    document.getElementById('invoiceModal').classList.add('active');
}

function addInvoiceLineItem() {
    const container = document.getElementById('invoiceLineItems');
    const newItem = document.createElement('div');
    newItem.className = 'invoice-line-item';
    newItem.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px;';
    newItem.innerHTML = `
        <input type="text" class="input item-description" placeholder="Description" style="flex: 2;" required>
        <input type="number" class="input item-quantity" placeholder="Qty" style="width: 80px;" value="1" min="1" required>
        <input type="number" class="input item-rate" placeholder="Rate" style="width: 120px;" step="0.01" min="0" required>
        <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()" style="padding: 6px 12px;">‚úï</button>
    `;
    container.appendChild(newItem);
}

function closeInvoiceModal() {
    document.getElementById('invoiceModal').classList.remove('active');
}

function saveInvoice(e) {
    e.preventDefault();
    
    const clientId = parseInt(document.getElementById('invoiceClient').value);
    const client = allClients.find(c => c.id === clientId);
    
    // Collect line items
    const lineItems = Array.from(document.querySelectorAll('.invoice-line-item')).map(item => {
        const description = item.querySelector('.item-description').value;
        const quantity = parseInt(item.querySelector('.item-quantity').value);
        const rate = parseFloat(item.querySelector('.item-rate').value);
        return {
            description,
            quantity,
            rate,
            amount: quantity * rate
        };
    });
    
    const total = lineItems.reduce((sum, item) => sum + item.amount, 0);
    
    const invoice = {
        id: Date.now(),
        clientId,
        clientName: client.name,
        date: document.getElementById('invoiceDate').value,
        dueDate: document.getElementById('invoiceDueDate').value,
        lineItems,
        total,
        status: 'unpaid',
        notes: document.getElementById('invoiceNotes').value
    };
    
    invoices.unshift(invoice);
    localStorage.setItem('invoices', JSON.stringify(invoices));
    
    logAudit('create', 'Invoice', `Created invoice for ${client.name} - ${total.toFixed(2)}`);
    
    closeInvoiceModal();
    renderBilling();
    alert('Invoice created successfully!');
}

function viewInvoice(invoiceId) {
    currentInvoiceId = invoiceId;
    const invoice = invoices.find(inv => inv.id === invoiceId);
    
    logAudit('view', 'Invoice', `Viewed invoice #${invoice.id} for ${invoice.clientName}`);
    
    const modal = document.getElementById('viewInvoiceModal');
    
    // Update mark paid button visibility
    const markPaidBtn = document.getElementById('markPaidBtn');
    if (invoice.status === 'paid') {
        markPaidBtn.style.display = 'none';
    } else {
        markPaidBtn.style.display = 'inline-block';
    }
    
    document.getElementById('viewInvoiceContent').innerHTML = `
        <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
            <div>
                <h3 style="color: #1f2937; margin-bottom: 10px;">Invoice #${invoice.id}</h3>
                <p style="color: #6b7280;">Client: ${invoice.clientName}</p>
            </div>
            <div style="text-align: right;">
                <span class="badge badge-${invoice.status === 'paid' ? 'success' : 'warning'}" style="font-size: 14px; padding: 8px 16px;">${invoice.status.toUpperCase()}</span>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
            <div>
                <strong style="color: #374151; display: block; margin-bottom: 5px;">Invoice Date</strong>
                <p style="color: #6b7280;">${new Date(invoice.date).toLocaleDateString()}</p>
            </div>
            <div>
                <strong style="color: #374151; display: block; margin-bottom: 5px;">Due Date</strong>
                <p style="color: #6b7280;">${new Date(invoice.dueDate).toLocaleDateString()}</p>
            </div>
        </div>
        
        <table class="table" style="margin-bottom: 20px;">
            <thead>
                <tr>
                    <th>Description</th>
                    <th>Qty</th>
                    <th>Rate</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody>
                ${invoice.lineItems.map(item => `
                    <tr>
                        <td>${item.description}</td>
                        <td>${item.quantity}</td>
                        <td>${item.rate.toFixed(2)}</td>
                        <td>${item.amount.toFixed(2)}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        
        <div style="text-align: right; padding: 20px; background: #f9fafb; border-radius: 8px;">
            <h3 style="color: #1f2937;">Total: ${invoice.total.toFixed(2)}</h3>
        </div>
        
        ${invoice.notes ? `
            <div style="margin-top: 20px; padding: 15px; background: #f9fafb; border-radius: 8px;">
                <strong style="color: #374151; display: block; margin-bottom: 5px;">Notes</strong>
                <p style="color: #6b7280;">${invoice.notes}</p>
            </div>
        ` : ''}
    `;
    
    modal.classList.add('active');
}

function closeViewInvoiceModal() {
    document.getElementById('viewInvoiceModal').classList.remove('active');
    currentInvoiceId = null;
}

function markInvoicePaid() {
    if (confirm('Mark this invoice as paid?')) {
        const invoice = invoices.find(inv => inv.id === currentInvoiceId);
        const index = invoices.findIndex(inv => inv.id === currentInvoiceId);
        
        invoices[index].status = 'paid';
        invoices[index].paidDate = new Date().toISOString();
        
        // Create payment record
        const payment = {
            id: Date.now(),
            invoiceId: invoice.id,
            clientId: invoice.clientId,
            clientName: invoice.clientName,
            amount: invoice.total,
            date: new Date().toISOString(),
            method: 'Payment'
        };
        
        payments.unshift(payment);
        
        localStorage.setItem('invoices', JSON.stringify(invoices));
        localStorage.setItem('payments', JSON.stringify(payments));
        
        logAudit('update', 'Invoice', `Marked invoice #${invoice.id} as paid - ${invoice.total.toFixed(2)}`);
        
        closeViewInvoiceModal();
        renderBilling();
        alert('Invoice marked as paid!');
    }
}

function deleteInvoice() {
    if (confirm('Are you sure you want to delete this invoice?')) {
        const invoice = invoices.find(inv => inv.id === currentInvoiceId);
        invoices = invoices.filter(inv => inv.id !== currentInvoiceId);
        localStorage.setItem('invoices', JSON.stringify(invoices));
        
        logAudit('delete', 'Invoice', `Deleted invoice #${invoice.id} for ${invoice.clientName}`);
        
        closeViewInvoiceModal();
        renderBilling();
    }
}

// Audit Log Functions
function renderAuditLog() {
    filterAuditLogs();
}

function filterAuditLogs() {
    const searchTerm = document.getElementById('auditSearch').value.toLowerCase();
    const actionFilter = document.getElementById('auditActionFilter').value;
    
    let filtered = auditLog;
    
    if (searchTerm) {
        filtered = filtered.filter(entry => 
            entry.user.toLowerCase().includes(searchTerm) ||
            entry.resource.toLowerCase().includes(searchTerm) ||
            entry.details.toLowerCase().includes(searchTerm)
        );
    }
    
    if (actionFilter) {
        filtered = filtered.filter(entry => entry.action === actionFilter);
    }
    
    const container = document.getElementById('auditLogList');
    
    if (filtered.length === 0) {
        container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No audit entries found</p>';
        return;
    }
    
    container.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>User</th>
                    <th>Action</th>
                    <th>Resource</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                ${filtered.map(entry => `
                    <tr>
                        <td style="font-size: 12px;">${new Date(entry.timestamp).toLocaleString()}</td>
                        <td>${entry.user}</td>
                        <td><span class="badge badge-${getActionBadgeColor(entry.action)}">${entry.action}</span></td>
                        <td>${entry.resource}</td>
                        <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${entry.details}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

function getActionBadgeColor(action) {
    const colors = {
        'create': 'success',
        'view': 'info',
        'update': 'warning',
        'delete': 'danger',
        'login': 'info',
        'logout': 'info'
    };
    return colors[action] || 'info';
}

// Document Functions
function renderDocumentTemplates() {
    const container = document.getElementById('documentTemplatesList');
    
    container.innerHTML = `
        <div class="grid">
            ${documentTemplates.map(template => `
                <div class="card" style="margin: 0;">
                    <h4 style="margin-bottom: 10px; color: #1f2937;">${template.name}</h4>
                    <p style="color: #6b7280; font-size: 14px;">${template.description}</p>
                </div>
            `).join('')}
        </div>
    `;
}

function openAssignModal() {
    const clientSelect = document.getElementById('assignClientSelect');
    clientSelect.innerHTML = '<option value="">Choose a client...</option>' + 
        allClients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    
    selectedDocs.clear();
    const list = document.getElementById('documentCheckboxList');
    list.innerHTML = '';
    
    documentTemplates.forEach(template => {
        const card = document.createElement('div');
        card.style.cssText = 'padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer;';
        card.innerHTML = `
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" value="${template.id}" style="margin-right: 10px;" onchange="toggleDocSelection(${template.id})">
                <div>
                    <div style="font-weight: 500; color: #1f2937;">${template.name}</div>
                    <div style="font-size: 12px; color: #6b7280;">${template.description}</div>
                </div>
            </label>
        `;
        card.onclick = (e) => {
            if (e.target.tagName !== 'INPUT') {
                const checkbox = card.querySelector('input');
                checkbox.checked = !checkbox.checked;
                toggleDocSelection(template.id);
            }
        };
        
        list.appendChild(card);
    });
    
    document.getElementById('assignModal').classList.add('active');
}

function toggleDocSelection(docId) {
    if (selectedDocs.has(docId)) {
        selectedDocs.delete(docId);
    } else {
        selectedDocs.add(docId);
    }
}

function closeAssignModal() {
    document.getElementById('assignModal').classList.remove('active');
    selectedDocs.clear();
}

function assignDocuments() {
    const clientId = parseInt(document.getElementById('assignClientSelect').value);
    
    if (!clientId) {
        alert('Please select a client');
        return;
    }
    
    if (selectedDocs.size === 0) {
        alert('Please select at least one document');
        return;
    }
    
    const client = allClients.find(c => c.id === clientId);
    selectedDocs.forEach(docId => {
        assignedDocs.push({
            id: Date.now() + Math.random(),
            clientId,
            clientName: client.name,
            docId,
            docName: documentTemplates.find(d => d.id === docId).name,
            assignedDate: new Date().toISOString(),
            status: 'pending'
        });
    });
    
    localStorage.setItem('assignedDocs', JSON.stringify(assignedDocs));
    
    logAudit('create', 'Document Assignment', `Assigned ${selectedDocs.size} document(s) to ${client.name}`);
    
    renderAssignedDocs();
    closeAssignModal();
    updateDashboard();
    alert(`${selectedDocs.size} document(s) assigned to ${client.name}`);
}

function renderAssignedDocs() {
    const container = document.getElementById('assignedDocsList');
    
    if (assignedDocs.length === 0) {
        container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No documents assigned yet</p>';
        return;
    }
    
    container.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>Client</th>
                    <th>Document</th>
                    <th>Assigned Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                ${assignedDocs.map(doc => `
                    <tr>
                        <td>${doc.clientName}</td>
                        <td>${doc.docName}</td>
                        <td>${new Date(doc.assignedDate).toLocaleDateString()}</td>
                        <td><span class="badge badge-${doc.status === 'completed' ? 'success' : 'warning'}">${doc.status}</span></td>
                        <td>
                            ${doc.status === 'completed' ? `<button class="btn" style="padding: 6px 12px; font-size: 12px;" onclick="viewCompletedDocument(${doc.id})">View</button>` : '-'}
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

// Client portal document functions
function showClientDocuments() {
    const clientDocs = assignedDocs.filter(doc => 
        doc.clientId === parseInt(localStorage.getItem('userId'))
    );
    
    const container = document.getElementById('clientDocumentsContainer');
    
    if (clientDocs.length === 0) {
        container.innerHTML = '<div class="card"><p style="color: #6b7280; text-align: center; padding: 40px;">No documents assigned</p></div>';
        return;
    }
    
    container.innerHTML = clientDocs.map(doc => `
        <div class="card" style="margin-bottom: 15px;">
            <h3 style="margin-bottom: 10px; color: #1f2937;">${doc.docName}</h3>
            <p style="color: #6b7280; margin-bottom: 15px;">Assigned: ${new Date(doc.assignedDate).toLocaleDateString()}</p>
            <span class="badge badge-${doc.status === 'completed' ? 'success' : 'warning'}" style="margin-bottom: 15px; display: inline-block;">${doc.status}</span>
            ${doc.status === 'pending' ? `
                <br><button class="btn btn-primary" onclick="openDocumentForm(${doc.id}, ${doc.docId})">Complete Document</button>
            ` : `
                <br><button class="btn" onclick="viewCompletedDocument(${doc.id})">View Completed</button>
            `}
        </div>
    `).join('');
}

function openDocumentForm(assignedDocId, templateId) {
    const template = documentTemplates.find(t => t.id === templateId);
    const modal = document.getElementById('documentFormModal');
    
    document.getElementById('documentFormTitle').textContent = template.name;
    
    const fieldsHtml = template.fields.map(field => {
        if (field.type === 'text') {
            return `
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">${field.label}</label>
                    <input type="text" id="field_${field.id}" class="input" required>
                </div>
            `;
        } else if (field.type === 'textarea') {
            return `
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">${field.label}</label>
                    <textarea id="field_${field.id}" class="input" rows="4" required></textarea>
                </div>
            `;
        } else if (field.type === 'checkbox') {
            return `
                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="field_${field.id}" required style="margin-right: 8px;">
                        <span style="color: #374151;">${field.label}</span>
                    </label>
                </div>
            `;
        } else if (field.type === 'date') {
            return `
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">${field.label}</label>
                    <input type="date" id="field_${field.id}" class="input" required>
                </div>
            `;
        }
    }).join('');
    
    document.getElementById('documentFormFields').innerHTML = fieldsHtml;
    document.getElementById('documentFormSubmit').onclick = () => submitDocument(assignedDocId, template);
    
    // Clear signature canvas
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    modal.classList.add('active');
}

function closeDocumentForm() {
    document.getElementById('documentFormModal').classList.remove('active');
}

let isDrawing = false;
let lastX = 0;
let lastY = 0;

function initSignatureCanvas() {
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    
    canvas.addEventListener('mousedown', (e) => {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        lastX = e.clientX - rect.left;
        lastY = e.clientY - rect.top;
    });
    
    canvas.addEventListener('mousemove', (e) => {
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        lastX = x;
        lastY = y;
    });
    
    canvas.addEventListener('mouseup', () => {
        isDrawing = false;
    });
    
    canvas.addEventListener('mouseleave', () => {
        isDrawing = false;
    });
    
    // Touch support
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        lastX = touch.clientX - rect.left;
        lastY = touch.clientY - rect.top;
    });
    
    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        lastX = x;
        lastY = y;
    });
    
    canvas.addEventListener('touchend', () => {
        isDrawing = false;
    });
}

function clearSignature() {
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

function submitDocument(assignedDocId, template) {
    // Collect form data
    const formData = {};
    let isValid = true;
    
    template.fields.forEach(field => {
        const element = document.getElementById(`field_${field.id}`);
        if (field.type === 'checkbox') {
            formData[field.id] = element.checked;
            if (!element.checked) isValid = false;
        } else {
            formData[field.id] = element.value;
            if (!element.value) isValid = false;
        }
    });
    
    if (!isValid) {
        alert('Please complete all fields');
        return;
    }
    
    // Get signature
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const pixels = imageData.data;
    let hasSignature = false;
    
    for (let i = 0; i < pixels.length; i += 4) {
        if (pixels[i + 3] > 0) {
            hasSignature = true;
            break;
        }
    }
    
    if (!hasSignature) {
        alert('Please provide your signature');
        return;
    }
    
    const signatureData = canvas.toDataURL();
    
    // Update assigned doc
    const docIndex = assignedDocs.findIndex(d => d.id === assignedDocId);
    const doc = assignedDocs[docIndex];
    assignedDocs[docIndex].status = 'completed';
    assignedDocs[docIndex].completedDate = new Date().toISOString();
    assignedDocs[docIndex].formData = formData;
    assignedDocs[docIndex].signature = signatureData;
    
    localStorage.setItem('assignedDocs', JSON.stringify(assignedDocs));
    
    logAudit('update', 'Document', `Completed document: ${doc.docName}`);
    
    closeDocumentForm();
    showClientDocuments();
    alert('Document submitted successfully!');
}

function viewCompletedDocument(assignedDocId) {
    const doc = assignedDocs.find(d => d.id === assignedDocId);
    const template = documentTemplates.find(t => t.id === doc.docId);
    
    logAudit('view', 'Document', `Viewed completed document: ${doc.docName} for ${doc.clientName}`);
    
    const modal = document.getElementById('viewDocModal');
    document.getElementById('viewDocTitle').textContent = template.name;
    
    const fieldsHtml = template.fields.map(field => {
        const value = doc.formData[field.id];
        return `
            <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e5e7eb;">
                <strong style="display: block; margin-bottom: 5px; color: #374151;">${field.label}</strong>
                <p style="color: #6b7280;">${field.type === 'checkbox' ? (value ? 'Yes' : 'No') : value}</p>
            </div>
        `;
    }).join('');
    
    document.getElementById('viewDocContent').innerHTML = `
        ${fieldsHtml}
        <div style="margin-top: 30px;">
            <strong style="display: block; margin-bottom: 10px; color: #374151;">Signature:</strong>
            <img src="${doc.signature}" style="border: 1px solid #e5e7eb; max-width: 100%;">
        </div>
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
            <p style="color: #6b7280; font-size: 14px;">Completed: ${new Date(doc.completedDate).toLocaleString()}</p>
        </div>
    `;
    
    modal.classList.add('active');
}

function closeViewDocModal() {
    document.getElementById('viewDocModal').classList.remove('active');
}

// Session Completion & Auto-Invoice Functions
function checkCompletedSessions() {
    if (userRole !== 'provider') return;
    
    const now = new Date();
    
    appointments.forEach(apt => {
        if (apt.status === 'scheduled') {
            const aptDateTime = new Date(`${apt.date}T${apt.time}`);
            const aptEndTime = new Date(aptDateTime.getTime() + apt.duration * 60000);
            
            // If session has ended
            if (now >= aptEndTime) {
                completeSession(apt);
            }
        }
    });
}

function completeSession(appointment) {
    // Mark appointment as completed
    const aptIndex = appointments.findIndex(a => a.id === appointment.id);
    appointments[aptIndex].status = 'completed';
    
    // Auto-generate invoice
    const rate = sessionRates[appointment.type] || 120;
    const invoice = {
        id: Date.now(),
        clientId: appointment.clientId,
        clientName: appointment.clientName,
        date: new Date().toISOString().split('T')[0],
        dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
        lineItems: [{
            description: `${appointment.type} - ${new Date(appointment.date).toLocaleDateString()}`,
            quantity: 1,
            rate: rate,
            amount: rate
        }],
        total: rate,
        status: 'unpaid',
        notes: `Auto-generated from appointment on ${new Date(appointment.date).toLocaleDateString()}`,
        autoGenerated: true
    };
    
    invoices.unshift(invoice);
    localStorage.setItem('invoices', JSON.stringify(invoices));
    
    logAudit('create', 'Invoice', `Auto-generated invoice for ${appointment.clientName} - ${rate.toFixed(2)}`);
    
    // Prompt for clinical note
    promptClinicalNote(appointment);
    
    // Update UI if on relevant pages
    if (document.getElementById('billingContent').style.display === 'block') {
        renderBilling();
    }
}

function promptClinicalNote(appointment) {
    pendingNoteForClient = appointment.clientId;
    document.getElementById('promptClientName').textContent = appointment.clientName;
    document.getElementById('clinicalNotePromptModal').classList.add('active');
}

function closeClinicalNotePrompt() {
    document.getElementById('clinicalNotePromptModal').classList.remove('active');
    pendingNoteForClient = null;
}

function goToCreateNote() {
    closeClinicalNotePrompt();
    showTab('ainotes');
    
    // Pre-select the client
    if (pendingNoteForClient) {
        document.getElementById('noteClientSelect').value = pendingNoteForClient;
    }
    
    // Focus on manual notes textarea
    document.getElementById('manualNotes').focus();
}

// Payment Processor Functions
function openPaymentProcessorSettings() {
    document.getElementById('processorEnabled').checked = paymentProcessorSettings.enabled;
    document.getElementById('processorApiKey').value = paymentProcessorSettings.apiKey;
    document.getElementById('processorWebhook').value = paymentProcessorSettings.webhookUrl;
    document.getElementById('processorTestMode').checked = paymentProcessorSettings.testMode;
    
    document.getElementById('paymentProcessorModal').classList.add('active');
}

function closePaymentProcessorModal() {
    document.getElementById('paymentProcessorModal').classList.remove('active');
}

function savePaymentProcessorSettings(e) {
    e.preventDefault();
    
    paymentProcessorSettings = {
        enabled: document.getElementById('processorEnabled').checked,
        apiKey: document.getElementById('processorApiKey').value,
        webhookUrl: document.getElementById('processorWebhook').value,
        testMode: document.getElementById('processorTestMode').checked
    };
    
    localStorage.setItem('paymentProcessorSettings', JSON.stringify(paymentProcessorSettings));
    
    logAudit('update', 'Payment Settings', `Updated payment processor settings`);
    
    closePaymentProcessorModal();
    renderBilling();
    alert('Payment processor settings saved!');
}

function renderPaymentProcessorStatus() {
    const container = document.getElementById('paymentProcessorStatus');
    
    if (paymentProcessorSettings.enabled) {
        container.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <span class="badge badge-success">Active</span>
                ${paymentProcessorSettings.testMode ? '<span class="badge badge-warning">Test Mode</span>' : '<span class="badge badge-info">Live Mode</span>'}
                <span style="color: #6b7280; font-size: 14px;">Ready to process payments</span>
            </div>
        `;
    } else {
        container.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <span class="badge badge-warning">Not Configured</span>
                <span style="color: #6b7280; font-size: 14px;">Click Settings to integrate your payment processor</span>
            </div>
        `;
    }
}

// Session Rates Functions
function openSessionRatesSettings() {
    document.getElementById('rateInitial').value = sessionRates['Initial Consultation'];
    document.getElementById('rateFollowup').value = sessionRates['Follow-up'];
    document.getElementById('rateTherapy').value = sessionRates['Therapy Session'];
    document.getElementById('rateMedication').value = sessionRates['Medication Management'];
    
    document.getElementById('sessionRatesModal').classList.add('active');
}

function closeSessionRatesModal() {
    document.getElementById('sessionRatesModal').classList.remove('active');
}

function saveSessionRates(e) {
    e.preventDefault();
    
    sessionRates = {
        'Initial Consultation': parseFloat(document.getElementById('rateInitial').value),
        'Follow-up': parseFloat(document.getElementById('rateFollowup').value),
        'Therapy Session': parseFloat(document.getElementById('rateTherapy').value),
        'Medication Management': parseFloat(document.getElementById('rateMedication').value)
    };
    
    localStorage.setItem('sessionRates', JSON.stringify(sessionRates));
    
    logAudit('update', 'Session Rates', `Updated session billing rates`);
    
    closeSessionRatesModal();
    renderBilling();
    alert('Session rates updated!');
}

function renderSessionRates() {
    const container = document.getElementById('sessionRatesDisplay');
    
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
            ${Object.entries(sessionRates).map(([type, rate]) => `
                <div style="padding: 10px; background: #f9fafb; border-radius: 8px;">
                    <strong style="color: #374151; display: block; font-size: 14px;">${type}</strong>
                    <p style="color: #10b981; font-size: 18px; font-weight: 600; margin-top: 5px;">${rate.toFixed(2)}</p>
                </div>
            `).join('')}
        </div>
    `;
}

// Initialize
if (authToken) {
    showApp();
    if (userRole === 'client') {
        initSignatureCanvas();
    }
} else {
    showAuth();
}
</script>

</body>
</html>
